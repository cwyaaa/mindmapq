<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>æ€ç»´å¯¼å›¾ï¼ˆç½®é¡¶èŠ‚ç‚¹&å­èŠ‚ç‚¹ä¼˜å…ˆæ¨ªæ’ï¼‰</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-auth-compat.js"></script>
  <style>
#sidebar-mask {
  display:none;
  position:fixed; left:0; top:60px; width:100vw; height:calc(100vh - 60px);
  background:rgba(40,36,87,0.12); z-index:14;
}
#sidebar {
  position:fixed; top:60px; left:0;
  width:250px; height:calc(100vh - 60px);
  background:#fff; box-shadow: 2px 0 16px #b7aefa33; z-index:15;
  display:none; flex-direction:column; padding:15px 0 0 0; overflow-y:auto;
  transition: left .18s;
}
#sidebar h3 { font-size:15px; margin:0 0 7px 21px; color:#8066e1;}
.thumb-list { width:100%; display:flex; flex-direction:column; gap:13px; padding:0 12px 10px 12px;}
.thumb-item {
  background: #f8f8fd; border-radius:8px; box-shadow:0 1px 4px #ddd5fa33; padding:10px 8px 7px 8px;
  margin-bottom: 2px; cursor:pointer; border:1.5px solid transparent; transition:.15s;
  display:flex; flex-direction:column; align-items:center; font-size:12px;
}
.thumb-item.selected, .thumb-item:hover { border-color:#8066e1; background:#f1edfa;}
.thumb-title {
  font-size:12px; color:#8066e1; margin-bottom:4px; font-weight:bold;
  text-align:center; width: 100%; word-break:break-all;
}
.thumb-svg {
  background:#fff; border-radius:5px; margin-bottom:2px; box-shadow:0 1px 3px #ddd4ff22;
  width:130px; height:38px; display:block;
}
    body { margin:0; background:#f5f6fa; font-family: Arial,'å¾®è½¯é›…é»‘'; }
    #toolbar {
      width: 100vw; height: 60px; background: #8066e1; color: #fff; display: flex; align-items: center;
      box-sizing: border-box; padding: 0 32px; position:relative; z-index:2;
    }
    #toolbar .logo { font-size: 25px; font-weight: bold; border-radius: 50%; width:32px; height:32px; background:#fff; color:#8066e1; display:inline-flex; align-items:center; justify-content:center; margin-right:14px;}
    #toolbar .title { font-size: 21px; font-weight: bold; margin-right: 32px;}
    #toolbar .btn { margin-left:12px; background: #fff; color: #8066e1; border: none; border-radius: 8px; padding: 6px 19px; font-size: 15px; cursor:pointer; font-weight:500; transition:.2s; display:inline-flex; align-items:center;}
    #toolbar .btn:hover { background: #e9e4fc;}
    #toolbar .btn.add { background: #f5f6fa; color: #8066e1; border: 1.4px solid #8066e1;}
    #toolbar .btn.add:hover { background: #e9e4fc; }
    #toolbar .user-info { margin-left:auto; display:flex; align-items:center; gap:8px; font-size:14px;}
    #toolbar .avatar { width:26px; height:26px; border-radius:50%; background:#eee; object-fit:cover; }
    #color-bar {
      position: absolute;
      top: 60px; left: 50%;
      transform: translateX(-50%);
      z-index: 9;
      display: flex;
      gap: 12px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 10px #c7bbfa22;
      padding: 8px 20px 7px 20px;
      margin-top: 8px;
      align-items: center;
      min-width: 220px;
      transition: box-shadow .18s;
      user-select: none;
    }
    .color-bar-top-btn {
      width: 27px;
      height: 27px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid #e1e4fa;
      border-radius: 8px;
      background: #fff;
      color: #faad14;
      cursor: pointer;
      box-shadow: 0 1px 4px #c7bbfa11;
      margin-right: 7px;
      font-size: 18px;
      transition: border .18s, box-shadow .18s, color .13s;
    }
    .color-bar-top-btn.pinned {
      color: #8066e1;
      border: 2.7px solid #8066e1;
      background: #f8f7fd;
    }
    .color-option {
      width: 27px; height: 27px;
      border-radius: 8px;
      border: 2px solid #e1e4fa;
      cursor: pointer;
      box-shadow: 0 1px 4px #c7bbfa11;
      transition: border .18s, box-shadow .18s;
      display: flex; align-items: center; justify-content: center;
      position: relative;
    }
    .color-option.selected, .color-option:hover {
      border: 2.7px solid #8066e1;
      box-shadow: 0 2px 8px #b3a5ff33;
    }
    .color-option .tick {
      position: absolute;
      right: 2px; bottom: 2px;
      width: 13px; height: 13px;
      background: rgba(255,255,255,.8);
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 12px;
      color: #8066e1;
      font-weight: bold;
      pointer-events: none;
    }
    #mindmap-container { position:relative; width:100vw; height:calc(100vh - 60px); overflow:hidden; background: #f9f9fc; }
    #mindmap { width:100vw; height:calc(100vh - 60px); position:absolute; left:0; top:0; overflow:hidden; }
    .node {
      position:absolute; min-width:65px; min-height:28px; padding:4px 13px 4px 18px;
      background:#fff; border-radius:12px; color:#333; font-weight:400;
      user-select:none; cursor:pointer; box-shadow:0 2px 9px #c7bbfa33;
      font-size:15px; border:1.7px solid #bfbefc; transition:.2s;
      z-index: 2; display: flex; align-items: center; flex-direction: row; gap:0;
      white-space:nowrap;
    }
    .node.root { font-weight: bold;}
    .node input {
      font-size: 15px; font-family: inherit; border:none; border-radius: 8px; background:#fffde6; outline:2px solid #8066e1; color:#333;
      padding: 2px 8px; width: 100px; box-sizing:border-box;
    }
    .node .node-img {
      max-width: 60px; max-height: 60px; border-radius:4px; margin-left:6px; vertical-align: middle;
    }
    .node .node-icons {
      position: absolute;
      left: 100%; top: 50%; transform: translateY(-50%);
      display: flex; flex-direction: row; gap: 2px;
      opacity: 0; pointer-events: none; transition:.2s;
      z-index: 10;
    }
    .node:hover .node-icons,
    .node .node-icons:focus-within {
      opacity: 1; pointer-events: all;
    }
    .node .icon-btn {
      background: #fff; border:1px solid #e2d6fa; color:#8066e1;
      border-radius: 50%; width: 26px; height: 26px;
      display: flex; align-items: center; justify-content: center;
      font-size: 15px; cursor:pointer; margin-left:3px; box-shadow:0 1px 4px #c7bbfa22; transition:.18s;
      outline:none;
    }
    .node .icon-btn:hover { background: #f5f0fa; border-color: #bfbefc;}
    .node .icon-btn:active { background:#e8e0fd;}
    .node .icon-btn.edit { color:#388e3c;}
    .node .icon-btn.del { color:#b71c1c;}
    .node .icon-btn.img { color:#f4b400;}
    .node .icon-btn.add { color:#8066e1;}
    .line { position:absolute; z-index:1; pointer-events:none; }
    #img-upload { display:none; }
    .node.selected {
      border:2.3px solid #8066e1;
      box-shadow: 0 0 0 3px #ad9ffb44, 0 2px 9px #c7bbfa33;
    }
    .node.selected .select-outline {
      pointer-events: none;
      position: absolute;
      top: -7px; left: -7px; right: -7px; bottom: -7px;
      border: 2.5px solid #8066e1;
      border-radius: 16px;
      box-shadow: 0 0 10px 2px #c7bbfa33;
      z-index: 10;
      background: none;
      content: "";
    }
    .shortcutbar {
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: #fff;
      color: #333;
      font-size: 13px;
      border-radius: 9px;
      box-shadow: 0 1px 10px #c7bbfa22;
      padding: 7px 20px;
      opacity:.98;
      display:flex;
      gap:14px;
      z-index: 21;
      flex-wrap:wrap;
      align-items:center;
    }
    .shortcutbar kbd {
      background: #8066e1;
      color: #fff;
      border-radius: 3px;
      padding: 2px 7px;
      margin-right: 3px;
      font-family: monospace;
      font-size: 13px;
      font-weight: 500;
      box-shadow: 0 1px 2px #bdb1f622;
    }
    .mindmap-fab-wrap {
      position: fixed;
      right: 24px;
      bottom: 30px;
      z-index: 30;
      display: flex;
      flex-direction: column;
      gap: 14px;
      align-items: flex-end;
    }
    .mindmap-fab-btn {
      width: 45px; height: 45px;
      border-radius: 50%;
      background: #fff;
      color: #8066e1;
      border: 2.2px solid #ece6fd;
      box-shadow: 0 2px 10px #c7bbfa44;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 23px;
      cursor: pointer;
      transition: all .16s;
      outline: none;
      margin-bottom: 0;
      position: relative;
    }
    .mindmap-fab-btn:hover {
      background: #ede7fb;
      border-color: #8066e1;
      transform: scale(1.07) translateY(-2px);
      box-shadow: 0 5px 20px #b3a5ff33;
    }
    .mindmap-fab-btn svg {
      pointer-events: none;
      display: block;
    }
    .mindmap-fab-btn .fab-tooltip {
      display: none;
      position: absolute;
      right: 110%;
      top: 50%;
      transform: translateY(-50%);
      background: #fff;
      color: #8066e1;
      border-radius: 6px;
      font-size: 13px;
      padding: 2px 9px;
      box-shadow: 0 0 8px #c7bbfa22;
      white-space: nowrap;
    }
    .mindmap-fab-btn:hover .fab-tooltip {
      display: block;
    }
    #mindmap.dragging {
      cursor: grabbing !important;
    }
    #mindmap {
      cursor: grab;
    }
  </style>
</head>
<body>
  <div id="toolbar">
    <span class="logo">M</span>
    <span class="title">æ€ç»´å¯¼å›¾</span>
    <button class="btn add" id="btn-addroot" onclick="addRoot()">+ æ·»åŠ ä¸­å¿ƒä¸»é¢˜</button>
    <button class="btn" onclick="onNewMap()">âŸ³ æ–°å»º</button>
    <button class="btn" onclick="saveCloud()">â˜ï¸ çº¿ä¸Šä¿å­˜</button>
    <button class="btn" onclick="showSidebar()">ğŸ“ åŠ è½½</button>
    <div class="user-info" id="user-info">
      <button class="btn" id="login-btn" onclick="googleLogin()">Googleç™»å½•</button>
    </div>
  </div>
  <div id="color-bar"></div>
   <div id="mindmap-container">
  <div id="mindmap"></div>
  <input id="img-upload" type="file" accept="image/*">
  <!-- ä¾§è¾¹æ é®ç½©ï¼Œå¿…é¡»åœ¨ä¾§æ å‰ -->
  <div id="sidebar-mask"></div>
  <!-- å·¦ä¾§ä¾§è¾¹æ  -->
  <div id="sidebar">
     <h3>æˆ‘çš„çº¿ä¸Šå¯¼å›¾</h3>
      <div class="thumb-list" id="thumb-list"></div>
    </div>
    <div id="sidebar-mask"></div>
    <!-- å¯¹è¯æ¡†é®ç½©å’Œå†…å®¹ -->
  <div class="mindmap-fab-wrap">
    <button class="mindmap-fab-btn" onclick="zoomIn()" title="æ”¾å¤§">
      <svg width="25" height="25" viewBox="0 0 20 20"><circle cx="10" cy="10" r="9" fill="#fff" stroke="#8066e1" stroke-width="1.4"/><rect x="9" y="5" width="2" height="10" rx="1" fill="#8066e1"/><rect x="5" y="9" width="10" height="2" rx="1" fill="#8066e1"/></svg>
      <span class="fab-tooltip">æ”¾å¤§ (Ctrl + é¼ æ ‡æ»šè½® â†‘)</span>
    </button>
    <button class="mindmap-fab-btn" onclick="zoomOut()" title="ç¼©å°">
      <svg width="25" height="25" viewBox="0 0 20 20"><circle cx="10" cy="10" r="9" fill="#fff" stroke="#8066e1" stroke-width="1.4"/><rect x="5" y="9" width="10" height="2" rx="1" fill="#8066e1"/></svg>
      <span class="fab-tooltip">ç¼©å° (Ctrl + é¼ æ ‡æ»šè½® â†“)</span>
    </button>
    <button class="mindmap-fab-btn" onclick="zoomReset()" title="è¿˜åŸ">
      <svg width="25" height="25" viewBox="0 0 20 20"><circle cx="10" cy="10" r="9" fill="#fff" stroke="#8066e1" stroke-width="1.4"/><path d="M10 5v5l3 3" stroke="#8066e1" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round" fill="none"/><circle cx="10" cy="10" r="2.1" fill="none" stroke="#8066e1" stroke-width="1.1"/></svg>
      <span class="fab-tooltip">è¿˜åŸç¼©æ”¾</span>
    </button>
  </div>
  <div class="shortcutbar">
    <b>èŠ‚ç‚¹å¿«æ·é”®ï¼š</b>
    <kbd>Enter</kbd> æ·»åŠ å­èŠ‚ç‚¹
    <kbd>Space</kbd> ç¼–è¾‘èŠ‚ç‚¹
    <kbd>Backspace</kbd> åˆ é™¤èŠ‚ç‚¹
    <kbd>Esc</kbd> å…³é—­ä¾§æ /å¯¹è¯æ¡†
    <kbd>åŒå‡»èŠ‚ç‚¹</kbd> ç¼–è¾‘èŠ‚ç‚¹
    <kbd>ç‚¹å‡»èŠ‚ç‚¹</kbd> é€‰ä¸­èŠ‚ç‚¹
    <span style="margin-left:12px;color:#888">ï¼ˆè¯·å…ˆç‚¹å‡»é€‰ä¸­èŠ‚ç‚¹å†ç”¨å¿«æ·é”®ï¼‰</span>
    <span style="margin-left:12px;color:#8066e1;font-weight:500">æŒ‰ä½ç©ºç™½å¤„æ‹–åŠ¨ç”»å¸ƒ</span>
  </div>
  <script>
   // ==== Firebase é…ç½®ï¼ˆä½ çš„ firebaseConfig ä¿æŒä¸å˜ï¼‰ ====
const firebaseConfig = {
  apiKey: "AIzaSyCcsz9Lg3KmgvD_SXUdy4V5x7aCQtSdI-s",
  authDomain: "webs-d0804.firebaseapp.com",
  databaseURL: "https://webs-d0804-default-rtdb.firebaseio.com",
  projectId: "webs-d0804",
  storageBucket: "webs-d0804.firebasestorage.app",
  messagingSenderId: "195195304680",
  appId: "1:195195304680:web:01c68159689678c7f4275d",
  measurementId: "G-RRQ7RFHV76"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

let currentUser = null;

// Google ç™»å½•
function googleLogin() {
  const provider = new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider)
    .then(result => {
      currentUser = result.user;
      renderUser();
      loadSidebarIfVisible && loadSidebarIfVisible();
    }).catch(e => alert('ç™»å½•å¤±è´¥: ' + e.message));
}

function logout() {
  auth.signOut().then(() => {
    currentUser = null;
    renderUser();
    render && render();
  });
}

// ç”¨æˆ·ä¿¡æ¯ UI
function renderUser() {
  const userInfo = document.getElementById('user-info');
  if (auth.currentUser) {
    userInfo.innerHTML =
      `<img class="avatar" src="${auth.currentUser.photoURL || ''}" alt=""/>`
      + `<span>${auth.currentUser.displayName || ''}</span>`
      + `<button class="btn" onclick="logout()">é€€å‡º</button>`;
  } else {
    userInfo.innerHTML = `<button class="btn" id="login-btn" onclick="googleLogin()">Googleç™»å½•</button>`;
  }
}
auth.onAuthStateChanged(user => {
  currentUser = user;
  renderUser();
  render && render();
  loadSidebarIfVisible && loadSidebarIfVisible();
});

    // é¢œè‰²æ–¹æ¡ˆ
    const COLOR_LIST = [
      { bg: "#fff", color: "#333", line: "#bfbefc" },
      { bg: "#ffe08b", color: "#654200", line: "#f4c24d" },
      { bg: "#d2f6e9", color: "#21797a", line: "#25b399" },
      { bg: "#c8e8ff", color: "#004e77", line: "#43a6e2" },
      { bg: "#f7c7c9", color: "#a2383b", line: "#e46d72" },
      { bg: "#f3e0ff", color: "#6c3596", line: "#b78be5" },
      { bg: "#e8eaf6", color: "#23265e", line: "#8b91e2" },
      { bg: "#e8f5e9", color: "#1b5e20", line: "#6fcf97" },
      { bg: "#fffde6", color: "#8c6c13", line: "#ffe08b" }
    ];

    let nodes = [];
    let idCounter = 1;
    let selectedId = null;
    let editingNodeId = null;
    let scale = 1;
    let offsetX = 0, offsetY = 0;
    let draggingCanvas = false, dragStartX = 0, dragStartY = 0, dragOriX = 0, dragOriY = 0;

    // =============== ç½®é¡¶åŠŸèƒ½ç›¸å…³ ==================
    // pinnedNodes: { [nodeId]: {x, y, colorIdx} }
    let pinnedNodes = {};

    // æ¨ªå‘æ’å¸ƒå¹¶é¿å…é‡å çš„å¸ƒå±€é€»è¾‘, pinnedèŠ‚ç‚¹å›ºå®š
    function layoutHorizontal() {
      if (!nodes.length) return;
      const gapX = 160, gapY = 80;
      let root = nodes.find(n => n.id === 1);
      if (!root) return;
      root.x = 520; root.y = 220;
      function layoutChildren(parent, depth, baseY) {
        let children = nodes.filter(n => n.parent === parent.id);
        // ç½®é¡¶èŠ‚ç‚¹æ’åœ¨æœ€å‰
        children.sort((a, b) => {
          const aPinned = !!pinnedNodes[a.id];
          const bPinned = !!pinnedNodes[b.id];
          if(aPinned && !bPinned) return -1;
          if(!aPinned && bPinned) return 1;
          return a.id - b.id;
        });
        let startX = parent.x + gapX;
        let y = baseY, maxY = baseY;
        children.forEach((child, idx) => {
          if (pinnedNodes[child.id]) {
            // å›ºå®šä¸åŠ¨
            child.x = pinnedNodes[child.id].x;
            child.y = pinnedNodes[child.id].y;
            child.colorIdx = pinnedNodes[child.id].colorIdx;
          } else {
            child.x = startX;
            child.y = y;
          }
          // é¿å…é‡å ï¼ˆåä»£æ’å¸ƒé€’å½’ï¼‰
          y += gapY;
          maxY = Math.max(maxY, child.y);
          layoutChildren(child, depth + 1, child.y - Math.floor(gapY * (nodes.filter(n => n.parent === child.id).length-1) / 2));
        });
        return maxY;
      }
      layoutChildren(root, 1, root.y - (nodes.filter(n => n.parent === 1).length-1)/2*gapY);
    }

    // é¢œè‰²åŒæ­¥å¸¦ç½®é¡¶ä¿æŠ¤
    function setColorCascade(nodeId, colorIdx) {
      const n = nodes.find(n => n.id === nodeId);
      if (!n) return;
      // è‹¥è¢«ç½®é¡¶ä¿æŠ¤ï¼Œä¸å¯æ›´æ”¹
      if (pinnedNodes[nodeId]) return;
      n.colorIdx = colorIdx;
      nodes.forEach(child => {
        if (child.parent === nodeId) {
          setColorCascade(child.id, colorIdx);
        }
      });
    }

    // =============== é¢œè‰²é€‰æ‹©æ  & ç½®é¡¶æŒ‰é’® ==================
    function renderColorBar() {
      const colorBar = document.getElementById('color-bar');
      colorBar.innerHTML = '';
      let selectedNode = nodes.find(n => n.id === selectedId);
      let selColor = selectedNode && selectedNode.colorIdx !== undefined ? selectedNode.colorIdx : 0;
      // ç½®é¡¶æŒ‰é’®
      let pinBtn = document.createElement('button');
      pinBtn.className = 'color-bar-top-btn' + (pinnedNodes[selectedId] ? ' pinned' : '');
      pinBtn.innerHTML = pinnedNodes[selectedId]
        ? '<svg width="17" height="17" fill="none" viewBox="0 0 17 17"><path d="M8.5 2.5v10M8.5 2.5l-3 3M8.5 2.5l3 3" stroke="#8066e1" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>'
        : '<svg width="17" height="17" fill="none" viewBox="0 0 17 17"><path d="M8.5 2.5v10M8.5 2.5l-3 3M8.5 2.5l3 3" stroke="#faad14" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>';
      pinBtn.title = pinnedNodes[selectedId] ? 'å·²å›ºå®š' : 'å›ºå®šæ­¤èŠ‚ç‚¹çš„ä½ç½®å’Œé¢œè‰²';
      pinBtn.onclick = function() {
        if(!selectedNode) return;
        if(pinnedNodes[selectedId]) {
          // å–æ¶ˆç½®é¡¶
          delete pinnedNodes[selectedId];
        } else {
          // è®°å½•å½“å‰åæ ‡å’Œé¢œè‰²
          pinnedNodes[selectedId] = {
            x: selectedNode.x,
            y: selectedNode.y,
            colorIdx: selectedNode.colorIdx
          };
        }
        layoutHorizontal();
        render();
        renderColorBar();
      };
      colorBar.appendChild(pinBtn);

      // é¢œè‰²é€‰é¡¹
      COLOR_LIST.forEach((c, i) => {
        let btn = document.createElement('div');
        btn.className = 'color-option' + (selColor === i ? ' selected' : '');
        btn.style.background = c.bg;
        btn.style.color = c.color;
        btn.title = 'åº”ç”¨æ­¤é¢œè‰²';
        if(selColor === i) btn.innerHTML = '<span class="tick">âœ”</span>';
        btn.onclick = function() {
          if(selectedNode) {
            // è‹¥è¢«ç½®é¡¶ä¿æŠ¤ï¼Œä¸å¯åˆ‡æ¢é¢œè‰²
            if(pinnedNodes[selectedId]) return;
            setColorCascade(selectedNode.id, i);
            layoutHorizontal();
            render();
            renderColorBar();
          }
        };
        colorBar.appendChild(btn);
      });
    }

    // ...å…¶ä½™ä»£ç åŒå‰ï¼ˆå¸ƒå±€ã€èŠ‚ç‚¹æ¸²æŸ“ã€äº‹ä»¶ã€å¿«æ·é”®ç­‰ï¼‰...
    const mindmap = document.getElementById('mindmap');
    const sidebar = document.getElementById('sidebar');
    const thumbList = document.getElementById('thumb-list');
    const btnAddRoot = document.getElementById('btn-addroot');
    const imgUpload = document.getElementById('img-upload');

    function render() {
      layoutHorizontal();
      mindmap.innerHTML = '';
      btnAddRoot.style.display = nodes.length ? 'none' : '';
      // è¿çº¿
      nodes.forEach(n=>{
        if(n.parent!==null && n.parent!==undefined){
          let p = nodes.find(nn=>nn.id===n.parent);
          if(p) {
            let lineColor = COLOR_LIST[p.colorIdx !== undefined ? p.colorIdx : (p.id === 1 ? 1 : 0)].line;
            drawLine(p, n, lineColor);
          }
        }
      });
      // èŠ‚ç‚¹
      nodes.forEach(n=>{
        let div = document.createElement('div');
        div.className = 'node' + (selectedId===n.id?' selected':'') + (n.id===1?' root':'');
        div.style.left = (n.x+offsetX)+'px';
        div.style.top = (n.y+offsetY)+'px';
        div.style.position = "absolute";
        div.style.fontSize = "15px";
        div.style.whiteSpace = "nowrap";
        div.style.flexDirection = "row";
        div.dataset.id = n.id;
        // é¢œè‰²
        let colorIdx = n.colorIdx !== undefined ? n.colorIdx : (n.id===1?1:0);
        let cset = COLOR_LIST[colorIdx] || COLOR_LIST[0];
        div.style.background = cset.bg;
        div.style.color = cset.color;
        if(n.id===1) {
          div.style.background = COLOR_LIST[colorIdx || 1].bg;
          div.style.color = COLOR_LIST[colorIdx || 1].color;
        }
        // é€‰ä¸­
        if(selectedId === n.id) {
          let outline = document.createElement('div');
          outline.className = "select-outline";
          div.appendChild(outline);
          div.style.zIndex = 11;
        }
        // ç¼–è¾‘æ¡†
        if(editingNodeId === n.id) {
          let input = document.createElement('input');
          input.value = n.text;
          input.onblur = function() { finishEdit(n, input.value); };
          input.onkeydown = function(e) {
            if(e.key === "Enter") input.blur();
            else if(e.key === "Escape") { editingNodeId = null; render(); }
          };
          setTimeout(()=>{ input.focus(); input.select(); }, 0);
          div.appendChild(input);
        } else {
          let txtspan = document.createElement('span');
          txtspan.textContent = n.text;
          div.appendChild(txtspan);
        }
        if(n.img){
          let imgEl = document.createElement('img');
          imgEl.src = n.img;
          imgEl.className = 'node-img';
          div.appendChild(imgEl);
        }
        let icons = document.createElement('div');
        icons.className = 'node-icons';
        let btnAdd = document.createElement('button');
        btnAdd.className = 'icon-btn add';
        btnAdd.title = "å¢åŠ èŠ‚ç‚¹";
        btnAdd.innerHTML = '<svg width="16" height="16" fill="currentColor"><circle cx="8" cy="8" r="7" stroke="#8066e1" stroke-width="1.5" fill="none"/><rect x="7" y="3.5" width="2" height="9" rx="1"/><rect x="3.5" y="7" width="9" height="2" rx="1"/></svg>';
        btnAdd.onclick = function(e){
          e.stopPropagation();
          addNode(n.id);
        };
        icons.appendChild(btnAdd);
        if(n.id!==1) {
          let btnDel = document.createElement('button');
          btnDel.className = 'icon-btn del';
          btnDel.title = "åˆ é™¤èŠ‚ç‚¹";
          btnDel.innerHTML = '<svg width="16" height="16" fill="currentColor"><circle cx="8" cy="8" r="7" stroke="#b71c1c" stroke-width="1.5" fill="none"/><line x1="5" y1="5" x2="11" y2="11" stroke="#b71c1c" stroke-width="2"/><line x1="11" y1="5" x2="5" y2="11" stroke="#b71c1c" stroke-width="2"/></svg>';
          btnDel.onclick = function(e){
            e.stopPropagation();
            deleteNode(n.id);
          };
          icons.appendChild(btnDel);
        }
        let btnImg = document.createElement('button');
        btnImg.className = 'icon-btn img';
        btnImg.title = "ä¸Šä¼ å›¾ç‰‡";
        btnImg.innerHTML = '<svg width="16" height="16" fill="currentColor"><circle cx="8" cy="8" r="7" stroke="#f4b400" stroke-width="1.5" fill="none"/><rect x="4" y="10" width="8" height="2" rx="1" fill="#f4b400"/><circle cx="8" cy="7" r="2" fill="#f4b400"/></svg>';
        btnImg.onclick = function(e){
          e.stopPropagation();
          uploadImgForNode(n.id);
        };
        icons.appendChild(btnImg);
        let btnEdit = document.createElement('button');
        btnEdit.className = 'icon-btn edit';
        btnEdit.title = "æ–‡æœ¬ç¼–è¾‘";
        btnEdit.innerHTML = '<svg width="16" height="16" fill="currentColor"><circle cx="8" cy="8" r="7" stroke="#388e3c" stroke-width="1.5" fill="none"/><rect x="5" y="5" width="6" height="6" rx="1.2" stroke="#388e3c" stroke-width="1.2" fill="none"/><rect x="7" y="7" width="2" height="2" rx="0.5" fill="#388e3c"/></svg>';
        btnEdit.onclick = function(e){
          e.stopPropagation();
          editingNodeId = n.id;
          render();
        };
        icons.appendChild(btnEdit);
        div.appendChild(icons);
        div.onclick = function(e){
          e.stopPropagation();
          selectedId = n.id;
          render();
          renderColorBar();
        };
        div.ondblclick = function(e){
          editingNodeId = n.id;
          render();
        };
        div.onmousedown = function(e){
          if(e.target.classList.contains('icon-btn')) return;
          e.stopPropagation();
          let startX = e.clientX, startY = e.clientY;
          let oriX = n.x, oriY = n.y;
          function move(ev){
            n.x = oriX + (ev.clientX - startX)/scale;
            n.y = oriY + (ev.clientY - startY)/scale;
            // è‹¥ä¸ºç½®é¡¶ï¼Œæ›´æ–°pinnedåæ ‡
            if (pinnedNodes[n.id]) {
              pinnedNodes[n.id].x = n.x;
              pinnedNodes[n.id].y = n.y;
            }
            render();
          }
          function up(){
            document.removeEventListener('mousemove', move);
            document.removeEventListener('mouseup', up);
          }
          document.addEventListener('mousemove', move);
          document.addEventListener('mouseup', up);
        };
        mindmap.appendChild(div);
      });
      mindmap.style.transform = `scale(${scale})`;
      renderColorBar();
    }

    function finishEdit(n, val) {
      n.text = val.trim() || "æœªå‘½å";
      editingNodeId = null; render();
    }

    function drawLine(from, to, color="#bfbefc"){
      let x1 = from.x + 65 + offsetX, y1 = from.y + 17 + offsetY;
      let x2 = to.x + 15 + offsetX, y2 = to.y + 17 + offsetY;
      let svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
      svg.classList.add('line');
      svg.style.left = Math.min(x1,x2)-25+"px";
      svg.style.top = Math.min(y1,y2)-25+"px";
      svg.style.width = Math.abs(x2-x1)+50+"px";
      svg.style.height = Math.abs(y2-y1)+50+"px";
      svg.innerHTML = `<path d="M ${x1-Math.min(x1,x2)+25} ${y1-Math.min(y1,y2)+25} Q ${(x1-Math.min(x1,x2)+x2-Math.min(x1,x2))/2+25} ${(y1-Math.min(y1,y2)+y2-Math.min(y1,y2))/2+25-18}, ${x2-Math.min(x1,x2)+25} ${y2-Math.min(y1,y2)+25}"
        stroke="${color}" stroke-width="2.2" fill="none" />`;
      mindmap.appendChild(svg);
    }

    function addRoot() {
      if(nodes.length>0) { alert("åªèƒ½æœ‰ä¸€ä¸ªä¸­å¿ƒä¸»é¢˜"); return; }
      nodes.push({id:1, text:"ä¸­å¿ƒä¸»é¢˜", x:520, y:220, parent:null, img:"", colorIdx:1});
      idCounter=2; selectedId=1; editingNodeId=1;
      layoutHorizontal();
      render();
    }

    function addNode(parentId){
      let p = nodes.find(n=>n.id===parentId);
      let children = nodes.filter(n=>n.parent===parentId);
      let newId = idCounter++;
      nodes.push({
        id:newId,
        text:"æ–°èŠ‚ç‚¹",
        x:p.x + 180,
        y:p.y + children.length * 80,
        parent:parentId,
        img:"",
        colorIdx:p.colorIdx !== undefined ? p.colorIdx : (p.id===1?1:0)
      });
      selectedId=newId; editingNodeId=newId;
      layoutHorizontal();
      render();
    }

    function deleteNode(nodeId) {
      delRec(nodeId);
      delete pinnedNodes[nodeId];
      selectedId = nodes[0]?.id || null;
      layoutHorizontal();
      render();
    }
    function delRec(id){
      nodes.filter(n=>n.parent===id).forEach(n=>delRec(n.id));
      nodes = nodes.filter(n=>n.id!==id);
      delete pinnedNodes[id];
    }

    function uploadImgForNode(nodeId){
      imgUpload.value = '';
      imgUpload.onchange = function(){
        const file = imgUpload.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(){
          let n = nodes.find(n=>n.id===nodeId);
          n.img = reader.result;
          render();
        };
        reader.readAsDataURL(file);
      };
      imgUpload.click();
    }

    function zoomIn(){ scale = Math.min(scale * 1.15, 4); render();}
    function zoomOut(){ scale = Math.max(scale / 1.15, 0.25); render();}
    function zoomReset(){ scale = 1; render(); }

    document.addEventListener("wheel",function(e){
      if(e.ctrlKey){
        e.preventDefault();
        if(e.deltaY < 0) zoomIn();
        else if(e.deltaY > 0) zoomOut();
      }
    }, {passive:false});

    mindmap.addEventListener('mousedown', function(e){
      if(e.target !== mindmap) return;
      draggingCanvas = true;
      mindmap.classList.add('dragging');
      dragStartX = e.clientX;
      dragStartY = e.clientY;
      dragOriX = offsetX;
      dragOriY = offsetY;
      function move(ev){
        offsetX = dragOriX + (ev.clientX-dragStartX)/scale;
        offsetY = dragOriY + (ev.clientY-dragStartY)/scale;
        render();
      }
      function up(){
        draggingCanvas = false;
        mindmap.classList.remove('dragging');
        document.removeEventListener('mousemove', move);
        document.removeEventListener('mouseup', up);
      }
      document.addEventListener('mousemove', move);
      document.addEventListener('mouseup', up);
    });

    document.addEventListener("keydown",function(e){
      if(document.activeElement.tagName==="INPUT") return;
      if(e.key==="Enter" && selectedId!==null){
        e.preventDefault();
        addNode(selectedId);
      }
      else if(e.key===" " && selectedId){
        e.preventDefault();
        editingNodeId = selectedId;
        render();
      }
      else if(e.key==="Backspace" && selectedId && selectedId!==1){
        e.preventDefault();
        deleteNode(selectedId);
      }
      else if(e.key==="Escape"){
        hideSidebar();
        hideDialog();
      }
    });

   function saveCloud(){
      if (!auth.currentUser) return alert('è¯·å…ˆç™»å½•å†ä¿å­˜åˆ°äº‘ç«¯');
      if(!nodes.length) return alert("å½“å‰ç”»å¸ƒä¸ºç©ºã€‚");
      let title = nodes.find(n=>n.id===1)?.text || "æ€ç»´å¯¼å›¾";
      const uid = auth.currentUser.uid;
      db.collection('mindmaps')
        .add({
          uid: uid,
          title: title,
          nodes: JSON.parse(JSON.stringify(nodes)),
          time: firebase.firestore.FieldValue.serverTimestamp()
        })
        .then(() => {
          alert("å·²ä¿å­˜åˆ°äº‘ç«¯ï¼");
          loadSidebarIfVisible();
        })
        .catch(e => alert('ä¿å­˜å¤±è´¥: ' + e.message));
    }

    function loadSidebarIfVisible() {
      if(sidebar.style.display==='flex') renderSidebar();
    }

    function showSidebar(){
      renderSidebar();
      document.getElementById('sidebar').style.display="flex";
      document.getElementById('sidebar-mask').style.display="block";
      document.body.style.overflow="hidden";
    }
    function hideSidebar(){
      document.getElementById('sidebar').style.display="none";
      document.getElementById('sidebar-mask').style.display="none";
      document.body.style.overflow="";
    }
      document.getElementById('sidebar-mask').onclick = hideSidebar;
      document.getElementById('sidebar').onclick = function(e){
      if(e.target===this) hideSidebar();
      }
    function renderSidebar(){
      if(!auth.currentUser) {
        thumbList.innerHTML = `<div style="color:#bbb;font-size:12px;margin:18px 0;text-align:center;">è¯·å…ˆç™»å½•</div>`;
        return;
      }
      const uid = auth.currentUser.uid;
      db.collection('mindmaps')
        .where('uid', '==', uid)
        .orderBy('time', 'desc')
        .limit(30)
        .get()
        .then(snapshot=>{
          thumbList.innerHTML = '';
          if(snapshot.empty) {
            thumbList.innerHTML = `<div style="color:#bbb;font-size:12px;margin:18px 0;text-align:center;">æš‚æ— çº¿ä¸Šå¯¼å›¾</div>`;
            return;
          }
          snapshot.forEach(doc=>{
            const item = doc.data();
            let div = document.createElement('div');
            div.className = 'thumb-item';
            div.onclick = function(){
              nodes = JSON.parse(JSON.stringify(item.nodes));
              idCounter = Math.max(...nodes.map(n=>n.id))+1;
              selectedId = nodes[0]?.id || null;
              editingNodeId = null;
              hideSidebar();
              render();
            };
            let title = document.createElement('div');
            title.className = 'thumb-title';
            title.textContent = item.title;
            div.appendChild(title);
            let svg = document.createElementNS("http://www.w3.org/2000/svg","svg");
            svg.setAttribute("class","thumb-svg");
            svg.setAttribute("width","130"); svg.setAttribute("height","38");
            renderThumbSvg(svg, item.nodes);
            div.appendChild(svg);
            thumbList.appendChild(div);
          });
        });
    }
    function renderThumbSvg(svg, nodes0){
      let ns = nodes0.map(n=>({...n}));
      let minX = Math.min(...ns.map(n=>n.x)), maxX = Math.max(...ns.map(n=>n.x));
      let minY = Math.min(...ns.map(n=>n.y)), maxY = Math.max(...ns.map(n=>n.y));
      let sx = 110/Math.max(60,maxX-minX+1), sy=22/Math.max(16,maxY-minY+1);
      let tx = (130 - (maxX-minX)*sx)/2 - minX*sx + 6;
      let ty = (38 - (maxY-minY)*sy)/2 - minY*sy + 2;
      svg.innerHTML = '';
      ns.forEach(n=>{
        if(n.parent!==null && n.parent!==undefined){
          let p = ns.find(nn=>nn.id===n.parent);
          if(p){
            let x1 = p.x*sx+tx+23, y1 = p.y*sy+ty+8;
            let x2 = n.x*sx+tx+8, y2 = n.y*sy+ty+8;
            let c = p.id===1?"#f4c24d":"#bfbefc";
            let path = document.createElementNS("http://www.w3.org/2000/svg","path");
            path.setAttribute("d",`M${x1},${y1} Q${(x1+x2)/2},${(y1+y2)/2-7},${x2},${y2}`);
            path.setAttribute("stroke",c); path.setAttribute("stroke-width","1.3"); path.setAttribute("fill","none");
            svg.appendChild(path);
          }
        }
      });
      ns.forEach(n=>{
        let x = n.x*sx+tx+(n.id===1?23:8), y = n.y*sy+ty+8;
        let r = n.id===1?8:5;
        let circ = document.createElementNS("http://www.w3.org/2000/svg","circle");
        circ.setAttribute("cx",x); circ.setAttribute("cy",y); circ.setAttribute("r",r);
        circ.setAttribute("fill",n.id===1?"#ffe08b":"#fff");
        circ.setAttribute("stroke",n.id===1?"#f4c24d":"#bfbefc");
        circ.setAttribute("stroke-width",n.id===1?"1.2":"1");
        svg.appendChild(circ);
      });
    }
    function onNewMap() {
      if(nodes.length>0){
        showDialog("æ˜¯å¦ä¿å­˜å½“å‰ç”»å¸ƒï¼Ÿ", ()=>{saveCloud(); newMap();});
      } else {
        newMap();
      }
    }
    function newMap(){
      nodes = [];
      idCounter = 1;
      selectedId = null;
      editingNodeId = null;
      render();
    }

    mindmap.onclick = ()=>{selectedId=null;render();};
    document.body.addEventListener("keydown",function(e){
      if(e.key==="Escape") hideSidebar();
    });

    // å¯¹è¯æ¡†
function showDialog(msg, onSave) {
  document.getElementById('dialog-msg').innerText = msg || 'æ˜¯å¦ä¿å­˜å½“å‰ç”»å¸ƒï¼Ÿ';
  document.getElementById('overlay').style.display = 'flex';
  let saveBtn = document.getElementById('dialog-save-btn');
  // è§£ç»‘æ—§çš„
  saveBtn.onclick = null;
  // ç»‘å®šæ–°çš„
  saveBtn.onclick = function() {
    hideDialog();
    if(typeof onSave === 'function') onSave();
  };
}
function hideDialog() {
  document.getElementById('overlay').style.display = 'none';
}
    render();
  </script>
<div id="overlay" style="display:none; position:fixed;z-index:9999;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.15);align-items:center;justify-content:center;">
  <div id="dialog" style="background:#fff;padding:28px 34px 20px 34px;border-radius:13px;min-width:230px;max-width:80vw;box-shadow:0 8px 40px #b3a5ff44;text-align:center;">
    <div id="dialog-msg" style="font-size:17px;margin-bottom:20px;">æ˜¯å¦ä¿å­˜å½“å‰ç”»å¸ƒï¼Ÿ</div>
    <button class="dialog-btn" id="dialog-save-btn" style="margin-right:12px;padding:6px 25px;">ä¿å­˜</button>
    <button class="dialog-btn" onclick="hideDialog()" style="padding:6px 25px;">å–æ¶ˆ</button>
  </div>
</div>
</body>
</html>