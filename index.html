<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>æ€ç»´å¯¼å›¾ + æœç´¢å¼•æ“</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-auth-compat.js"></script>
<style>
/* åŸºç¡€æ ·å¼ */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}
body { 
  margin: 0; 
  background: #f0f2f5; 
  font-family: Arial, 'Microsoft YaHei', sans-serif;
  overflow: hidden;
  padding: 20px;
  height: 100vh;
}

/* ä¸»ä½“å¸ƒå±€ - çª—å£å®¹å™¨ */
.app-container {
  display: flex;
  height: calc(100vh - 40px);
  width: calc(100vw - 40px);
  position: relative;
  gap: 20px;
}

/* çª—å£é€šç”¨æ ·å¼ */
.window {
  border-radius: 16px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
  overflow: hidden;
  display: flex;
  flex-direction: column;
  transition: all 0.3s ease;
}

/* å·¦ä¾§æœç´¢åŒºåŸŸ */
.search-section {
  width: 33.33%;
  background: #fff;
  height: 100%;
  position: relative;
  z-index: 10;
}

/* æœç´¢å¼•æ“æ ‡é¢˜ */
.search-header {
  display: flex;
  align-items: center;
  padding: 20px;
  border-bottom: 1px solid #f0f0f0;
}

.search-logo {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: #8066e1;
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  font-weight: bold;
  margin-right: 15px;
}

.search-title {
  font-size: 22px;
  font-weight: 600;
  color: #333;
}

/* æœç´¢æ¡†å®¹å™¨ */
.search-container {
  padding: 20px;
  border-bottom: 1px solid #f0f0f0;
}

/* æœç´¢æ¡† */
.search-box {
  position: relative;
  margin-bottom: 20px;
}

.search-input {
  width: 100%;
  padding: 15px 20px 15px 50px;
  border: 2px solid #8066e1;
  border-radius: 30px;
  font-size: 16px;
  outline: none;
  transition: all 0.3s;
  box-shadow: 0 4px 12px rgba(128, 102, 225, 0.1);
}

.search-input:focus {
  box-shadow: 0 6px 20px rgba(128, 102, 225, 0.2);
}

.search-icon {
  position: absolute;
  left: 18px;
  top: 50%;
  transform: translateY(-50%);
  color: #8066e1;
  font-size: 20px;
}

/* æœç´¢æŒ‰é’® */
.search-buttons {
  display: flex;
  justify-content: center;
  gap: 15px;
  margin-top: 10px;
}

.search-btn {
  padding: 10px 25px;
  border: none;
  border-radius: 5px;
  background: #8066e1;
  color: white;
  font-size: 15px;
  cursor: pointer;
  transition: all 0.2s;
}

.search-btn:hover {
  background: #6c5ce7;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(128, 102, 225, 0.2);
}

.search-btn.secondary {
  background: #f8f9fa;
  color: #333;
}

.search-btn.secondary:hover {
  background: #e9ecef;
}

/* æœç´¢å¼•æ“é€‰æ‹© */
.search-engines {
  display: flex;
  justify-content: center;
  gap: 20px;
  margin-top: 20px;
}

.engine-option {
  display: flex;
  flex-direction: column;
  align-items: center;
  cursor: pointer;
  opacity: 0.7;
  transition: all 0.2s;
}

.engine-option:hover {
  opacity: 1;
  transform: translateY(-3px);
}

.engine-option.active {
  opacity: 1;
}

.engine-icon {
  width: 30px;
  height: 30px;
  border-radius: 50%;
  margin-bottom: 8px;
  object-fit: contain;
}

.engine-name {
  font-size: 13px;
  color: #555;
}

/* æœç´¢ç»“æœåŒºåŸŸ */
.search-results-container {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.search-results {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
}

.search-results-title {
  font-size: 16px;
  color: #333;
  margin-bottom: 15px;
  font-weight: 500;
}

.search-result-item {
  margin-bottom: 20px;
  padding: 15px;
  border-radius: 8px;
  background: #f8f9fa;
  transition: all 0.2s;
  cursor: pointer;
}

.search-result-item:hover {
  background: #f1f3f5;
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
}

.result-title {
  color: #1a73e8;
  font-size: 18px;
  margin-bottom: 5px;
  font-weight: 500;
}

.result-url {
  color: #0d652d;
  font-size: 14px;
  margin-bottom: 8px;
}

.result-description {
  color: #4d5156;
  font-size: 14px;
  line-height: 1.5;
}

.search-pagination {
  display: flex;
  justify-content: center;
  padding: 15px;
  gap: 10px;
  border-top: 1px solid #f0f0f0;
}

.page-btn {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  background: #f8f9fa;
  border: 1px solid #e1e4fa;
  cursor: pointer;
  transition: all 0.2s;
}

.page-btn:hover {
  background: #e9ecef;
}

.page-btn.active {
  background: #8066e1;
  color: white;
  border-color: #8066e1;
}

.page-btn.disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* æœç´¢å†å² */
.search-history {
  padding: 15px 20px;
  border-top: 1px solid #f0f0f0;
}

.history-title {
  font-size: 14px;
  color: #666;
  margin-bottom: 10px;
}

.history-list {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
}

.history-item {
  padding: 6px 12px;
  background: #f1f3f4;
  border-radius: 15px;
  font-size: 13px;
  color: #333;
  cursor: pointer;
  transition: all 0.2s;
}

.history-item:hover {
  background: #e8eaed;
}

/* å³ä¾§æ€ç»´å¯¼å›¾åŒºåŸŸ */
.mindmap-section {
  flex: 1;
  position: relative;
  overflow: hidden;
  background: #fff;
}

/* é¡¶éƒ¨å·¥å…·æ  */
#toolbar {
  width: 100%;
  height: 60px; 
  background: #8066e1; 
  color: #fff; 
  display: flex; 
  align-items: center;
  box-sizing: border-box; 
  padding: 0 32px; 
  position: relative; 
  z-index: 10;
}
#toolbar .logo { 
  font-size: 25px; 
  font-weight: bold; 
  border-radius: 50%; 
  width: 32px; 
  height: 32px; 
  background: #fff; 
  color: #8066e1; 
  display: inline-flex; 
  align-items: center; 
  justify-content: center; 
  margin-right: 14px;
}
#toolbar .title { 
  font-size: 21px; 
  font-weight: bold; 
  margin-right: 32px;
}
#toolbar .btn { 
  margin-left: 12px; 
  background: #fff; 
  color: #8066e1; 
  border: none; 
  border-radius: 8px; 
  padding: 6px 19px; 
  font-size: 15px; 
  cursor: pointer; 
  font-weight: 500; 
  transition: .2s; 
  display: inline-flex; 
  align-items: center;
}
#toolbar .btn:hover { 
  background: #e9e4fc;
}
#toolbar .btn.add { 
  background: #f5f6fa; 
  color: #8066e1; 
  border: 1.4px solid #8066e1;
}
#toolbar .btn.add:hover { 
  background: #e9e4fc; 
}
#toolbar .user-info { 
  margin-left: auto; 
  display: flex; 
  align-items: center; 
  gap: 8px; 
  font-size: 14px;
}
#toolbar .avatar { 
  width: 26px; 
  height: 26px; 
  border-radius: 50%; 
  background: #eee; 
  object-fit: cover; 
}

/* æ€ç»´å¯¼å›¾å®¹å™¨ */
#mindmap-container { 
  position: relative; 
  width: 100%; 
  height: calc(100% - 60px); 
  overflow: hidden; 
  background: #f9f9fc; 
}
#mindmap { 
  width: 100%; 
  height: 100%; 
  position: absolute; 
  left: 0; 
  top: 0; 
  overflow: hidden; 
}

/* é¢œè‰²é€‰æ‹©æ  */
#color-bar {
  position: absolute;
  top: 76px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 100;
  display: flex;
  gap: 12px;
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 2px 10px rgba(199, 187, 250, 0.3);
  padding: 8px 20px 7px 20px;
  align-items: center;
  min-width: 220px;
  transition: box-shadow .18s;
  user-select: none;
}
.color-bar-top-btn {
  width: 27px;
  height: 27px;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 2px solid #e1e4fa;
  border-radius: 8px;
  background: #fff;
  color: #faad14;
  cursor: pointer;
  box-shadow: 0 1px 4px rgba(199, 187, 250, 0.07);
  margin-right: 7px;
  font-size: 18px;
  transition: border .18s, box-shadow .18s, color .13s;
}
.color-bar-top-btn.pinned {
  color: #8066e1;
  border: 2.7px solid #8066e1;
  background: #f8f7fd;
}
.color-option {
  width: 27px; 
  height: 27px;
  border-radius: 8px;
  border: 2px solid #e1e4fa;
  cursor: pointer;
  box-shadow: 0 1px 4px rgba(199, 187, 250, 0.07);
  transition: border .18s, box-shadow .18s;
  display: flex; 
  align-items: center; 
  justify-content: center;
  position: relative;
}
.color-option.selected, .color-option:hover {
  border: 2.7px solid #8066e1;
  box-shadow: 0 2px 8px rgba(179, 165, 255, 0.2);
}
.color-option .tick {
  position: absolute;
  right: 2px; 
  bottom: 2px;
  width: 13px; 
  height: 13px;
  background: rgba(255,255,255,.8);
  border-radius: 50%;
  display: flex; 
  align-items: center; 
  justify-content: center;
  font-size: 12px;
  color: #8066e1;
  font-weight: bold;
  pointer-events: none;
}

/* åœ¨ .color-option æ ·å¼åæ·»åŠ  */
.plant-icon {
  width: 20px;
  height: 20px;
  margin-right: 5px;
  vertical-align: middle;
}

.node.folded-complete {
  position: relative;
}

.node.folded-complete::after {
  content: "";
  position: absolute;
  right: -8px;
  bottom: -5px;
  width: 16px;
  height: 16px;
  background: #8066e1;
  border-radius: 50%;
  font-size: 12px;
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 1px 4px rgba(0,0,0,0.2);
}

.node.folded-complete::before {
  content: "+";
  position: absolute;
  right: -8px;
  bottom: -5px;
  width: 16px;
  height: 16px;
  z-index: 10;
  font-size: 14px;
  font-weight: bold;
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* éšè—/æ˜¾ç¤ºå¿«æ·é”®æç¤ºæ  */
.shortcutbar .toggle-btn {
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  background: rgba(255, 255, 255, 0.7);
  border: none;
  border-radius: 50%;
  width: 22px;
  height: 22px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  cursor: pointer;
  opacity: 0.7;
  transition: all 0.2s;
}

.shortcutbar .toggle-btn:hover {
  opacity: 1;
  background: #fff;
}

/* æŠ˜å æ ·å¼ */
    .shortcutbar.collapsed {
      min-width: 44px;
      max-width: 44px;
      padding: 7px 7px;
      overflow: hidden;
      justify-content: center;
}
.shortcutbar.collapsed > span,
.shortcutbar.collapsed > kbd {
  display: none !important;
}
.shortcutbar.collapsed .toggle-btn:after {
      content: "â¯‡";
      display: inline;
      font-size: 16px;
      margin-left: 0;
}
.toggle-btn:after {
      content: "";
    }

/* æœç´¢ç»“æœå¢å¼ºæ ·å¼ */
.search-result-item {
  transition: all 0.3s;
  border-left: 4px solid transparent;
}

.search-result-item:hover {
  border-left: 4px solid #8066e1;
}

.result-snippet {
  color: #666;
  font-size: 13px;
  line-height: 1.4;
  margin-top: 5px;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.result-meta {
  display: flex;
  align-items: center;
  margin-top: 5px;
  font-size: 12px;
  color: #888;
}

.result-meta span {
  margin-right: 10px;
}

.plant-theme-green {
  color: #2e7d32 !important;
  border-color: #81c784 !important;
}

.plant-theme-autumn {
  color: #e65100 !important;
  border-color: #ffb74d !important;
}

.plant-theme-blossom {
  color: #ad1457 !important;
  border-color: #f48fb1 !important;
}

.plant-theme-jungle {
  color: #1b5e20 !important;
  border-color: #66bb6a !important;
}

.plant-theme-forest {
  color: #1a237e !important;
  border-color: #7986cb !important;
}

/* èŠ‚ç‚¹æ ·å¼ */
.node {
  position: absolute; 
  min-width: 65px; 
  min-height: 28px; 
  padding: 4px 13px 4px 18px;
  background: #fff; 
  border-radius: 12px; 
  color: #333; 
  font-weight: 400;
  user-select: none; 
  cursor: pointer; 
  box-shadow: 0 2px 9px rgba(199, 187, 250, 0.2);
  font-size: 15px; 
  border: 1.7px solid #bfbefc; 
  transition: .2s;
  z-index: 2; 
  display: flex; 
  align-items: center; 
  flex-direction: row; 
  gap: 0;
  white-space: nowrap;
}
.node.root { 
  font-weight: bold;
}
.node input {
  font-size: 15px; 
  font-family: inherit; 
  border: none; 
  border-radius: 8px; 
  background: #fffde6; 
  outline: 2px solid #8066e1; 
  color: #333;
  padding: 2px 8px; 
  width: 100px; 
  box-sizing: border-box;
}
.node .node-img {
  max-width: 60px; 
  max-height: 60px; 
  border-radius: 4px; 
  margin-left: 6px; 
  vertical-align: middle;
}
.node .node-icons {
  position: absolute;
  left: 100%; 
  top: 50%; 
  transform: translateY(-50%);
  display: flex; 
  flex-direction: row; 
  gap: 2px;
  opacity: 0; 
  pointer-events: none; 
  transition: .2s;
  z-index: 10;
}
.node:hover .node-icons,
.node .node-icons:focus-within {
  opacity: 1; 
  pointer-events: all;
}
.node .icon-btn {
  background: #fff; 
  border: 1px solid #e2d6fa; 
  color: #8066e1;
  border-radius: 50%; 
  width: 26px; 
  height: 26px;
  display: flex; 
  align-items: center; 
  justify-content: center;
  font-size: 15px; 
  cursor: pointer; 
  margin-left: 3px; 
  box-shadow: 0 1px 4px rgba(199, 187, 250, 0.13); 
  transition: .18s;
  outline: none;
}
.node .icon-btn:hover { 
  background: #f5f0fa; 
  border-color: #bfbefc;
}
.node .icon-btn:active { 
  background: #e8e0fd;
}
.node .icon-btn.edit { 
  color: #388e3c;
}
.node .icon-btn.del { 
  color: #b71c1c;
}
.node .icon-btn.img { 
  color: #f4b400;
}
.node .icon-btn.add { 
  color: #8066e1;
}
.node .icon-btn.fold { 
  color: #0288d1;
}
.line { 
  position: absolute; 
  z-index: 1; 
  pointer-events: none; 
}
#img-upload { 
  display: none; 
}
.node.selected {
  border: 2.3px solid #8066e1;
  box-shadow: 0 0 0 3px rgba(173, 159, 251, 0.27), 0 2px 9px rgba(199, 187, 250, 0.2);
}
.node.selected .select-outline {
  pointer-events: none;
  position: absolute;
  top: -7px; 
  left: -7px; 
  right: -7px; 
  bottom: -7px;
  border: 2.5px solid #8066e1;
  border-radius: 16px;
  box-shadow: 0 0 10px 2px rgba(199, 187, 250, 0.2);
  z-index: 10;
  background: none;
  content: "";
}
.node.highlight {
  box-shadow: 0 0 0 4px rgba(255, 224, 139, 0.5), 0 2px 9px rgba(199, 187, 250, 0.2);
  animation: pulse 1.5s infinite;
}
.node.folded::after {
  content: "...";
  position: absolute;
  right: 10px;
  bottom: -5px;
  font-size: 18px;
  font-weight: bold;
  color: #8066e1;
}
@keyframes pulse {
  0% { box-shadow: 0 0 0 4px rgba(255, 224, 139, 0.5), 0 2px 9px rgba(199, 187, 250, 0.2); }
  50% { box-shadow: 0 0 0 6px rgba(255, 224, 139, 0.3), 0 2px 9px rgba(199, 187, 250, 0.2); }
  100% { box-shadow: 0 0 0 4px rgba(255, 224, 139, 0.5), 0 2px 9px rgba(199, 187, 250, 0.2); }
}

/* å¿«æ·é”®æ  */
.shortcutbar {
  position: absolute;
  left: 50%;
  bottom: 18px;
  transform: translateX(-50%);
  background: #fff;
  color: #333;
  font-size: 13px;
  border-radius: 9px;
  box-shadow: 0 1px 10px rgba(199, 187, 250, 0.3);
  padding: 7px 20px;
  opacity: .98;
  display: flex;
  gap: 14px;
  z-index: 101;
  flex-wrap: wrap;
  align-items: center;
}
.shortcutbar kbd {
  background: #8066e1;
  color: #fff;
  border-radius: 3px;
  padding: 2px 7px;
  margin-right: 3px;
  font-family: monospace;
  font-size: 13px;
  font-weight: 500;
  box-shadow: 0 1px 2px rgba(189, 177, 246, 0.13);
}

/* æµ®åŠ¨æŒ‰é’® */
.mindmap-fab-wrap {
  position: absolute;
  right: 24px;
  bottom: 30px;
  z-index: 102;
  display: flex;
  flex-direction: column;
  gap: 14px;
  align-items: flex-end;
}
.mindmap-fab-btn {
  width: 45px; 
  height: 45px;
  border-radius: 50%;
  background: #fff;
  color: #8066e1;
  border: 2.2px solid #ece6fd;
  box-shadow: 0 2px 10px rgba(199, 187, 250, 0.4);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 23px;
  cursor: pointer;
  transition: all .16s;
  outline: none;
  margin-bottom: 0;
  position: relative;
}
.mindmap-fab-btn:hover {
  background: #ede7fb;
  border-color: #8066e1;
  transform: scale(1.07) translateY(-2px);
  box-shadow: 0 5px 20px rgba(179, 165, 255, 0.3);
}
.mindmap-fab-btn svg {
  pointer-events: none;
  display: block;
}
.mindmap-fab-btn .fab-tooltip {
  display: none;
  position: absolute;
  right: 110%;
  top: 50%;
  transform: translateY(-50%);
  background: #fff;
  color: #8066e1;
  border-radius: 6px;
  font-size: 13px;
  padding: 2px 9px;
  box-shadow: 0 0 8px rgba(199, 187, 250, 0.2);
  white-space: nowrap;
}
.mindmap-fab-btn:hover .fab-tooltip {
  display: block;
}
#mindmap.dragging {
  cursor: grabbing !important;
}
#mindmap {
  cursor: grab;
}

/* ä¾§è¾¹æ  */
#sidebar-mask {
  display: none;
  position: fixed; 
  left: 0; 
  top: 0; 
  width: 100vw; 
  height: 100vh;
  background: rgba(40, 36, 87, 0.12); 
  z-index: 14;
}
#sidebar {
  position: fixed; 
  top: 60px; 
  left: 20px;
  width: 300px; 
  height: calc(100vh - 80px);
  background: #fff; 
  box-shadow: 2px 0 16px rgba(183, 174, 250, 0.2); 
  z-index: 15;
  display: none; 
  flex-direction: column; 
  padding: 15px 0 0 0; 
  overflow-y: auto;
  transition: left .18s;
  border-radius: 16px;
}
#sidebar h3 { 
  font-size: 15px; 
  margin: 0 0 7px 21px; 
  color: #8066e1;
}
.thumb-list { 
  width: 100%; 
  display: flex; 
  flex-direction: column; 
  gap: 13px; 
  padding: 0 12px 10px 12px;
}
.thumb-item {
  background: #f8f8fd; 
  border-radius: 8px; 
  box-shadow: 0 1px 4px rgba(221, 213, 250, 0.2); 
  padding: 10px 8px 7px 8px;
  margin-bottom: 2px; 
  cursor: pointer; 
  border: 1.5px solid transparent; 
  transition: .15s;
  display: flex; 
  flex-direction: column; 
  align-items: center; 
  font-size: 12px;
}
.thumb-item.selected, .thumb-item:hover { 
  border-color: #8066e1; 
  background: #f1edfa;
}
.thumb-title {
  font-size: 12px; 
  color: #8066e1; 
  margin-bottom: 4px; 
  font-weight: bold;
  text-align: center; 
  width: 100%; 
  word-break: break-all;
}
.thumb-date {
  font-size: 11px;
  color: #888;
  margin-bottom: 6px;
}
.thumb-svg {
  background: #fff; 
  border-radius: 5px; 
  margin-bottom: 2px; 
  box-shadow: 0 1px 3px rgba(221, 212, 255, 0.13);
  width: 130px; 
  height: 38px; 
  display: block;
}

/* å¯¹è¯æ¡† */
#overlay {
  display: none; 
  position: fixed;
  z-index: 9999;
  left: 0;
  top: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0, 0, 0, 0.15);
  align-items: center;
  justify-content: center;
}
#dialog {
  background: #fff;
  padding: 28px 34px 20px 34px;
  border-radius: 13px;
  min-width: 230px;
  max-width: 80vw;
  box-shadow: 0 8px 40px rgba(179, 165, 255, 0.27);
  text-align: center;
}
#dialog-msg {
  font-size: 17px;
  margin-bottom: 20px;
}
.dialog-btn {
  background: #fff;
  color: #8066e1;
  border: 1.5px solid #8066e1;
  border-radius: 8px;
  padding: 6px 19px;
  font-size: 15px;
  cursor: pointer;
  font-weight: 500;
  transition: .2s;
}
.dialog-btn:hover {
  background: #f5f0fa;
}

/* äº¤æ¢ä½ç½®æŒ‰é’® */
.swap-button {
  position: absolute;
  left: 20px;
  bottom: 20px;
  width: 45px;
  height: 45px;
  border-radius: 50%;
  background: #fff;
  color: #8066e1;
  border: 2px solid #ece6fd;
  box-shadow: 0 2px 10px rgba(199, 187, 250, 0.4);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  cursor: pointer;
  z-index: 200;
  transition: all 0.2s;
}

.swap-button:hover {
  background: #ede7fb;
  transform: scale(1.1);
  box-shadow: 0 4px 15px rgba(199, 187, 250, 0.5);
}

.swap-button .swap-tooltip {
  position: absolute;
  left: 110%;
  top: 50%;
  transform: translateY(-50%);
  background: #fff;
  color: #8066e1;
  border-radius: 6px;
  font-size: 13px;
  padding: 4px 10px;
  box-shadow: 0 2px 8px rgba(199, 187, 250, 0.2);
  white-space: nowrap;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.2s;
}

.swap-button:hover .swap-tooltip {
  opacity: 1;
}

/* è‡ªå®šä¹‰å¿«æ·é”®è®¾ç½® */
#shortcut-settings {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: #fff;
  border-radius: 16px;
  box-shadow: 0 8px 40px rgba(179, 165, 255, 0.27);
  padding: 25px;
  width: 500px;
  max-width: 90vw;
  z-index: 1000;
  display: none;
}

#shortcut-settings h2 {
  font-size: 20px;
  color: #333;
  margin-bottom: 20px;
  text-align: center;
}

.shortcut-list {
  display: flex;
  flex-direction: column;
  gap: 15px;
  margin-bottom: 20px;
}

.shortcut-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 15px;
  background: #f8f9fa;
  border-radius: 8px;
  transition: all 0.2s;
}

.shortcut-item:hover {
  background: #f1f3f5;
}

.shortcut-action {
  font-size: 15px;
  color: #333;
}

.shortcut-key {
  display: flex;
  align-items: center;
  gap: 5px;
}

.shortcut-key-input {
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 4px;
  padding: 5px 10px;
  font-family: monospace;
  font-size: 14px;
  width: 120px;
  outline: none;
}

.shortcut-key button {
  background: #8066e1;
  color: #fff;
  border: none;
  border-radius: 4px;
  padding: 5px 10px;
  font-size: 13px;
  cursor: pointer;
  transition: all 0.2s;
}

.shortcut-key button:hover {
  background: #6c5ce7;
}

.shortcut-settings-buttons {
  display: flex;
  justify-content: center;
  gap: 15px;
  margin-top: 20px;
}

.shortcut-settings-btn {
  padding: 8px 20px;
  border-radius: 8px;
  font-size: 15px;
  cursor: pointer;
  transition: all 0.2s;
}

.shortcut-settings-btn.save {
  background: #8066e1;
  color: #fff;
  border: none;
}

.shortcut-settings-btn.save:hover {
  background: #6c5ce7;
}

.shortcut-settings-btn.cancel {
  background: #fff;
  color: #333;
  border: 1px solid #ddd;
}

.shortcut-settings-btn.cancel:hover {
  background: #f5f5f5;
}

.shortcut-settings-btn.reset {
  background: #fff;
  color: #e74c3c;
  border: 1px solid #e74c3c;
}

.shortcut-settings-btn.reset:hover {
  background: #fef5f5;
}

/* æ’¤é”€é‡åšæŒ‰é’® */
.history-buttons {
  position: absolute;
  top: 76px;
  right: 24px;
  display: flex;
  gap: 10px;
  z-index: 100;
}

.history-btn {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: #fff;
  color: #8066e1;
  border: 2px solid #ece6fd;
  box-shadow: 0 2px 10px rgba(199, 187, 250, 0.2);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  cursor: pointer;
  transition: all 0.2s;
}

.history-btn:hover {
  background: #ede7fb;
  transform: scale(1.05);
}

.history-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
  background: #f5f5f5;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 1024px) {
  .app-container {
    flex-direction: column;
  }
  .search-section {
    width: 100%;
    height: 40vh;
    min-height: 300px;
    margin-bottom: 20px;
  }
  .mindmap-section {
    height: calc(60vh - 40px);
  }
  #color-bar {
    left: 50%;
  }
  .shortcutbar {
    left: 50%;
  }
  .swap-button {
    left: 20px;
    bottom: 20px;
  }
}

@media (max-width: 768px) {
  body {
    padding: 10px;
  }
  .app-container {
    width: calc(100vw - 20px);
    height: calc(100vh - 20px);
    gap: 10px;
  }
  .search-engines {
    gap: 15px;
  }
  .search-buttons {
    flex-direction: column;
    gap: 10px;
  }
  #color-bar {
    width: 90%;
    max-width: 90%;
    padding: 5px 10px;
  }
  .shortcutbar {
    width: 90%;
    max-width: 90%;
    padding: 5px 10px;
    font-size: 11px;
  }
  .shortcutbar kbd {
    padding: 1px 4px;
    font-size: 11px;
  }
  .mindmap-fab-wrap {
    right: 10px;
    bottom: 20px;
  }
  .mindmap-fab-btn {
    width: 40px;
    height: 40px;
  }
}
</style>
</head>
<body>
<div class="app-container">
<!-- å·¦ä¾§æœç´¢å¼•æ“åŒºåŸŸ -->
<section class="search-section window" id="search-section">
  <div class="search-header">
    <div class="search-logo">S</div>
    <h1 class="search-title">æœç´¢å¼•æ“</h1>
  </div>
  
  <div class="search-container">
    <div class="search-box">
      <span class="search-icon">ğŸ”</span>
      <input type="text" id="search-input" class="search-input" placeholder="è¾“å…¥å…³é”®è¯æœç´¢..." />
    </div>
    
    <div class="search-buttons">
      <button class="search-btn" id="search-btn">æœç´¢</button>
      <button class="search-btn secondary" id="lucky-btn">æ‰‹æ°”ä¸é”™</button>
    </div>
    
    <div class="search-engines">
      <div class="engine-option active" data-engine="google">
        <img src="https://www.google.com/favicon.ico" alt="Google" class="engine-icon">
        <span class="engine-name">Google</span>
      </div>
      <div class="engine-option" data-engine="baidu">
        <img src="https://www.baidu.com/favicon.ico" alt="ç™¾åº¦" class="engine-icon">
        <span class="engine-name">ç™¾åº¦</span>
      </div>
      <div class="engine-option" data-engine="bing">
        <img src="https://www.bing.com/favicon.ico" alt="Bing" class="engine-icon">
        <span class="engine-name">Bing</span>
      </div>
      <div class="engine-option" data-engine="duckduckgo">
        <img src="https://duckduckgo.com/favicon.ico" alt="DuckDuckGo" class="engine-icon">
        <span class="engine-name">DuckDuckGo</span>
      </div>
    </div>
  </div>
  
  <div class="search-results-container">
    <div class="search-results" id="search-results">
      <h3 class="search-results-title">åœ¨æ­¤å¤„æ˜¾ç¤ºæœç´¢ç»“æœ</h3>
      <p style="color: #666; text-align: center; margin-top: 30px;">è¾“å…¥å…³é”®è¯å¹¶ç‚¹å‡»æœç´¢æŒ‰é’®</p>
    </div>
    
    <div class="search-pagination" id="search-pagination" style="display: none;">
      <button class="page-btn" id="prev-page">â—€</button>
      <button class="page-btn active">1</button>
      <button class="page-btn">2</button>
      <button class="page-btn">3</button>
      <button class="page-btn">4</button>
      <button class="page-btn">5</button>
      <button class="page-btn" id="next-page">â–¶</button>
    </div>
  </div>
  
  <div class="search-history">
    <h3 class="history-title">æœç´¢å†å²</h3>
    <div class="history-list" id="history-list">
      <!-- æœç´¢å†å²å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
    </div>
  </div>
</section>

<!-- å³ä¾§æ€ç»´å¯¼å›¾åŒºåŸŸ -->
<section class="mindmap-section window" id="mindmap-section">
  <div id="toolbar">
    <span class="logo">M</span>
    <span class="title">æ€ç»´å¯¼å›¾</span>
    <button class="btn add" id="btn-addroot" onclick="addRoot()">+ æ·»åŠ ä¸­å¿ƒä¸»é¢˜</button>
    <button class="btn" onclick="onNewMap()">âŸ³ æ–°å»º</button>
    <button class="btn" onclick="saveCloud()">â˜ï¸ çº¿ä¸Šä¿å­˜</button>
    <button class="btn" onclick="showSidebar()">ğŸ“ åŠ è½½</button>
    <button class="btn" onclick="showShortcutSettings()">âŒ¨ï¸ å¿«æ·é”®è®¾ç½®</button>
    <div class="user-info" id="user-info">
      <button class="btn" id="login-btn" onclick="googleLogin()">Googleç™»å½•</button>
    </div>
  </div>
  
  <div id="color-bar"></div>
  <div id="mindmap-container">
    <div id="mindmap"></div>
  </div>
  
  <!-- æ’¤é”€é‡åšæŒ‰é’® -->
  <div class="history-buttons">
    <button class="history-btn" id="undo-btn" title="æ’¤é”€" disabled>â†©</button>
    <button class="history-btn" id="redo-btn" title="é‡åš" disabled>â†ª</button>
  </div>
  
  <!-- æµ®åŠ¨æŒ‰é’® -->
  <div class="mindmap-fab-wrap">
    <button class="mindmap-fab-btn" onclick="zoomIn()" title="æ”¾å¤§">
      <svg width="25" height="25" viewBox="0 0 20 20"><circle cx="10" cy="10" r="9" fill="#fff" stroke="#8066e1" stroke-width="1.4"/><rect x="9" y="5" width="2" height="10" rx="1" fill="#8066e1"/><rect x="5" y="9" width="10" height="2" rx="1" fill="#8066e1"/></svg>
      <span class="fab-tooltip">æ”¾å¤§ (Ctrl + é¼ æ ‡æ»šè½® â†‘)</span>
    </button>
    <button class="mindmap-fab-btn" onclick="zoomOut()" title="ç¼©å°">
      <svg width="25" height="25" viewBox="0 0 20 20"><circle cx="10" cy="10" r="9" fill="#fff" stroke="#8066e1" stroke-width="1.4"/><rect x="5" y="9" width="10" height="2" rx="1" fill="#8066e1"/></svg>
      <span class="fab-tooltip">ç¼©å° (Ctrl + é¼ æ ‡æ»šè½® â†“)</span>
    </button>
    <button class="mindmap-fab-btn" onclick="zoomReset()" title="è¿˜åŸ">
      <svg width="25" height="25" viewBox="0 0 20 20"><circle cx="10" cy="10" r="9" fill="#fff" stroke="#8066e1" stroke-width="1.4"/><path d="M10 5v5l3 3" stroke="#8066e1" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round" fill="none"/><circle cx="10" cy="10" r="2.1" fill="none" stroke="#8066e1" stroke-width="1.1"/></svg>
      <span class="fab-tooltip">è¿˜åŸç¼©æ”¾</span>
    </button>
  </div>
  
  <!-- å¿«æ·é”®æç¤º -->
  <div class="shortcutbar" id="shortcutbar">
    <span>å¿«æ·é”®ï¼š<kbd>H</kbd> æ˜¾ç¤º/éšè—æœ¬æ </span>
    <span><kbd>Enter</kbd> æ·»åŠ å­èŠ‚ç‚¹</span>
    <span><kbd>Alt</kbd>+<kbd>Alt</kbd> ç¼–è¾‘èŠ‚ç‚¹</span>
    <span><kbd>Backspace</kbd> åˆ é™¤èŠ‚ç‚¹</span>
    <span><kbd>Ctrl</kbd>+<kbd>S</kbd> ä¿å­˜å¯¼å›¾</span>
    <span><kbd>Escape</kbd> å…³é—­ä¾§æ /å¯¹è¯æ¡†</span>
    <span><kbd>Ctrl</kbd>+<kbd>Z</kbd> æ’¤é”€</span>
    <span><kbd>Ctrl</kbd>+<kbd>Y</kbd> é‡åš</span>
    <span><kbd>Ctrl</kbd>+<kbd>F</kbd> æŠ˜å /å±•å¼€èŠ‚ç‚¹</span>
    <span>åŒå‡»èŠ‚ç‚¹ï¼šç¼–è¾‘èŠ‚ç‚¹</span>
    <span>ç‚¹å‡»èŠ‚ç‚¹ï¼šé€‰ä¸­èŠ‚ç‚¹</span>
    <span>ğŸŒ± æ˜¥èŠ½ç»¿ä¸»é¢˜</span>
    <button id="toggleShortcuts" title="éšè—å¿«æ·é”®æç¤º">â¯ˆ</button>
  </div>
  </div>
</section>

<!-- äº¤æ¢ä½ç½®æŒ‰é’® -->
<button class="swap-button" id="swap-button">
  â‡„
  <span class="swap-tooltip">äº¤æ¢ä½ç½®</span>
</button>
</div>

<!-- ä¾§è¾¹æ å’Œé®ç½© -->
<div id="sidebar-mask"></div>
<div id="sidebar">
<h3>æˆ‘çš„çº¿ä¸Šå¯¼å›¾</h3>
<div class="thumb-list" id="thumb-list"></div>
</div>

<!-- æ–‡ä»¶ä¸Šä¼  -->
<input id="img-upload" type="file" accept="image/*">

<!-- å¯¹è¯æ¡† -->
<div id="overlay">
<div id="dialog">
  <div id="dialog-msg">æ˜¯å¦ä¿å­˜å½“å‰ç”»å¸ƒï¼Ÿ</div>
  <button class="dialog-btn" id="dialog-save-btn" style="margin-right:12px;">ä¿å­˜</button>
  <button class="dialog-btn" onclick="hideDialog()">å–æ¶ˆ</button>
</div>
</div>

<!-- å¿«æ·é”®è®¾ç½®å¯¹è¯æ¡† -->
<div id="shortcut-settings">
  <h2>è‡ªå®šä¹‰å¿«æ·é”®è®¾ç½®</h2>
  <div class="shortcut-list" id="shortcut-list">
    <!-- å¿«æ·é”®è®¾ç½®é¡¹å°†åŠ¨æ€ç”Ÿæˆ -->
  </div>
  <div class="shortcut-settings-buttons">
    <button class="shortcut-settings-btn save" id="save-shortcuts">ä¿å­˜è®¾ç½®</button>
    <button class="shortcut-settings-btn reset" id="reset-shortcuts">æ¢å¤é»˜è®¤</button>
    <button class="shortcut-settings-btn cancel" id="cancel-shortcuts">å–æ¶ˆ</button>
  </div>
</div>

<script>
// ==== Firebase é…ç½® ====
const firebaseConfig = {
  apiKey: "AIzaSyCcsz9Lg3KmgvD_SXUdy4V5x7aCQtSdI-s",
  authDomain: "webs-d0804.firebaseapp.com",
  databaseURL: "https://webs-d0804-default-rtdb.firebaseio.com",
  projectId: "webs-d0804",
  storageBucket: "webs-d0804.firebasestorage.app",
  messagingSenderId: "195195304680",
  appId: "1:195195304680:web:01c68159689678c7f4275d",
  measurementId: "G-RRQ7RFHV76"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

// ==== å¿«æ·é”®è®¾ç½® ====
// é»˜è®¤å¿«æ·é”®é…ç½®
const DEFAULT_SHORTCUTS = {
  addChild: { key: 'Enter', description: 'æ·»åŠ å­èŠ‚ç‚¹' },
  editNode: { key: 'Space', description: 'ç¼–è¾‘èŠ‚ç‚¹' },
  deleteNode: { key: 'Backspace', description: 'åˆ é™¤èŠ‚ç‚¹' },
  saveMap: { key: 'ctrl+s', description: 'ä¿å­˜å¯¼å›¾' },
  closeDialog: { key: 'Escape', description: 'å…³é—­ä¾§æ /å¯¹è¯æ¡†' },
  undo: { key: 'ctrl+z', description: 'æ’¤é”€' },
  redo: { key: 'ctrl+y', description: 'é‡åš' },
  foldNode: { key: 'ctrl+f', description: 'æŠ˜å /å±•å¼€èŠ‚ç‚¹' }
};

// å½“å‰å¿«æ·é”®é…ç½®
let currentShortcuts = JSON.parse(localStorage.getItem('mindmapShortcuts')) || JSON.parse(JSON.stringify(DEFAULT_SHORTCUTS));

// æ¤ç‰©ä¸»é¢˜é…ç½®
const PLANT_THEMES = [
  { name: 'æ˜¥èŠ½ç»¿', class: 'plant-theme-green', icon: 'ğŸŒ±', color: 1 },
  { name: 'ç§‹å¶æ©™', class: 'plant-theme-autumn', icon: 'ğŸ‚', color: 0 },
  { name: 'èŠ±ç“£ç²‰', class: 'plant-theme-blossom', icon: 'ğŸŒ¸', color: 4 },
  { name: 'é›¨æ—è“', class: 'plant-theme-forest', icon: 'ğŸŒ¿', color: 7 },
  { name: 'ä¸›æ—ç»¿', class: 'plant-theme-jungle', icon: 'ğŸŒ´', color: 6 }
];

// å½“å‰ä¸»é¢˜
let currentTheme = PLANT_THEMES[0];

// æ˜¾ç¤ºå¿«æ·é”®è®¾ç½®å¯¹è¯æ¡†
function showShortcutSettings() {
  const shortcutList = document.getElementById('shortcut-list');
  shortcutList.innerHTML = '';
  
  // ä¸ºæ¯ä¸ªå¿«æ·é”®åˆ›å»ºè®¾ç½®é¡¹
  Object.entries(currentShortcuts).forEach(([action, config]) => {
    const item = document.createElement('div');
    item.className = 'shortcut-item';
    
    const actionSpan = document.createElement('span');
    actionSpan.className = 'shortcut-action';
    actionSpan.textContent = config.description;
    
    const keyDiv = document.createElement('div');
    keyDiv.className = 'shortcut-key';
    
    const keyInput = document.createElement('input');
    keyInput.className = 'shortcut-key-input';
    keyInput.value = config.key;
    keyInput.readOnly = true;
    keyInput.dataset.action = action;
    
    const setBtn = document.createElement('button');
    setBtn.textContent = 'è®¾ç½®';
    setBtn.onclick = function() {
      startRecordingShortcut(keyInput);
    };
    
    keyDiv.appendChild(keyInput);
    keyDiv.appendChild(setBtn);
    
    item.appendChild(actionSpan);
    item.appendChild(keyDiv);
    
    shortcutList.appendChild(item);
  });
  
  document.getElementById('shortcut-settings').style.display = 'block';
  document.getElementById('sidebar-mask').style.display = 'block';
}

// å¼€å§‹è®°å½•å¿«æ·é”®
function startRecordingShortcut(inputElement) {
  inputElement.value = 'æŒ‰ä¸‹å¿«æ·é”®...';
  inputElement.style.backgroundColor = '#fffde6';
  
  const keyHandler = function(e) {
    e.preventDefault();
    
    let shortcut = '';
    if (e.ctrlKey) shortcut += 'ctrl+';
    if (e.altKey) shortcut += 'alt+';
    if (e.shiftKey) shortcut += 'shift+';
    
    // ç‰¹æ®Šé”®å¤„ç†
    if (e.key === ' ') {
      shortcut += 'Space';
    } else if (e.key === 'Escape' || e.key === 'Backspace' || e.key === 'Enter' || 
               e.key === 'ArrowUp' || e.key === 'ArrowDown' || e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
      shortcut += e.key;
    } else {
      shortcut += e.key.toLowerCase();
    }
    
    inputElement.value = shortcut;
    inputElement.style.backgroundColor = '#fff';
    
    // ç§»é™¤äº‹ä»¶ç›‘å¬å™¨
    document.removeEventListener('keydown', keyHandler);
  };
  
  document.addEventListener('keydown', keyHandler);
}

// ä¿å­˜å¿«æ·é”®è®¾ç½®
document.getElementById('save-shortcuts').addEventListener('click', function() {
  const inputs = document.querySelectorAll('.shortcut-key-input');
  
  inputs.forEach(input => {
    const action = input.dataset.action;
    currentShortcuts[action].key = input.value;
  });
  
  localStorage.setItem('mindmapShortcuts', JSON.stringify(currentShortcuts));
  hideShortcutSettings();
  updateShortcutBar();
});

// é‡ç½®å¿«æ·é”®è®¾ç½®
document.getElementById('reset-shortcuts').addEventListener('click', function() {
  if (confirm('ç¡®å®šè¦æ¢å¤é»˜è®¤å¿«æ·é”®è®¾ç½®å—ï¼Ÿ')) {
    currentShortcuts = JSON.parse(JSON.stringify(DEFAULT_SHORTCUTS));
    localStorage.setItem('mindmapShortcuts', JSON.stringify(currentShortcuts));
    hideShortcutSettings();
    updateShortcutBar();
  }
});

// å–æ¶ˆå¿«æ·é”®è®¾ç½®
document.getElementById('cancel-shortcuts').addEventListener('click', hideShortcutSettings);

// éšè—å¿«æ·é”®è®¾ç½®å¯¹è¯æ¡†
function hideShortcutSettings() {
  document.getElementById('shortcut-settings').style.display = 'none';
  document.getElementById('sidebar-mask').style.display = 'none';
}

// æ›´æ–°å¿«æ·é”®æç¤ºæ 
function updateShortcutBar() {
  const shortcutbar = document.getElementById('shortcutbar');
  shortcutbar.innerHTML = '<b>ğŸ‰</b>';
  
  Object.entries(currentShortcuts).forEach(([action, config]) => {
    const shortcutSpan = document.createElement('span');
    
    const kbdElement = document.createElement('kbd');
    kbdElement.textContent = config.key;
    
    shortcutSpan.appendChild(kbdElement);
    shortcutSpan.appendChild(document.createTextNode(' ' + config.description));
    
    shortcutbar.appendChild(shortcutSpan);
  });
  
  // æ·»åŠ å…¶ä»–æç¤º
  const dblClickSpan = document.createElement('span');
  dblClickSpan.innerHTML = '<kbd>åŒå‡»èŠ‚ç‚¹</kbd> ç¼–è¾‘èŠ‚ç‚¹';
  shortcutbar.appendChild(dblClickSpan);
  
  const clickSpan = document.createElement('span');
  clickSpan.innerHTML = '<kbd>ç‚¹å‡»èŠ‚ç‚¹</kbd> é€‰ä¸­èŠ‚ç‚¹';
  shortcutbar.appendChild(clickSpan);

  // æ·»åŠ æ¤ç‰©ä¸»é¢˜å›¾æ ‡
  shortcutbar.innerHTML += `<span><kbd>${currentTheme.icon}</kbd> ${currentTheme.name}ä¸»é¢˜</span>`;
  
  // æ·»åŠ åˆ‡æ¢æŒ‰é’®
  const toggleBtn = document.createElement('button');
  toggleBtn.id = 'toggle-shortcuts';
  toggleBtn.className = 'toggle-btn';
  toggleBtn.textContent = 'â¯‡';
  toggleBtn.title = 'éšè—/æ˜¾ç¤ºå¿«æ·é”®æç¤º';
  shortcutbar.appendChild(toggleBtn);
  
  // ç»‘å®šåˆ‡æ¢æŒ‰é’®äº‹ä»¶
  toggleBtn.addEventListener('click', toggleShortcutBar);
}

// åˆ‡æ¢å¿«æ·é”®æ æ˜¾ç¤º/éšè—
function toggleShortcutBar() {
  const shortcutbar = document.getElementById('shortcutbar');
  shortcutbar.classList.toggle('collapsed');
  
  // æ›´æ–°æŒ‰é’®æ–‡æœ¬
  const toggleBtn = document.getElementById('toggle-shortcuts');
  if (shortcutbar.classList.contains('collapsed')) {
    toggleBtn.textContent = '';
    toggleBtn.title = 'æ˜¾ç¤ºå¿«æ·é”®æç¤º';
    localStorage.setItem('shortcutbarCollapsed', 'true');
  } else {
    toggleBtn.textContent = 'â¯‡';
    toggleBtn.title = 'éšè—å¿«æ·é”®æç¤º';
    localStorage.setItem('shortcutbarCollapsed', 'false');
  }
}

// ä»æœ¬åœ°å­˜å‚¨åŠ è½½å¿«æ·é”®æ çŠ¶æ€
function loadShortcutbarState() {
  const isCollapsed = localStorage.getItem('shortcutbarCollapsed') === 'true';
  if (isCollapsed) {
    const shortcutbar = document.getElementById('shortcutbar');
    shortcutbar.classList.add('collapsed');
    const toggleBtn = document.getElementById('toggle-shortcuts');
    if (toggleBtn) {
      toggleBtn.textContent = 'ğŸ†';
      toggleBtn.title = 'æ˜¾ç¤ºå¿«æ·é”®æç¤º';
    }
  }
}

// ==== æœç´¢å¼•æ“åŠŸèƒ½ ====
const searchInput = document.getElementById('search-input');
const searchBtn = document.getElementById('search-btn');
const luckyBtn = document.getElementById('lucky-btn');
const historyList = document.getElementById('history-list');
const engineOptions = document.querySelectorAll('.engine-option');
const searchResults = document.getElementById('search-results');
const searchPagination = document.getElementById('search-pagination');
const prevPageBtn = document.getElementById('prev-page');
const nextPageBtn = document.getElementById('next-page');

// å½“å‰é€‰æ‹©çš„æœç´¢å¼•æ“
let currentEngine = 'google';

// æœç´¢å†å²
let searchHistory = JSON.parse(localStorage.getItem('searchHistory') || '[]');

// æœç´¢ç»“æœå’Œåˆ†é¡µ
let currentSearchResults = [];
let currentPage = 1;
let resultsPerPage = 5;
let totalPages = 1;

// æ¸²æŸ“æœç´¢å†å²
function renderSearchHistory() {
  historyList.innerHTML = '';
  
  // åªæ˜¾ç¤ºæœ€è¿‘10æ¡å†å²è®°å½•
  const recentHistory = searchHistory.slice(0, 10);
  
  recentHistory.forEach(term => {
    const historyItem = document.createElement('div');
    historyItem.className = 'history-item';
    historyItem.textContent = term;
    historyItem.addEventListener('click', () => {
      searchInput.value = term;
      performSearch();
    });
    historyList.appendChild(historyItem);
  });
  
  // å¦‚æœæ²¡æœ‰å†å²è®°å½•ï¼Œæ˜¾ç¤ºæç¤º
  if (recentHistory.length === 0) {
    historyList.innerHTML = '<div style="color:#999;font-size:13px;">æš‚æ— æœç´¢å†å²</div>';
  }
}

// æ·»åŠ æœç´¢å†å²
function addToHistory(term) {
  // å¦‚æœå·²å­˜åœ¨ï¼Œå…ˆç§»é™¤
  searchHistory = searchHistory.filter(item => item !== term);
  
  // æ·»åŠ åˆ°å¼€å¤´
  searchHistory.unshift(term);
  
  // é™åˆ¶å†å²è®°å½•æ•°é‡
  if (searchHistory.length > 20) {
    searchHistory = searchHistory.slice(0, 20);
  }
  
  // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
  localStorage.setItem('searchHistory', JSON.stringify(searchHistory));
  
  // é‡æ–°æ¸²æŸ“å†å²è®°å½•
  renderSearchHistory();
}

// æ‰§è¡Œæœç´¢
function performSearch() {
  const query = searchInput.value.trim();
  
  if (!query) return;
  
  // æ·»åŠ åˆ°å†å²è®°å½•
  addToHistory(query);
  
  // æ˜¾ç¤ºåŠ è½½ä¸­
  searchResults.innerHTML = '<div style="text-align:center;padding:30px;"><div style="font-size:24px;margin-bottom:10px;">ğŸ”</div><p>æ­£åœ¨æœç´¢...</p></div>';
  
  // æ¨¡æ‹Ÿæœç´¢ç»“æœ
  setTimeout(() => {
    // ç”Ÿæˆæ¨¡æ‹Ÿæœç´¢ç»“æœ
    generateMockResults(query);
    
    // æ˜¾ç¤ºåˆ†é¡µ
    searchPagination.style.display = 'flex';
    
    // æ¸²æŸ“ç¬¬ä¸€é¡µç»“æœ
    currentPage = 1;
    renderSearchResultsPage();
  }, 800);
}

// ç”Ÿæˆæ¨¡æ‹Ÿæœç´¢ç»“æœ
function generateMockResults(query) {
  // æ¸…ç©ºå½“å‰ç»“æœ
  currentSearchResults = [];
  
  // æ ¹æ®ä¸åŒæœç´¢å¼•æ“ç”Ÿæˆä¸åŒçš„æ¨¡æ‹Ÿç»“æœ
  const resultCount = 25; // æ€»å…±ç”Ÿæˆ25ä¸ªç»“æœï¼Œåˆ†5é¡µæ˜¾ç¤º
  
  for (let i = 1; i <= resultCount; i++) {
    let result = {
      title: '',
      url: '',
      description: '',
      snippet: '',
      date: new Date().toISOString().split('T')[0],
      type: ['ç½‘é¡µ', 'æ–‡ç« ', 'åšå®¢', 'æ–°é—»', 'å­¦æœ¯'][Math.floor(Math.random() * 5)]
    };
    
    switch (currentEngine) {
      case 'google':
        result.title = `Google æœç´¢ç»“æœ #${i}: ${query}`;
        result.url = `https://example.com/google-result-${i}?q=${encodeURIComponent(query)}`;
        result.description = `è¿™æ˜¯å…³äº"${query}"çš„Googleæœç´¢ç»“æœç¤ºä¾‹ã€‚è¿™æ˜¯ç¬¬${i}ä¸ªç»“æœï¼ŒåŒ…å«äº†ç›¸å…³ä¿¡æ¯å’Œæè¿°ã€‚`;
        result.snippet = `...æ‰¾åˆ°äº†å¾ˆå¤šå…³äº"${query}"çš„ä¿¡æ¯ã€‚è¿™äº›ä¿¡æ¯å¯èƒ½å¯¹æ‚¨æœ‰æ‰€å¸®åŠ©ã€‚æ‚¨å¯ä»¥ç‚¹å‡»è¿›å…¥é¡µé¢æŸ¥çœ‹æ›´å¤šå†…å®¹...`;
        break;
      case 'baidu':
        result.title = `ç™¾åº¦æœç´¢ç»“æœ #${i}: ${query}`;
        result.url = `https://example.com/baidu-result-${i}?wd=${encodeURIComponent(query)}`;
        result.description = `è¿™æ˜¯å…³äº"${query}"çš„ç™¾åº¦æœç´¢ç»“æœç¤ºä¾‹ã€‚è¿™æ˜¯ç¬¬${i}ä¸ªç»“æœï¼ŒåŒ…å«äº†ç›¸å…³ä¿¡æ¯å’Œæè¿°ã€‚`;
        result.snippet = `...ç™¾åº¦ä¸ºæ‚¨æ‰¾åˆ°ç›¸å…³ç»“æœçº¦100,000ä¸ªã€‚"${query}"æœ‰å¾ˆå¤šç›¸å…³ä¿¡æ¯ï¼Œè¿™å¯èƒ½æ˜¯æ‚¨æ„Ÿå…´è¶£çš„å†…å®¹...`;
        break;
      case 'bing':
        result.title = `Bing æœç´¢ç»“æœ #${i}: ${query}`;
        result.url = `https://example.com/bing-result-${i}?q=${encodeURIComponent(query)}`;
        result.description = `è¿™æ˜¯å…³äº"${query}"çš„Bingæœç´¢ç»“æœç¤ºä¾‹ã€‚è¿™æ˜¯ç¬¬${i}ä¸ªç»“æœï¼ŒåŒ…å«äº†ç›¸å…³ä¿¡æ¯å’Œæè¿°ã€‚`;
        result.snippet = `...å¾®è½¯Bingä¸ºæ‚¨æä¾›"${query}"çš„å®ç”¨ä¿¡æ¯å’Œé“¾æ¥ã€‚è¿™äº›å†…å®¹ç»è¿‡ç²¾å¿ƒç­›é€‰ï¼Œå¸Œæœ›èƒ½æ»¡è¶³æ‚¨çš„éœ€æ±‚...`;
        break;
      case 'duckduckgo':
        result.title = `DuckDuckGo æœç´¢ç»“æœ #${i}: ${query}`;
        result.url = `https://example.com/duckduckgo-result-${i}?q=${encodeURIComponent(query)}`;
        result.description = `è¿™æ˜¯å…³äº"${query}"çš„DuckDuckGoæœç´¢ç»“æœç¤ºä¾‹ã€‚è¿™æ˜¯ç¬¬${i}ä¸ªç»“æœï¼ŒåŒ…å«äº†ç›¸å…³ä¿¡æ¯å’Œæè¿°ã€‚`;
        result.snippet = `...DuckDuckGoå°Šé‡æ‚¨çš„éšç§ï¼Œä¸ºæ‚¨æ‰¾åˆ°äº†å…³äº"${query}"çš„åŒ¿åç»“æœã€‚ç‚¹å‡»æŸ¥çœ‹æ›´å¤šå†…å®¹...`;
        break;
      default:
        result.title = `æœç´¢ç»“æœ #${i}: ${query}`;
        result.url = `https://example.com/result-${i}?q=${encodeURIComponent(query)}`;
        result.description = `è¿™æ˜¯å…³äº"${query}"çš„æœç´¢ç»“æœç¤ºä¾‹ã€‚è¿™æ˜¯ç¬¬${i}ä¸ªç»“æœï¼ŒåŒ…å«äº†ç›¸å…³ä¿¡æ¯å’Œæè¿°ã€‚`;
        result.snippet = `...è¿™æ˜¯ä¸€ä¸ªé€šç”¨çš„æœç´¢ç»“æœç‰‡æ®µï¼ŒåŒ…å«äº†ä¸€äº›å…³äº"${query}"çš„ä¿¡æ¯å’Œä¸Šä¸‹æ–‡...`;
    }
    
    currentSearchResults.push(result);
  }
  
  // è®¡ç®—æ€»é¡µæ•°
  totalPages = Math.ceil(currentSearchResults.length / resultsPerPage);
}

// æ¸²æŸ“æœç´¢ç»“æœé¡µ
function renderSearchResultsPage() {
  // è®¡ç®—å½“å‰é¡µçš„ç»“æœ
  const startIndex = (currentPage - 1) * resultsPerPage;
  const endIndex = Math.min(startIndex + resultsPerPage, currentSearchResults.length);
  const pageResults = currentSearchResults.slice(startIndex, endIndex);
  
  // æ¸…ç©ºç»“æœåŒºåŸŸ
  searchResults.innerHTML = '';
  
  // æ·»åŠ æ ‡é¢˜
  const title = document.createElement('h3');
  title.className = 'search-results-title';
  title.textContent = `æœç´¢ç»“æœ (ç¬¬ ${currentPage}/${totalPages} é¡µ)`;
  searchResults.appendChild(title);
  
  // æ·»åŠ ç»“æœé¡¹
  if (pageResults.length === 0) {
    const noResults = document.createElement('p');
    noResults.style.textAlign = 'center';
    noResults.style.padding = '30px';
    noResults.textContent = 'æ²¡æœ‰æ‰¾åˆ°ç›¸å…³ç»“æœ';
    searchResults.appendChild(noResults);
  } else {
    pageResults.forEach(result => {
      const resultItem = document.createElement('div');
      resultItem.className = 'search-result-item';
      
      const resultTitle = document.createElement('div');
      resultTitle.className = 'result-title';
      resultTitle.textContent = result.title;
      
      const resultUrl = document.createElement('div');
      resultUrl.className = 'result-url';
      resultUrl.textContent = result.url;
      
      const resultDescription = document.createElement('div');
      resultDescription.className = 'result-description';
      resultDescription.textContent = result.description;
      
      const resultSnippet = document.createElement('div');
      resultSnippet.className = 'result-snippet';
      resultSnippet.textContent = result.snippet;
      
      const resultMeta = document.createElement('div');
      resultMeta.className = 'result-meta';
      resultMeta.innerHTML = `
        <span>ğŸ“… ${result.date}</span>
        <span>ğŸ“„ ${result.type}</span>
      `;
      
      resultItem.appendChild(resultTitle);
      resultItem.appendChild(resultUrl);
      resultItem.appendChild(resultDescription);
      resultItem.appendChild(resultSnippet);
      resultItem.appendChild(resultMeta);
      
      // ç‚¹å‡»ç»“æœé¡¹åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€
      resultItem.addEventListener('click', () => {
        window.open(result.url, '_blank');
      });
      
      searchResults.appendChild(resultItem);
    });
  }
  
  // æ›´æ–°åˆ†é¡µæŒ‰é’®
  updatePaginationButtons();
}

// æ›´æ–°åˆ†é¡µæŒ‰é’®
function updatePaginationButtons() {
  // æ¸…ç©ºç°æœ‰çš„é¡µç æŒ‰é’®
  const pageButtons = searchPagination.querySelectorAll('.page-btn:not(#prev-page):not(#next-page)');
  pageButtons.forEach(btn => btn.remove());
  
  // ç¡®å®šè¦æ˜¾ç¤ºçš„é¡µç èŒƒå›´
  let startPage = Math.max(1, currentPage - 2);
  let endPage = Math.min(totalPages, startPage + 4);
  
  // å¦‚æœé¡µç ä¸è¶³5ä¸ªï¼Œè°ƒæ•´èµ·å§‹é¡µ
  if (endPage - startPage < 4) {
    startPage = Math.max(1, endPage - 4);
  }
  
  // æ·»åŠ é¡µç æŒ‰é’®
  for (let i = startPage; i <= endPage; i++) {
    const pageBtn = document.createElement('button');
    pageBtn.className = 'page-btn' + (i === currentPage ? ' active' : '');
    pageBtn.textContent = i;
    
    pageBtn.addEventListener('click', () => {
      if (i !== currentPage) {
        currentPage = i;
        renderSearchResultsPage();
      }
    });
    
    // æ’å…¥åˆ°ä¸‹ä¸€é¡µæŒ‰é’®ä¹‹å‰
    searchPagination.insertBefore(pageBtn, nextPageBtn);
  }
  
  // æ›´æ–°ä¸Šä¸€é¡µ/ä¸‹ä¸€é¡µæŒ‰é’®çŠ¶æ€
  prevPageBtn.classList.toggle('disabled', currentPage === 1);
  nextPageBtn.classList.toggle('disabled', currentPage === totalPages);
}

// ä¸Šä¸€é¡µ
prevPageBtn.addEventListener('click', () => {
  if (currentPage > 1) {
    currentPage--;
    renderSearchResultsPage();
    // æ»šåŠ¨åˆ°é¡¶éƒ¨
    searchResults.scrollTop = 0;
  }
});

// ä¸‹ä¸€é¡µ
nextPageBtn.addEventListener('click', () => {
  if (currentPage < totalPages) {
    currentPage++;
    renderSearchResultsPage();
    // æ»šåŠ¨åˆ°é¡¶éƒ¨
    searchResults.scrollTop = 0;
  }
});

// æ‰‹æ°”ä¸é”™åŠŸèƒ½
function feelingLucky() {
  const query = searchInput.value.trim();
  
  if (!query) return;
  
  // æ·»åŠ åˆ°å†å²è®°å½•
  addToHistory(query);
  
  // æ ¹æ®é€‰æ‹©çš„æœç´¢å¼•æ“æ„å»ºURL
  let luckyUrl;
  
  switch (currentEngine) {
    case 'google':
      luckyUrl = `https://www.google.com/search?q=${encodeURIComponent(query)}&btnI=I`;
      break;
    case 'baidu':
      luckyUrl = `https://www.baidu.com/s?wd=${encodeURIComponent(query)}`;
      break;
    case 'bing':
      luckyUrl = `https://www.bing.com/search?q=${encodeURIComponent(query)}&go=Search`;
      break;
    case 'duckduckgo':
      luckyUrl = `https://duckduckgo.com/?q=\\${encodeURIComponent(query)}`;
      break;
    default:
      luckyUrl = `https://www.google.com/search?q=${encodeURIComponent(query)}&btnI=I`;
  }
  
  // åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€æœç´¢ç»“æœ
  window.open(luckyUrl, '_blank');
}

// åˆ‡æ¢æœç´¢å¼•æ“
engineOptions.forEach(option => {
  option.addEventListener('click', () => {
    // ç§»é™¤æ‰€æœ‰activeç±»
    engineOptions.forEach(opt => opt.classList.remove('active'));
    
    // æ·»åŠ activeç±»åˆ°å½“å‰é€‰ä¸­çš„å¼•æ“
    option.classList.add('active');
    
    // æ›´æ–°å½“å‰å¼•æ“
    currentEngine = option.dataset.engine;
    
    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
    localStorage.setItem('currentEngine', currentEngine);
  });
});

// ä»æœ¬åœ°å­˜å‚¨åŠ è½½å½“å‰å¼•æ“
const savedEngine = localStorage.getItem('currentEngine');
if (savedEngine) {
  currentEngine = savedEngine;
  
  // æ›´æ–°UI
  engineOptions.forEach(option => {
    if (option.dataset.engine === currentEngine) {
      option.classList.add('active');
    } else {
      option.classList.remove('active');
    }
  });
}

// æœç´¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶
searchBtn.addEventListener('click', performSearch);

// æ‰‹æ°”ä¸é”™æŒ‰é’®ç‚¹å‡»äº‹ä»¶
luckyBtn.addEventListener('click', feelingLucky);

// è¾“å…¥æ¡†å›è½¦äº‹ä»¶
searchInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    performSearch();
  }
});

// åˆå§‹åŒ–æ¸²æŸ“æœç´¢å†å²
renderSearchHistory();

// ==== æ€ç»´å¯¼å›¾åŠŸèƒ½ ====
let currentUser = null;

// Google ç™»å½•
function googleLogin() {
  const provider = new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider)
    .then(result => {
      currentUser = result.user;
      renderUser();
      loadSidebarIfVisible && loadSidebarIfVisible();
    }).catch(e => alert('ç™»å½•å¤±è´¥: ' + e.message));
}

function logout() {
  auth.signOut().then(() => {
    currentUser = null;
    renderUser();
    render && render();
  });
}

// ç”¨æˆ·ä¿¡æ¯ UI
function renderUser() {
  const userInfo = document.getElementById('user-info');
  if (auth.currentUser) {
    userInfo.innerHTML =
      `<img class="avatar" src="${auth.currentUser.photoURL || ''}" alt=""/>`
      + `<span>${auth.currentUser.displayName || ''}</span>`
      + `<button class="btn" onclick="logout()">é€€å‡º</button>`;
  } else {
    userInfo.innerHTML = `<button class="btn" id="login-btn" onclick="googleLogin()">Googleç™»å½•</button>`;
  }
}
auth.onAuthStateChanged(user => {
  currentUser = user;
  renderUser();
  render && render();
  loadSidebarIfVisible && loadSidebarIfVisible();
});

// é¢œè‰²æ–¹æ¡ˆ
const COLOR_LIST = [
  { bg: "#fff", color: "#333", line: "#bfbefc" },
  { bg: "#ffe08b", color: "#654200", line: "#f4c24d" },
  { bg: "#d2f6e9", color: "#21797a", line: "#25b399" },
  { bg: "#c8e8ff", color: "#004e77", line: "#43a6e2" },
  { bg: "#f7c7c9", color: "#a2383b", line: "#e46d72" },
  { bg: "#f3e0ff", color: "#6c3596", line: "#b78be5" },
  { bg: "#e8eaf6", color: "#23265e", line: "#8b91e2" },
  { bg: "#e8f5e9", color: "#1b5e20", line: "#6fcf97" },
  { bg: "#fffde6", color: "#8c6c13", line: "#ffe08b" }
];

let nodes = [];
let idCounter = 1;
let selectedId = null;
let editingNodeId = null;
let scale = 1;
let offsetX = 0, offsetY = 0;
let draggingCanvas = false, dragStartX = 0, dragStartY = 0, dragOriX = 0, dragOriY = 0;
let highlightedNodeId = null;

// =============== ç½®é¡¶åŠŸèƒ½ç›¸å…³ ==================
// pinnedNodes: { [nodeId]: {x, y, colorIdx} }
let pinnedNodes = {};

// =============== æŠ˜å åŠŸèƒ½ç›¸å…³ ==================
// foldedNodes: { [nodeId]: true }
let foldedNodes = {};

// =============== æ’¤é”€é‡åšåŠŸèƒ½ç›¸å…³ ==================
const MAX_HISTORY = 50;
let history = [];
let historyIndex = -1;
let isPerformingUndoRedo = false;

// =============== å¤šä¸»é¢˜èŠ‚ç‚¹ç›¸å…³ ==================
// ç”¨äºå­˜å‚¨æ ¹èŠ‚ç‚¹IDåˆ—è¡¨
let rootNodes = [];

// æ·»åŠ å†å²è®°å½•
function addHistory() {
  if (isPerformingUndoRedo) return;
  
  // å¦‚æœå½“å‰ä¸æ˜¯æœ€æ–°çŠ¶æ€ï¼Œåˆ é™¤åé¢çš„å†å²
  if (historyIndex < history.length - 1) {
    history = history.slice(0, historyIndex + 1);
  }
  
  // ä¿å­˜å½“å‰çŠ¶æ€
  const state = {
    nodes: JSON.parse(JSON.stringify(nodes)),
    pinnedNodes: JSON.parse(JSON.stringify(pinnedNodes)),
    foldedNodes: JSON.parse(JSON.stringify(foldedNodes)),
    selectedId: selectedId,
    idCounter: idCounter,
    rootNodes: JSON.parse(JSON.stringify(rootNodes))
  };
  
  history.push(state);
  
  // é™åˆ¶å†å²è®°å½•æ•°é‡
  if (history.length > MAX_HISTORY) {
    history.shift();
  }
  
  historyIndex = history.length - 1;
  
  // æ›´æ–°æ’¤é”€é‡åšæŒ‰é’®çŠ¶æ€
  updateHistoryButtons();
}

// æ›´æ–°æ’¤é”€é‡åšæŒ‰é’®çŠ¶æ€
function updateHistoryButtons() {
  const undoBtn = document.getElementById('undo-btn');
  const redoBtn = document.getElementById('redo-btn');
  
  undoBtn.disabled = historyIndex < 0;
  redoBtn.disabled = historyIndex >= history.length - 1;
}

// æ’¤é”€
function undo() {
  if (historyIndex < 0) return;
  
  isPerformingUndoRedo = true;
  
  // åŠ è½½ä¸Šä¸€ä¸ªçŠ¶æ€
  const state = history[historyIndex];
  nodes = JSON.parse(JSON.stringify(state.nodes));
  pinnedNodes = JSON.parse(JSON.stringify(state.pinnedNodes));
  foldedNodes = JSON.parse(JSON.stringify(state.foldedNodes));
  selectedId = state.selectedId;
  idCounter = state.idCounter;
  rootNodes = state.rootNodes ? JSON.parse(JSON.stringify(state.rootNodes)) : [];
  
  historyIndex--;
  
  // æ›´æ–°UI
  render();
  
  isPerformingUndoRedo = false;
  
  // æ›´æ–°æ’¤é”€é‡åšæŒ‰é’®çŠ¶æ€
  updateHistoryButtons();
}

// é‡åš
function redo() {
  if (historyIndex >= history.length - 1) return;
  
  isPerformingUndoRedo = true;
  
  // åŠ è½½ä¸‹ä¸€ä¸ªçŠ¶æ€
  historyIndex++;
  const state = history[historyIndex];
  nodes = JSON.parse(JSON.stringify(state.nodes));
  pinnedNodes = JSON.parse(JSON.stringify(state.pinnedNodes));
  foldedNodes = JSON.parse(JSON.stringify(state.foldedNodes));
  selectedId = state.selectedId;
  idCounter = state.idCounter;
  rootNodes = state.rootNodes ? JSON.parse(JSON.stringify(state.rootNodes)) : [];
  
  // æ›´æ–°UI
  render();
  
  isPerformingUndoRedo = false;
  
  // æ›´æ–°æ’¤é”€é‡åšæŒ‰é’®çŠ¶æ€
  updateHistoryButtons();
}

// ç»‘å®šæ’¤é”€é‡åšæŒ‰é’®
document.getElementById('undo-btn').addEventListener('click', undo);
document.getElementById('redo-btn').addEventListener('click', redo);

// è·å–èŠ‚ç‚¹æ‰€å±çš„æ ¹èŠ‚ç‚¹
function getRootNodeId(nodeId) {
  let node = nodes.find(n => n.id === nodeId);
  if (!node) return null;
  
  // å¦‚æœæ˜¯æ ¹èŠ‚ç‚¹ï¼Œç›´æ¥è¿”å›
  if (node.parent === null) return node.id;
  
  // å¦åˆ™é€’å½’æŸ¥æ‰¾çˆ¶èŠ‚ç‚¹
  return getRootNodeId(node.parent);
}

// è‡ªé€‚åº”æ’åºå’Œé¿å…èŠ‚ç‚¹é‡å 
function findOptimalPosition(parentId) {
  const parent = nodes.find(n => n.id === parentId);
  if (!parent) return { x: 0, y: 0 };
  
  // è·å–çˆ¶èŠ‚ç‚¹çš„æ‰€æœ‰å­èŠ‚ç‚¹
  const siblings = nodes.filter(n => n.parent === parentId && !foldedNodes[n.id]);
  
  // å¦‚æœæ²¡æœ‰å…„å¼ŸèŠ‚ç‚¹ï¼Œæ”¾åœ¨çˆ¶èŠ‚ç‚¹å³ä¾§
  if (siblings.length === 0) {
    return { x: parent.x + 180, y: parent.y };
  }
  
  // è®¡ç®—èŠ‚ç‚¹çš„å¤§è‡´å°ºå¯¸
  const nodeWidth = 120;
  const nodeHeight = 40;
  const nodeMargin = 20;
  
  // å°è¯•æ‰¾åˆ°ç©ºç™½åŒºåŸŸ
  const startX = parent.x + 180;
  let startY = parent.y - (siblings.length * (nodeHeight + nodeMargin)) / 2;
  
  // æ£€æŸ¥æ¯ä¸ªå¯èƒ½çš„ä½ç½®
  for (let i = 0; i < siblings.length + 1; i++) {
    const testY = startY + i * (nodeHeight + nodeMargin);
    let isOverlapping = false;
    
    // æ£€æŸ¥è¿™ä¸ªä½ç½®æ˜¯å¦ä¸ä»»ä½•ç°æœ‰èŠ‚ç‚¹é‡å 
    for (const node of nodes) {
      if (
        Math.abs(node.x - startX) < nodeWidth &&
        Math.abs(node.y - testY) < nodeHeight
      ) {
        isOverlapping = true;
        break;
      }
    }
    
    // å¦‚æœæ²¡æœ‰é‡å ï¼Œä½¿ç”¨è¿™ä¸ªä½ç½®
    if (!isOverlapping) {
      return { x: startX, y: testY };
    }
  }
  
  // å¦‚æœæ‰€æœ‰ä½ç½®éƒ½æœ‰é‡å ï¼Œå°è¯•åœ¨æœ€åä¸€ä¸ªå…„å¼ŸèŠ‚ç‚¹ä¸‹æ–¹æ”¾ç½®
  const lastSibling = siblings[siblings.length - 1];
  return { x: startX, y: lastSibling.y + nodeHeight + nodeMargin };
}

// æŠ˜å /å±•å¼€èŠ‚ç‚¹
function setFoldRecursively(nodeId, fold) {
  if (fold) {
    foldedNodes[nodeId] = true;
  } else {
    delete foldedNodes[nodeId];
  }
  // é€’å½’å¤„ç†æ‰€æœ‰å­èŠ‚ç‚¹
  nodes.filter(n => n.parent === nodeId).forEach(child => setFoldRecursively(child.id, fold));
}

function toggleFoldNode(nodeId) {
  const shouldFold = !foldedNodes[nodeId];
  setFoldRecursively(nodeId, shouldFold);
  
  // æ·»åŠ å†å²è®°å½•
  addHistory();
  
  // é‡æ–°æ¸²æŸ“
  render();
}

// æ¨ªå‘æ’å¸ƒå¹¶é¿å…é‡å çš„å¸ƒå±€é€»è¾‘, pinnedèŠ‚ç‚¹å›ºå®š
function layoutHorizontal() {
  if (!nodes.length) return;
  
  // ä¸ºæ¯ä¸ªæ ¹èŠ‚ç‚¹åˆ†é…ä¸€ä¸ªåŒºåŸŸ
  rootNodes.forEach((rootId, index) => {
    const root = nodes.find(n => n.id === rootId);
    if (!root) return;
    
    // å¦‚æœæ˜¯å›ºå®šèŠ‚ç‚¹ï¼Œä¸æ”¹å˜ä½ç½®
    if (pinnedNodes[rootId]) {
      root.x = pinnedNodes[rootId].x;
      root.y = pinnedNodes[rootId].y;
    } else {
      // æ ¹æ®ç´¢å¼•åˆ†é…ä½ç½®ï¼Œç¡®ä¿æ ¹èŠ‚ç‚¹ä¹‹é—´æœ‰è¶³å¤Ÿçš„é—´è·
      root.x = 300 + index * 500;
      root.y = 220;
    }
    
    // å¸ƒå±€è¯¥æ ¹èŠ‚ç‚¹çš„å­æ ‘
    layoutSubtree(root);
  });
}

// å¸ƒå±€å­æ ‘
function layoutSubtree(parent) {
  const gapX = 160, gapY = 80;
  
  // å¦‚æœèŠ‚ç‚¹è¢«æŠ˜å ï¼Œä¸æ˜¾ç¤ºå…¶å­èŠ‚ç‚¹
  if (foldedNodes[parent.id]) return;
  
  let children = nodes.filter(n => n.parent === parent.id);
  // ç½®é¡¶èŠ‚ç‚¹æ’åœ¨æœ€å‰
  children.sort((a, b) => {
    const aPinned = !!pinnedNodes[a.id];
    const bPinned = !!pinnedNodes[b.id];
    if(aPinned && !bPinned) return -1;
    if(!aPinned && bPinned) return 1;
    return a.id - b.id;
  });
  
  let startX = parent.x + gapX;
  let y = parent.y - Math.floor(gapY * (children.length - 1) / 2);
  
  children.forEach((child) => {
    if (pinnedNodes[child.id]) {
      // å›ºå®šä¸åŠ¨
      child.x = pinnedNodes[child.id].x;
      child.y = pinnedNodes[child.id].y;
      child.colorIdx = pinnedNodes[child.id].colorIdx;
    } else {
      child.x = startX;
      child.y = y;
    }
    
    // é€’å½’å¤„ç†å­èŠ‚ç‚¹
    layoutSubtree(child);
    
    // ä¸‹ä¸€ä¸ªå­èŠ‚ç‚¹çš„ä½ç½®
    y += gapY;
  });
}

// é¢œè‰²åŒæ­¥å¸¦ç½®é¡¶ä¿æŠ¤
function setColorCascade(nodeId, colorIdx) {
  const n = nodes.find(n => n.id === nodeId);
  if (!n) return;
  // è‹¥è¢«ç½®é¡¶ä¿æŠ¤ï¼Œä¸å¯æ›´æ”¹
  if (pinnedNodes[nodeId]) return;
  n.colorIdx = colorIdx;
  nodes.forEach(child => {
    if (child.parent === nodeId) {
      setColorCascade(child.id, colorIdx);
    }
  });
}

// =============== é¢œè‰²é€‰æ‹©æ  & ç½®é¡¶æŒ‰é’® ==================
function renderColorBar() {
  const colorBar = document.getElementById('color-bar');
  colorBar.innerHTML = '';
  let selectedNode = nodes.find(n => n.id === selectedId);
  let selColor = selectedNode && selectedNode.colorIdx !== undefined ? selectedNode.colorIdx : 0;
  
  // å¦‚æœæ²¡æœ‰é€‰ä¸­èŠ‚ç‚¹ï¼Œéšè—é¢œè‰²æ 
  if (!selectedNode) {
    colorBar.style.display = 'none';
    return;
  } else {
    colorBar.style.display = 'flex';
  }
  
  // ç½®é¡¶æŒ‰é’®
  let pinBtn = document.createElement('button');
  pinBtn.className = 'color-bar-top-btn' + (pinnedNodes[selectedId] ? ' pinned' : '');
  pinBtn.innerHTML = pinnedNodes[selectedId]
    ? '<svg width="17" height="17" fill="none" viewBox="0 0 17 17"><path d="M8.5 2.5v10M8.5 2.5l-3 3M8.5 2.5l3 3" stroke="#8066e1" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>'
    : '<svg width="17" height="17" fill="none" viewBox="0 0 17 17"><path d="M8.5 2.5v10M8.5 2.5l-3 3M8.5 2.5l3 3" stroke="#faad14" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>';
  pinBtn.title = pinnedNodes[selectedId] ? 'å·²å›ºå®š' : 'å›ºå®šæ­¤èŠ‚ç‚¹çš„ä½ç½®å’Œé¢œè‰²';
  pinBtn.onclick = function() {
    if(!selectedNode) return;
    if(pinnedNodes[selectedId]) {
      // å–æ¶ˆç½®é¡¶
      delete pinnedNodes[selectedId];
    } else {
      // è®°å½•å½“å‰åæ ‡å’Œé¢œè‰²
      pinnedNodes[selectedId] = {
        x: selectedNode.x,
        y: selectedNode.y,
        colorIdx: selectedNode.colorIdx
      };
    }
    
    // æ·»åŠ å†å²è®°å½•
    addHistory();
    
    layoutHorizontal();
    render();
    renderColorBar();
  };
  colorBar.appendChild(pinBtn);
  
  // æŠ˜å æŒ‰é’®
  if (nodes.some(n => n.parent === selectedId)) {
    let foldBtn = document.createElement('button');
    foldBtn.className = 'color-bar-top-btn' + (foldedNodes[selectedId] ? ' pinned' : '');
    foldBtn.innerHTML = foldedNodes[selectedId]
      ? '<svg width="17" height="17" fill="none" viewBox="0 0 17 17"><path d="M3 8.5h11M8.5 3v11" stroke="#8066e1" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>'
      : '<svg width="17" height="17" fill="none" viewBox="0 0 17 17"><path d="M3 8.5h11" stroke="#0288d1" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>';
    foldBtn.title = foldedNodes[selectedId] ? 'å±•å¼€å­èŠ‚ç‚¹' : 'æŠ˜å å­èŠ‚ç‚¹';
    foldBtn.onclick = function() {
      toggleFoldNode(selectedId);
    };
    colorBar.appendChild(foldBtn);
  }

  // é¢œè‰²é€‰é¡¹
  COLOR_LIST.forEach((c, i) => {
    let btn = document.createElement('div');
    btn.className = 'color-option' + (selColor === i ? ' selected' : '');
    btn.style.background = c.bg;
    btn.style.color = c.color;
    btn.title = 'åº”ç”¨æ­¤é¢œè‰²';
    if(selColor === i) btn.innerHTML = '<span class="tick">âœ”</span>';
    btn.onclick = function() {
      if(selectedNode) {
        // è‹¥è¢«ç½®é¡¶ä¿æŠ¤ï¼Œä¸å¯åˆ‡æ¢é¢œè‰²
        if(pinnedNodes[selectedId]) return;
        setColorCascade(selectedNode.id, i);
        
        // æ·»åŠ å†å²è®°å½•
        addHistory();
        
        layoutHorizontal();
        render();
        renderColorBar();
      }
    };
    colorBar.appendChild(btn);
  });
}

// ä¸»è¦DOMå…ƒç´ 
const mindmap = document.getElementById('mindmap');
const sidebar = document.getElementById('sidebar');
const thumbList = document.getElementById('thumb-list');
const btnAddRoot = document.getElementById('btn-addroot');
const imgUpload = document.getElementById('img-upload');

// æ¸²æŸ“æ€ç»´å¯¼å›¾
function render() {
  layoutHorizontal();
  mindmap.innerHTML = '';
  
  // æ˜¾ç¤ºæ·»åŠ æ ¹èŠ‚ç‚¹æŒ‰é’®
  btnAddRoot.style.display = '';
  btnAddRoot.textContent = nodes.length ? '+ æ·»åŠ æ–°ä¸»é¢˜' : '+ æ·»åŠ ä¸­å¿ƒä¸»é¢˜';
  
  // è¿çº¿
  nodes.forEach(n => {
    if (n.parent !== null && n.parent !== undefined) {
      let p = nodes.find(nn => nn.id === n.parent);
      // åªæœ‰å½“çˆ¶èŠ‚ç‚¹æ²¡æœ‰è¢«æŠ˜å æ—¶æ‰ç»˜åˆ¶è¿çº¿
      if (p && !foldedNodes[p.id]) {
        let lineColor = COLOR_LIST[p.colorIdx !== undefined ? p.colorIdx : (p.id === 1 ? 1 : 0)].line;
        drawLine(p, n, lineColor);
      }
    }
  });
  
  // èŠ‚ç‚¹
  nodes.forEach(n => {
    // å¦‚æœçˆ¶èŠ‚ç‚¹è¢«æŠ˜å ï¼Œä¸æ˜¾ç¤ºæ­¤èŠ‚ç‚¹
    const parent = n.parent !== null && n.parent !== undefined ? nodes.find(p => p.id === n.parent) : null;
    if (parent && foldedNodes[parent.id]) return;
    
    let div = document.createElement('div');
    div.className = 'node' + 
               (selectedId === n.id ? ' selected' : '') + 
               (n.parent === null ? ' root' : '') + 
               (highlightedNodeId === n.id ? ' highlight' : '') +
               (foldedNodes[n.id] && nodes.some(child => child.parent === n.id) ? ' folded-complete' : '');
    div.style.left = (n.x + offsetX) + 'px';
    div.style.top = (n.y + offsetY) + 'px';
    div.style.position = "absolute";
    div.style.fontSize = "15px";
    div.style.whiteSpace = "nowrap";
    div.style.flexDirection = "row";
    div.dataset.id = n.id;
    
    // é¢œè‰²
    let colorIdx = n.colorIdx !== undefined ? n.colorIdx : (n.parent === null ? 1 : 0);
    let cset = COLOR_LIST[colorIdx] || COLOR_LIST[0];
    div.style.background = cset.bg;
    div.style.color = cset.color;
    div.style.borderColor = cset.line;
    
    // é€‰ä¸­
    if (selectedId === n.id) {
      let outline = document.createElement('div');
      outline.className = "select-outline";
      div.appendChild(outline);
      div.style.zIndex = 11;
    }
    
    // ç¼–è¾‘æ¡†
    if (editingNodeId === n.id) {
      let input = document.createElement('input');
      input.value = n.text;
      input.onblur = function() { finishEdit(n, input.value); };
      input.onkeydown = function(e) {
        if (e.key === "Enter") input.blur();
        else if (e.key === "Escape") { editingNodeId = null; render(); }
      };
      setTimeout(() => { input.focus(); input.select(); }, 0);
      div.appendChild(input);
    } else {
      let txtspan = document.createElement('span');
      txtspan.textContent = n.text;
      div.appendChild(txtspan);
    }
    
    if (n.img) {
      let imgEl = document.createElement('img');
      imgEl.src = n.img;
      imgEl.className = 'node-img';
      div.appendChild(imgEl);
    }
    
    let icons = document.createElement('div');
    icons.className = 'node-icons';
    
    let btnAdd = document.createElement('button');
    btnAdd.className = 'icon-btn add';
    btnAdd.title = "å¢åŠ èŠ‚ç‚¹";
    btnAdd.innerHTML = '<svg width="16" height="16" fill="currentColor"><circle cx="8" cy="8" r="7" stroke="#8066e1" stroke-width="1.5" fill="none"/><rect x="7" y="3.5" width="2" height="9" rx="1"/><rect x="3.5" y="7" width="9" height="2" rx="1"/></svg>';
    btnAdd.onclick = function(e) {
      e.stopPropagation();
      addNode(n.id);
    };
    icons.appendChild(btnAdd);
    
    if (n.parent !== null) {
      let btnDel = document.createElement('button');
      btnDel.className = 'icon-btn del';
      btnDel.title = "åˆ é™¤èŠ‚ç‚¹";
      btnDel.innerHTML = '<svg width="16" height="16" fill="currentColor"><circle cx="8" cy="8" r="7" stroke="#b71c1c" stroke-width="1.5" fill="none"/><line x1="5" y1="5" x2="11" y2="11" stroke="#b71c1c" stroke-width="2"/><line x1="11" y1="5" x2="5" y2="11" stroke="#b71c1c" stroke-width="2"/></svg>';
      btnDel.onclick = function(e) {
        e.stopPropagation();
        deleteNode(n.id);
      };
      icons.appendChild(btnDel);
    }
    
    let btnImg = document.createElement('button');
    btnImg.className = 'icon-btn img';
    btnImg.title = "ä¸Šä¼ å›¾ç‰‡";
    btnImg.innerHTML = '<svg width="16" height="16" fill="currentColor"><circle cx="8" cy="8" r="7" stroke="#f4b400" stroke-width="1.5" fill="none"/><rect x="4" y="10" width="8" height="2" rx="1" fill="#f4b400"/><circle cx="8" cy="7" r="2" fill="#f4b400"/></svg>';
    btnImg.onclick = function(e) {
      e.stopPropagation();
      uploadImgForNode(n.id);
    };
    icons.appendChild(btnImg);
    
    let btnEdit = document.createElement('button');
    btnEdit.className = 'icon-btn edit';
    btnEdit.title = "æ–‡æœ¬ç¼–è¾‘";
    btnEdit.innerHTML = '<svg width="16" height="16" fill="currentColor"><circle cx="8" cy="8" r="7" stroke="#388e3c" stroke-width="1.5" fill="none"/><rect x="5" y="5" width="6" height="6" rx="1.2" stroke="#388e3c" stroke-width="1.2" fill="none"/><rect x="7" y="7" width="2" height="2" rx="0.5" fill="#388e3c"/></svg>';
    btnEdit.onclick = function(e) {
      e.stopPropagation();
      editingNodeId = n.id;
      render();
    };
    icons.appendChild(btnEdit);
    
    // å¦‚æœæœ‰å­èŠ‚ç‚¹ï¼Œæ·»åŠ æŠ˜å æŒ‰é’®
    if (nodes.some(child => child.parent === n.id)) {
      let btnFold = document.createElement('button');
      btnFold.className = 'icon-btn fold';
      btnFold.title = foldedNodes[n.id] ? "å±•å¼€å­èŠ‚ç‚¹" : "æŠ˜å å­èŠ‚ç‚¹";
      btnFold.innerHTML = foldedNodes[n.id] 
        ? '<svg width="16" height="16" fill="currentColor"><circle cx="8" cy="8" r="7" stroke="#0288d1" stroke-width="1.5" fill="none"/><rect x="5" y="7" width="6" height="2" rx="1" fill="#0288d1"/><rect x="7" y="5" width="2" height="6" rx="1" fill="#0288d1"/></svg>'
        : '<svg width="16" height="16" fill="currentColor"><circle cx="8" cy="8" r="7" stroke="#0288d1" stroke-width="1.5" fill="none"/><rect x="5" y="7" width="6" height="2" rx="1" fill="#0288d1"/></svg>';
      btnFold.onclick = function(e) {
        e.stopPropagation();
        toggleFoldNode(n.id);
      };
      icons.appendChild(btnFold);
    }
    
    div.appendChild(icons);
    
    div.onclick = function(e) {
      e.stopPropagation();
      selectedId = n.id;
      render();
      renderColorBar();
    };
    
    div.ondblclick = function(e) {
      editingNodeId = n.id;
      render();
    };
    
    div.onmousedown = function(e) {
      if (e.target.classList.contains('icon-btn')) return;
      e.stopPropagation();
      let startX = e.clientX, startY = e.clientY;
      let oriX = n.x, oriY = n.y;
      function move(ev) {
        n.x = oriX + (ev.clientX - startX) / scale;
        n.y = oriY + (ev.clientY - startY) / scale;
        // è‹¥ä¸ºç½®é¡¶ï¼Œæ›´æ–°pinnedåæ ‡
        if (pinnedNodes[n.id]) {
          pinnedNodes[n.id].x = n.x;
          pinnedNodes[n.id].y = n.y;
        }
        render();
      }
      function up() {
        document.removeEventListener('mousemove', move);
        document.removeEventListener('mouseup', up);
        
        // æ·»åŠ å†å²è®°å½•
        addHistory();
      }
      document.addEventListener('mousemove', move);
      document.addEventListener('mouseup', up);
    };
    
    mindmap.appendChild(div);
  });
  
  // æ›´æ–°ç¼©æ”¾ï¼Œä½†ä¸å½±å“æŒ‰é’®ä½ç½®
  mindmap.style.transform = `scale(${scale})`;
  
  // æ›´æ–°é¢œè‰²æ 
  renderColorBar();
  
  // ä¿å­˜å½“å‰çŠ¶æ€åˆ°æœ¬åœ°å­˜å‚¨
  saveCurrentState();
}

function finishEdit(n, val) {
  const oldText = n.text;
  n.text = val.trim() || "æœªå‘½å";
  editingNodeId = null;
  
  // å¦‚æœæ–‡æœ¬æœ‰å˜åŒ–ï¼Œæ·»åŠ å†å²è®°å½•
  if (oldText !== n.text) {
    addHistory();
  }
  
  render();
}

function drawLine(from, to, color="#bfbefc") {
  let x1 = from.x + 65 + offsetX, y1 = from.y + 17 + offsetY;
  let x2 = to.x + 15 + offsetX, y2 = to.y + 17 + offsetY;
  let svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
  svg.classList.add('line');
  svg.style.left = Math.min(x1,x2)-25+"px";
  svg.style.top = Math.min(y1,y2)-25+"px";
  svg.style.width = Math.abs(x2-x1)+50+"px";
  svg.style.height = Math.abs(y2-y1)+50+"px";
  svg.innerHTML = `<path d="M ${x1-Math.min(x1,x2)+25} ${y1-Math.min(y1,y2)+25} Q ${(x1-Math.min(x1,x2)+x2-Math.min(x1,x2))/2+25} ${(y1-Math.min(y1,y2)+y2-Math.min(y1,y2))/2+25-18}, ${x2-Math.min(x1,x2)+25} ${y2-Math.min(y1,y2)+25}"
    stroke="${color}" stroke-width="2.2" fill="none" />`;
  mindmap.appendChild(svg);
}

function addRoot() {
  // éšæœºé€‰æ‹©ä¸€ä¸ªä¸»é¢˜
  currentTheme = PLANT_THEMES[Math.floor(Math.random() * PLANT_THEMES.length)];
  
  // åˆ›å»ºæ–°çš„æ ¹èŠ‚ç‚¹ID
  const newRootId = idCounter++;
  
  // æ·»åŠ åˆ°æ ¹èŠ‚ç‚¹åˆ—è¡¨
  rootNodes.push(newRootId);
  
  // åˆ›å»ºæ ¹èŠ‚ç‚¹
  nodes.push({
    id: newRootId, 
    text: "æ–°ä¸»é¢˜", 
    x: 300 + (rootNodes.length - 1) * 500, 
    y: 220, 
    parent: null, 
    img: "", 
    colorIdx: currentTheme.color
  });
  
  selectedId = newRootId;
  editingNodeId = newRootId;
  
  // æ·»åŠ å†å²è®°å½•
  addHistory();
  
  layoutHorizontal();
  render();
}

function addNode(parentId) {
  let p = nodes.find(n=>n.id===parentId);
  if (!p) return;
  
  // æ‰¾åˆ°æœ€ä½³ä½ç½®
  const position = findOptimalPosition(parentId);
  
  let newId = idCounter++;
  nodes.push({
    id: newId,
    text: "æ–°èŠ‚ç‚¹",
    x: position.x,
    y: position.y,
    parent: parentId,
    img: "",
    colorIdx: p.colorIdx !== undefined ? p.colorIdx : 0
  });
  
  selectedId = newId;
  editingNodeId = newId;
  
  // å¦‚æœçˆ¶èŠ‚ç‚¹è¢«æŠ˜å ï¼Œå±•å¼€å®ƒ
  if (foldedNodes[parentId]) {
    delete foldedNodes[parentId];
  }
  
  // æ·»åŠ å†å²è®°å½•
  addHistory();
  
  layoutHorizontal();
  render();
}

function deleteNode(nodeId) {
  // å¦‚æœæ˜¯æ ¹èŠ‚ç‚¹ï¼Œä»æ ¹èŠ‚ç‚¹åˆ—è¡¨ä¸­ç§»é™¤
  if (rootNodes.includes(nodeId)) {
    rootNodes = rootNodes.filter(id => id !== nodeId);
  }
  
  delRec(nodeId);
  delete pinnedNodes[nodeId];
  selectedId = nodes.length > 0 ? nodes[0].id : null;
  
  // æ·»åŠ å†å²è®°å½•
  addHistory();
  
  layoutHorizontal();
  render();
}

function delRec(id) {
  nodes.filter(n=>n.parent===id).forEach(n=>delRec(n.id));
  nodes = nodes.filter(n=>n.id!==id);
  delete pinnedNodes[id];
  delete foldedNodes[id];
}

function uploadImgForNode(nodeId) {
  imgUpload.value = '';
  imgUpload.onchange = function() {
    const file = imgUpload.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = function() {
      let n = nodes.find(n=>n.id===nodeId);
      if (n) {
        n.img = reader.result;
        
        // æ·»åŠ å†å²è®°å½•
        addHistory();
        
        render();
      }
    };
    reader.readAsDataURL(file);
  };
  imgUpload.click();
}

function zoomIn() { scale = Math.min(scale * 1.15, 4); render(); }
function zoomOut() { scale = Math.max(scale / 1.15, 0.25); render(); }
function zoomReset() { scale = 1; offsetX = 0; offsetY = 0; render(); }

document.addEventListener("wheel", function(e) {
  if(e.target.closest('.mindmap-section') && e.ctrlKey) {
    e.preventDefault();
    if(e.deltaY < 0) zoomIn();
    else if(e.deltaY > 0) zoomOut();
  }
}, {passive:false});

mindmap.addEventListener('mousedown', function(e) {
  if(e.target !== mindmap) return;
  draggingCanvas = true;
  mindmap.classList.add('dragging');
  dragStartX = e.clientX;
  dragStartY = e.clientY;
  dragOriX = offsetX;
  dragOriY = offsetY;
  function move(ev) {
    offsetX = dragOriX + (ev.clientX-dragStartX)/scale;
    offsetY = dragOriY + (ev.clientY-dragStartY)/scale;
    render();
  }
  function up() {
    draggingCanvas = false;
    mindmap.classList.remove('dragging');
    document.removeEventListener('mousemove', move);
    document.removeEventListener('mouseup', up);
  }
  document.addEventListener('mousemove', move);
  document.addEventListener('mouseup', up);
});

// å¤„ç†å¿«æ·é”®
document.addEventListener("keydown", function(e) {
  // å¦‚æœåœ¨è¾“å…¥æ¡†ä¸­ï¼Œä¸å¤„ç†å¿«æ·é”®
  if(document.activeElement.tagName === "INPUT") return;
  
  // å¦‚æœå¿«æ·é”®è®¾ç½®å¯¹è¯æ¡†æ‰“å¼€ï¼Œä¸å¤„ç†å¿«æ·é”®
  if(document.getElementById('shortcut-settings').style.display === 'block') return;
  
  // æ£€æŸ¥æ˜¯å¦åŒ¹é…è‡ªå®šä¹‰å¿«æ·é”®
  const matchShortcut = (shortcutKey) => {
    const parts = shortcutKey.toLowerCase().split('+');
    const needCtrl = parts.includes('ctrl');
    const needAlt = parts.includes('alt');
    const needShift = parts.includes('shift');
    
    // è·å–ä¸»é”®ï¼ˆæœ€åä¸€ä¸ªéƒ¨åˆ†ï¼‰
    const mainKey = parts[parts.length - 1];
    
    // æ£€æŸ¥ä¿®é¥°é”®æ˜¯å¦åŒ¹é…
    if ((needCtrl && !e.ctrlKey) || (!needCtrl && e.ctrlKey)) return false;
    if ((needAlt && !e.altKey) || (!needAlt && e.altKey)) return false;
    if ((needShift && !e.shiftKey) || (!needShift && e.shiftKey)) return false;
    
    // æ£€æŸ¥ä¸»é”®æ˜¯å¦åŒ¹é…
    return e.key.toLowerCase() === mainKey.toLowerCase();
  };
  
  // æ·»åŠ å­èŠ‚ç‚¹å¿«æ·é”®
  if (matchShortcut(currentShortcuts.addChild.key) && selectedId !== null) {
    e.preventDefault();
    addNode(selectedId);
    return;
  }
  
  // ç¼–è¾‘èŠ‚ç‚¹å¿«æ·é”®
  if (matchShortcut(currentShortcuts.editNode.key) && selectedId !== null) {
    e.preventDefault();
    editingNodeId = selectedId;
    render();
    return;
  }
  
  // åˆ é™¤èŠ‚ç‚¹å¿«æ·é”®
  if (matchShortcut(currentShortcuts.deleteNode.key) && selectedId !== null && !rootNodes.includes(selectedId)) {
    e.preventDefault();
    deleteNode(selectedId);
    return;
  }
  
  // ä¿å­˜å¯¼å›¾å¿«æ·é”®
  if (matchShortcut(currentShortcuts.saveMap.key)) {
    e.preventDefault();
    if(auth.currentUser) {
      saveCloud();
    } else {
      showDialog("è¯·å…ˆç™»å½•å†ä¿å­˜åˆ°äº‘ç«¯", () => {
        googleLogin();
      });
    }
    return;
  }
  
  // å…³é—­å¯¹è¯æ¡†å¿«æ·é”®
  if (matchShortcut(currentShortcuts.closeDialog.key)) {
    e.preventDefault();
    hideSidebar();
    hideDialog();
    hideShortcutSettings();
    return;
  }
  
  // æ’¤é”€å¿«æ·é”®
  if (matchShortcut(currentShortcuts.undo.key)) {
    e.preventDefault();
    undo();
    return;
  }
  
  // é‡åšå¿«æ·é”®
  if (matchShortcut(currentShortcuts.redo.key)) {
    e.preventDefault();
    redo();
    return;
  }
  
  // æŠ˜å /å±•å¼€èŠ‚ç‚¹å¿«æ·é”®
  if (matchShortcut(currentShortcuts.foldNode.key) && selectedId !== null) {
    e.preventDefault();
    // åªæœ‰å½“èŠ‚ç‚¹æœ‰å­èŠ‚ç‚¹æ—¶æ‰èƒ½æŠ˜å 
    if (nodes.some(n => n.parent === selectedId)) {
      toggleFoldNode(selectedId);
    }
    return;
  }
});

function saveCloud() {
  if (!auth.currentUser) return alert('è¯·å…ˆç™»å½•å†ä¿å­˜åˆ°äº‘ç«¯');
  if(!nodes.length) return alert("å½“å‰ç”»å¸ƒä¸ºç©ºã€‚");
  
// è¿™é‡ŒåŠ¨æ€å–æœ€æ–°çš„æ ¹èŠ‚ç‚¹æ–‡æœ¬
  const rootNode = nodes.find(n => rootNodes.includes(n.id));
  const title = rootNode?.text || "æ€ç»´å¯¼å›¾";

  const data = {
    title: title,
    nodes: nodes,
    rootNodes: rootNodes,
    idCounter: idCounter,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  };
  
  // æ£€æŸ¥æ˜¯å¦æœ‰ç›¸åŒæ ‡é¢˜çš„å¯¼å›¾
  db.collection('mindmaps')
    .where('uid', '==', uid)
    .where('title', '==', title)
    .get()
    .then(snapshot => {
      if (!snapshot.empty) {
        // æœ‰ç›¸åŒæ ‡é¢˜çš„å¯¼å›¾ï¼Œè¯¢é—®æ˜¯å¦è¦†ç›–
        showDialog(`å·²å­˜åœ¨æ ‡é¢˜ä¸º"${title}"çš„å¯¼å›¾ï¼Œæ˜¯å¦è¦†ç›–ï¼Ÿ`, () => {
          // ç”¨æˆ·ç¡®è®¤è¦†ç›–ï¼Œåˆ é™¤æ—§çš„å¯¼å›¾
          const docId = snapshot.docs[0].id;
          db.collection('mindmaps').doc(docId).delete().then(() => {
            // åˆ é™¤æˆåŠŸåä¿å­˜æ–°çš„å¯¼å›¾
            saveNewMap(uid, title);
          });
        });
      } else {
        // æ²¡æœ‰ç›¸åŒæ ‡é¢˜çš„å¯¼å›¾ï¼Œç›´æ¥ä¿å­˜
        saveNewMap(uid, title);
      }
    })
    .catch(e => alert('æ£€æŸ¥å¯¼å›¾å¤±è´¥: ' + e.message));
}

function saveNewMap(uid, title) {
  // è·å–å½“å‰æ—¥æœŸæ—¶é—´
  const now = new Date();
  const dateStr = now.toLocaleDateString() + ' ' + now.toLocaleTimeString();
  
  db.collection('mindmaps')
    .add({
      uid: uid,
      title: title,
      nodes: JSON.parse(JSON.stringify(nodes)),
      pinnedNodes: JSON.parse(JSON.stringify(pinnedNodes)),
      foldedNodes: JSON.parse(JSON.stringify(foldedNodes)),
      rootNodes: JSON.parse(JSON.stringify(rootNodes)),
      saveDate: dateStr,
      time: firebase.firestore.FieldValue.serverTimestamp()
    })
    .then(() => {
      alert("å·²ä¿å­˜åˆ°äº‘ç«¯ï¼");
      loadSidebarIfVisible();
    })
    .catch(e => alert('ä¿å­˜å¤±è´¥: ' + e.message));
}

function loadSidebarIfVisible() {
  if(sidebar.style.display==='flex') renderSidebar();
}

function showSidebar() {
  renderSidebar();
  document.getElementById('sidebar').style.display="flex";
  document.getElementById('sidebar-mask').style.display="block";
  document.body.style.overflow="hidden";
}

function hideSidebar() {
  document.getElementById('sidebar').style.display="none";
  document.getElementById('sidebar-mask').style.display="none";
  document.body.style.overflow="";
}

document.getElementById('sidebar-mask').onclick = hideSidebar;
document.getElementById('sidebar').onclick = function(e) {
  if(e.target===this) hideSidebar();
}

function renderSidebar() {
  if(!auth.currentUser) {
    thumbList.innerHTML = `<div style="color:#bbb;font-size:12px;margin:18px 0;text-align:center;">è¯·å…ˆç™»å½•</div>`;
    return;
  }
  
  const uid = auth.currentUser.uid;
  db.collection('mindmaps')
    .where('uid', '==', uid)
    .orderBy('time', 'desc')
    .limit(30)
    .get()
    .then(snapshot => {
      thumbList.innerHTML = '';
      if(snapshot.empty) {
        thumbList.innerHTML = `<div style="color:#bbb;font-size:12px;margin:18px 0;text-align:center;">æš‚æ— çº¿ä¸Šå¯¼å›¾</div>`;
        return;
      }
      
      snapshot.forEach(doc => {
        const item = doc.data();
        let div = document.createElement('div');
        div.className = 'thumb-item';
        div.onclick = function() {
          nodes = JSON.parse(JSON.stringify(item.nodes));
          // åŠ è½½ç½®é¡¶èŠ‚ç‚¹ä¿¡æ¯
          pinnedNodes = item.pinnedNodes ? JSON.parse(JSON.stringify(item.pinnedNodes)) : {};
          // åŠ è½½æŠ˜å èŠ‚ç‚¹ä¿¡æ¯
          foldedNodes = item.foldedNodes ? JSON.parse(JSON.stringify(item.foldedNodes)) : {};
          // åŠ è½½æ ¹èŠ‚ç‚¹åˆ—è¡¨
          rootNodes = item.rootNodes ? JSON.parse(JSON.stringify(item.rootNodes)) : 
                     [nodes.find(n => n.parent === null)?.id].filter(Boolean);
          
          idCounter = Math.max(...nodes.map(n=>n.id)) + 1;
          selectedId = nodes[0]?.id || null;
          editingNodeId = null;
          
          // æ¸…ç©ºå†å²è®°å½•å¹¶æ·»åŠ å½“å‰çŠ¶æ€
          history = [];
          historyIndex = -1;
          addHistory();
          
          hideSidebar();
          render();
        };
        
        let title = document.createElement('div');
        title.className = 'thumb-title';
        title.textContent = item.title;
        div.appendChild(title);
        
        // æ·»åŠ ä¿å­˜æ—¥æœŸ
        if (item.saveDate) {
          let date = document.createElement('div');
          date.className = 'thumb-date';
          date.textContent = item.saveDate;
          div.appendChild(date);
        }
        
        let svg = document.createElementNS("http://www.w3.org/2000/svg","svg");
        svg.setAttribute("class","thumb-svg");
        svg.setAttribute("width","130"); svg.setAttribute("height","38");
        renderThumbSvg(svg, item.nodes);
        div.appendChild(svg);
        thumbList.appendChild(div);
      });
    });
}

function renderThumbSvg(svg, nodes0) {
  let ns = nodes0.map(n=>({...n}));
  let minX = Math.min(...ns.map(n=>n.x)), maxX = Math.max(...ns.map(n=>n.x));
  let minY = Math.min(...ns.map(n=>n.y)), maxY = Math.max(...ns.map(n=>n.y));
  let sx = 110/Math.max(60,maxX-minX+1), sy=22/Math.max(16,maxY-minY+1);
  let tx = (130 - (maxX-minX)*sx)/2 - minX*sx + 6;
  let ty = (38 - (maxY-minY)*sy)/2 - minY*sy + 2;
  svg.innerHTML = '';
  ns.forEach(n=>{
    if(n.parent!==null && n.parent!==undefined){
      let p = ns.find(nn=>nn.id===n.parent);
      if(p){
        let x1 = p.x*sx+tx+23, y1 = p.y*sy+ty+8;
        let x2 = n.x*sx+tx+8, y2 = n.y*sy+ty+8;
        let c = p.parent===null?"#f4c24d":"#bfbefc";
        let path = document.createElementNS("http://www.w3.org/2000/svg","path");
        path.setAttribute("d",`M${x1},${y1} Q${(x1+x2)/2},${(y1+y2)/2-7},${x2},${y2}`);
        path.setAttribute("stroke",c); path.setAttribute("stroke-width","1.3"); path.setAttribute("fill","none");
        svg.appendChild(path);
      }
    }
  });
  ns.forEach(n=>{
    let x = n.x*sx+tx+(n.parent===null?23:8), y = n.y*sy+ty+8;
    let r = n.parent===null?8:5;
    let circ = document.createElementNS("http://www.w3.org/2000/svg","circle");
    circ.setAttribute("cx",x); circ.setAttribute("cy",y); circ.setAttribute("r",r);
    circ.setAttribute("fill",n.parent===null?"#ffe08b":"#fff");
    circ.setAttribute("stroke",n.parent===null?"#f4c24d":"#bfbefc");
    circ.setAttribute("stroke-width",n.parent===null?"1.2":"1");
    svg.appendChild(circ);
  });
}

function onNewMap() {
  if(nodes.length>0){
    showDialog("æ˜¯å¦ä¿å­˜å½“å‰ç”»å¸ƒï¼Ÿ", ()=>{saveCloud(); newMap();});
  } else {
    newMap();
  }
}

function newMap() {
  nodes = [];
  idCounter = 1;
  selectedId = null;
  editingNodeId = null;
  pinnedNodes = {};
  foldedNodes = {};
  rootNodes = [];
  
  // æ¸…ç©ºå†å²è®°å½•
  history = [];
  historyIndex = -1;
  updateHistoryButtons();
  
  render();
}

mindmap.onclick = ()=>{selectedId=null;render();};
document.body.addEventListener("keydown",function(e){
  if(e.key==="Escape") hideSidebar();
});

// å¯¹è¯æ¡†
function showDialog(msg, onSave) {
  document.getElementById('dialog-msg').innerText = msg || 'æ˜¯å¦ä¿å­˜å½“å‰ç”»å¸ƒï¼Ÿ';
  document.getElementById('overlay').style.display = 'flex';
  let saveBtn = document.getElementById('dialog-save-btn');
  // è§£ç»‘æ—§çš„
  saveBtn.onclick = null;
  // ç»‘å®šæ–°çš„
  saveBtn.onclick = function() {
    hideDialog();
    if(typeof onSave === 'function') onSave();
  };
}

function hideDialog() {
  document.getElementById('overlay').style.display = 'none';
}

// ==== äº¤æ¢ä½ç½®åŠŸèƒ½ ====
const searchSection = document.getElementById('search-section');
const mindmapSection = document.getElementById('mindmap-section');
const swapButton = document.getElementById('swap-button');

// é»˜è®¤å¸ƒå±€
let isSwapped = false;

// ä»æœ¬åœ°å­˜å‚¨åŠ è½½å¸ƒå±€è®¾ç½®
const savedLayout = localStorage.getItem('appLayout');
if (savedLayout) {
  const layout = JSON.parse(savedLayout);
  isSwapped = layout.isSwapped;
  
  // åº”ç”¨ä¿å­˜çš„å¸ƒå±€
  applyLayout();
}

// äº¤æ¢ä½ç½®
swapButton.addEventListener('click', function() {
  isSwapped = !isSwapped;
  applyLayout();
  saveLayout();
});

// åº”ç”¨å¸ƒå±€
function applyLayout() {
  const appContainer = document.querySelector('.app-container');
  
  if (isSwapped) {
    // æ€ç»´å¯¼å›¾åœ¨å·¦ï¼Œæœç´¢åœ¨å³
    appContainer.insertBefore(mindmapSection, searchSection);
  } else {
    // æœç´¢åœ¨å·¦ï¼Œæ€ç»´å¯¼å›¾åœ¨å³
    appContainer.insertBefore(searchSection, mindmapSection);
  }
  
  // æ›´æ–°äº¤æ¢æŒ‰é’®ä½ç½®
  updateSwapButtonPosition();
}

// ä¿å­˜å¸ƒå±€è®¾ç½®
function saveLayout() {
  const layout = {
    isSwapped: isSwapped
  };
  
  localStorage.setItem('appLayout', JSON.stringify(layout));
}

// æ›´æ–°äº¤æ¢æŒ‰é’®ä½ç½®
function updateSwapButtonPosition() {
  // å§‹ç»ˆä¿æŒåœ¨å·¦ä¸‹è§’
  swapButton.style.left = '20px';
  swapButton.style.bottom = '20px';
}

// ä¿å­˜å½“å‰çŠ¶æ€åˆ°æœ¬åœ°å­˜å‚¨
function saveCurrentState() {
  if (!nodes.length) return;
  
  const state = {
    nodes: JSON.parse(JSON.stringify(nodes)),
    pinnedNodes: JSON.parse(JSON.stringify(pinnedNodes)),
    idCounter: idCounter,
    selectedId: selectedId,
    scale: scale,
    offsetX: offsetX,
    offsetY: offsetY
  };
  
  localStorage.setItem('mindmapState', JSON.stringify(state));
}

// åŠ è½½ä¸Šæ¬¡ç¼–è¾‘çŠ¶æ€
function loadLastState() {
  const savedState = localStorage.getItem('mindmapState');
  if (savedState) {
    try {
      const state = JSON.parse(savedState);
      nodes = state.nodes;
      pinnedNodes = state.pinnedNodes || {};
      idCounter = state.idCounter;
      selectedId = state.selectedId;
      scale = state.scale || 1;
      offsetX = state.offsetX || 0;
      offsetY = state.offsetY || 0;
      render();
      return true;
    } catch (e) {
      console.error('åŠ è½½ä¸Šæ¬¡çŠ¶æ€å¤±è´¥:', e);
      return false;
    }
  }
  return false;
}

// çª—å£å¤§å°å˜åŒ–æ—¶é‡æ–°åº”ç”¨å¸ƒå±€
window.addEventListener('resize', function() {
  updateSwapButtonPosition();
  
  // é‡æ–°æ¸²æŸ“æ€ç»´å¯¼å›¾
  if (render) render();
});

// åˆå§‹åŒ–
// æ›´æ–°å¿«æ·é”®æ 
updateShortcutBar();
// å°è¯•åŠ è½½ä¸Šæ¬¡ç¼–è¾‘çŠ¶æ€ï¼Œå¦‚æœæ²¡æœ‰åˆ™æ¸²æŸ“ç©ºç™½ç”»å¸ƒ
if (!loadLastState()) {
  render();
}
renderSearchHistory();
applyLayout();
</script>
</body>
</html>
