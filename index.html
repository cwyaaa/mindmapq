<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>æ€ç»´å¯¼å›¾ï¼ˆFirestore+Googleç™»å½•+èŠ‚ç‚¹åŠŸèƒ½å¢å¼ºï¼‰</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-auth-compat.js"></script>
  <style>
    body { margin:0; background:#f5f6fa; font-family: Arial,'å¾®è½¯é›…é»‘'; }
    #toolbar {
      width: 100vw; height: 60px; background: #8066e1; color: #fff; display: flex; align-items: center;
      box-sizing: border-box; padding: 0 32px; position:relative; z-index:2;
    }
    #toolbar .logo { font-size: 25px; font-weight: bold; border-radius: 50%; width:32px; height:32px; background:#fff; color:#8066e1; display:inline-flex; align-items:center; justify-content:center; margin-right:14px;}
    #toolbar .title { font-size: 21px; font-weight: bold; margin-right: 32px;}
    #toolbar .btn { margin-left:12px; background: #fff; color: #8066e1; border: none; border-radius: 8px; padding: 6px 19px; font-size: 15px; cursor:pointer; font-weight:500; transition:.2s; display:inline-flex; align-items:center;}
    #toolbar .btn:hover { background: #e9e4fc;}
    #toolbar .btn.add { background: #f5f6fa; color: #8066e1; border: 1.4px solid #8066e1;}
    #toolbar .btn.add:hover { background: #e9e4fc; }
    #toolbar .user-info { margin-left:auto; display:flex; align-items:center; gap:8px; font-size:14px;}
    #toolbar .avatar { width:26px; height:26px; border-radius:50%; background:#eee; object-fit:cover; }
    #mindmap-container { position:relative; width:100vw; height:calc(100vh - 60px); overflow:hidden; background: #f9f9fc; }
    #mindmap { width:100vw; height:calc(100vh - 60px); position:relative; overflow:hidden; }
    .node {
      position:absolute; min-width:65px; min-height:28px; padding:4px 13px 4px 18px;
      background:#fff; border-radius:12px; color:#333; font-weight:400;
      user-select:none; cursor:pointer; box-shadow:0 2px 9px #c7bbfa33;
      font-size:15px; border:1.7px solid #bfbefc; transition:.2s;
      z-index: 2; display: flex; align-items: center; flex-direction: row; gap:0;
      white-space:nowrap;
    }
    .node.selected { border:1.7px solid #8066e1; }
    .node.root { background: #ffe08b; border-color: #f4c24d; color:#564200; font-weight: bold;}
    .node input {
      font-size: 15px; font-family: inherit; border:none; border-radius: 8px; background:#fffde6; outline:2px solid #8066e1; color:#333;
      padding: 2px 8px; width: 100px; box-sizing:border-box;
    }
    .node .node-img {
      max-width: 60px; max-height: 60px; border-radius:4px; margin-left:6px; vertical-align: middle;
    }
    .node .node-icons {
      position: absolute;
      left: 100%; top: 50%; transform: translateY(-50%);
      display: flex; flex-direction: row; gap: 2px;
      opacity: 0; pointer-events: none; transition:.2s;
      z-index: 10;
    }
    .node:hover .node-icons,
    .node .node-icons:focus-within {
      opacity: 1; pointer-events: all;
    }
    .node .icon-btn {
      background: #fff; border:1px solid #e2d6fa; color:#8066e1;
      border-radius: 50%; width: 26px; height: 26px;
      display: flex; align-items: center; justify-content: center;
      font-size: 15px; cursor:pointer; margin-left:3px; box-shadow:0 1px 4px #c7bbfa22; transition:.18s;
      outline:none;
    }
    .node .icon-btn:hover { background: #f5f0fa; border-color: #bfbefc;}
    .node .icon-btn:active { background:#e8e0fd;}
    .node .icon-btn.edit { color:#388e3c;}
    .node .icon-btn.del { color:#b71c1c;}
    .node .icon-btn.img { color:#f4b400;}
    .node .icon-btn.add { color:#8066e1;}
    .line { position:absolute; z-index:1; pointer-events:none; }
    #img-upload { display:none; }
    /* ä¾§æ å’Œå…¶å®ƒæ ·å¼åŒåŸä»£ç ... */
    #sidebar {
      position:fixed; top:60px; right:0; width:250px; height:calc(100vh - 60px);
      background:#fff; box-shadow: -2px 0 16px #b7aefa33; z-index:10;
      display:none; flex-direction:column; padding:15px 0 0 0; overflow-y:auto;
    }
    #sidebar h3 { font-size:15px; margin:0 0 7px 21px; color:#8066e1;}
    .thumb-list { width:100%; display:flex; flex-direction:column; gap:13px; padding:0 12px 10px 12px;}
    .thumb-item {
      background: #f8f8fd; border-radius:8px; box-shadow:0 1px 4px #ddd5fa33; padding:10px 8px 7px 8px;
      margin-bottom: 2px; cursor:pointer; border:1.5px solid transparent; transition:.15s;
      display:flex; flex-direction:column; align-items:center; font-size:12px;
    }
    .thumb-item.selected, .thumb-item:hover { border-color:#8066e1; background:#f1edfa;}
    .thumb-title {
      font-size:12px; color:#8066e1; margin-bottom:4px; font-weight:bold;
      text-align:center; width: 100%; word-break:break-all;
    }
    .thumb-svg {
      background:#fff; border-radius:5px; margin-bottom:2px; box-shadow:0 1px 3px #ddd4ff22;
      width:130px; height:38px; display:block;
    }
    /* å…¶å®ƒåŸæœ‰æ ·å¼åŒä½ çš„åŸæ–‡ä»¶... */
  </style>
</head>
<body>
  <div id="toolbar">
    <span class="logo">M</span>
    <span class="title">æ€ç»´å¯¼å›¾</span>
    <button class="btn add" id="btn-addroot" onclick="addRoot()">+ æ·»åŠ ä¸­å¿ƒä¸»é¢˜</button>
    <button class="btn" onclick="onNewMap()">âŸ³ æ–°å»º</button>
    <button class="btn" onclick="saveCloud()">â˜ï¸ çº¿ä¸Šä¿å­˜</button>
    <button class="btn" onclick="showSidebar()">ğŸ“ åŠ è½½</button>
    <div class="user-info" id="user-info">
      <button class="btn" id="login-btn" onclick="googleLogin()">Googleç™»å½•</button>
    </div>
  </div>
  <div id="mindmap-container">
    <div id="mindmap"></div>
    <input id="img-upload" type="file" accept="image/*">
    <div id="sidebar">
      <h3>æˆ‘çš„çº¿ä¸Šå¯¼å›¾</h3>
      <div class="thumb-list" id="thumb-list"></div>
    </div>
    <div id="overlay">
      <div id="dialog">
        <div id="dialog-msg"></div>
        <button class="dialog-btn" id="dialog-save-btn">ä¿å­˜</button>
        <button class="dialog-btn" onclick="hideDialog()">å–æ¶ˆ</button>
      </div>
    </div>
  </div>
  <div class="mindmap-fab-wrap">
    <button class="mindmap-fab" onclick="zoomOut()">-</button>
    <button class="mindmap-fab" onclick="zoomIn()">+</button>
  </div>
  <div class="shortcutbar">
    <kbd>Enter</kbd> æ·»åŠ èŠ‚ç‚¹
    <kbd>Backspace</kbd> åˆ é™¤èŠ‚ç‚¹
    <kbd>Space</kbd> ç¼–è¾‘èŠ‚ç‚¹
    <span>åŒå‡»èŠ‚ç‚¹ä¹Ÿå¯ç¼–è¾‘</span>
  </div>
  <script>
    // 1. Firebase Firestoreé…ç½® -- æ›¿æ¢ä¸ºä½ è‡ªå·±çš„firebaseConfig
    const firebaseConfig = {
       apiKey: "AIzaSyCcsz9Lg3KmgvD_SXUdy4V5x7aCQtSdI-s",
  authDomain: "webs-d0804.firebaseapp.com",
  databaseURL: "https://webs-d0804-default-rtdb.firebaseio.com",
  projectId: "webs-d0804",
  storageBucket: "webs-d0804.firebasestorage.app",
  messagingSenderId: "195195304680",
  appId: "1:195195304680:web:01c68159689678c7f4275d",
  measurementId: "G-RRQ7RFHV76"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // Googleç™»å½•
    let currentUser = null;
    function googleLogin() {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider)
        .then(result => {
          currentUser = result.user;
          renderUser();
          loadSidebarIfVisible();
        }).catch(e => alert('ç™»å½•å¤±è´¥: ' + e.message));
    }
    function logout() {
      auth.signOut().then(() => {
        currentUser = null;
        renderUser();
        render();
      });
    }
    function renderUser() {
      const userInfo = document.getElementById('user-info');
      if (auth.currentUser) {
        userInfo.innerHTML =
          `<img class="avatar" src="${auth.currentUser.photoURL || ''}" alt=""/>`
          + `<span>${auth.currentUser.displayName || ''}</span>`
          + `<button class="btn" onclick="logout()">é€€å‡º</button>`;
      } else {
        userInfo.innerHTML = `<button class="btn" id="login-btn" onclick="googleLogin()">Googleç™»å½•</button>`;
      }
    }
    auth.onAuthStateChanged(user => {
      currentUser = user;
      renderUser();
      render();
      loadSidebarIfVisible();
    });

    // æ€ç»´å¯¼å›¾åŠŸèƒ½
    let nodes = [];
    let idCounter = 1;
    let selectedId = null;
    let editingNodeId = null;
    let scale = 1;

    const mindmap = document.getElementById('mindmap');
    const sidebar = document.getElementById('sidebar');
    const thumbList = document.getElementById('thumb-list');
    const btnAddRoot = document.getElementById('btn-addroot');
    const imgUpload = document.getElementById('img-upload');

    function render() {
      mindmap.innerHTML = '';
      btnAddRoot.style.display = nodes.length ? 'none' : '';
      nodes.forEach(n=>{
        if(n.parent!==null && n.parent!==undefined){
          let p = nodes.find(nn=>nn.id===n.parent);
          if(p) drawLine(p, n, p.id === 1 ? "#f4c24d" : "#bfbefc");
        }
      });
      nodes.forEach(n=>{
        let div = document.createElement('div');
        div.className = 'node' + (selectedId===n.id?' selected':'') + (n.id===1?' root':'');
        div.style.left = n.x+'px';
        div.style.top = n.y+'px';
        div.style.position = "absolute";
        div.style.fontSize = "15px";
        div.style.whiteSpace = "nowrap";
        div.style.flexDirection = "row";
        div.dataset.id = n.id;

        // æ–‡å­—æˆ–ç¼–è¾‘æ¡†
        if(editingNodeId === n.id) {
          let input = document.createElement('input');
          input.value = n.text;
          input.onblur = function() { finishEdit(n, input.value); };
          input.onkeydown = function(e) {
            if(e.key === "Enter") input.blur();
            else if(e.key === "Escape") { editingNodeId = null; render(); }
          };
          setTimeout(()=>{ input.focus(); input.select(); }, 0);
          div.appendChild(input);
        } else {
          let txtspan = document.createElement('span');
          txtspan.textContent = n.text;
          div.appendChild(txtspan);
        }

        // å›¾ç‰‡
        if(n.img){
          let imgEl = document.createElement('img');
          imgEl.src = n.img;
          imgEl.className = 'node-img';
          div.appendChild(imgEl);
        }

        // æ“ä½œå›¾æ ‡åŒº
        let icons = document.createElement('div');
        icons.className = 'node-icons';

        // åŠ å·ï¼šå¢åŠ å­èŠ‚ç‚¹
        let btnAdd = document.createElement('button');
        btnAdd.className = 'icon-btn add';
        btnAdd.title = "å¢åŠ èŠ‚ç‚¹";
        btnAdd.innerHTML = '<svg width="16" height="16" fill="currentColor"><circle cx="8" cy="8" r="7" stroke="#8066e1" stroke-width="1.5" fill="none"/><rect x="7" y="3.5" width="2" height="9" rx="1"/><rect x="3.5" y="7" width="9" height="2" rx="1"/></svg>';
        btnAdd.onclick = function(e){
          e.stopPropagation();
          addNode(n.id);
        };
        icons.appendChild(btnAdd);

        // åˆ é™¤
        if(n.id!==1) {
          let btnDel = document.createElement('button');
          btnDel.className = 'icon-btn del';
          btnDel.title = "åˆ é™¤èŠ‚ç‚¹";
          btnDel.innerHTML = '<svg width="16" height="16" fill="currentColor"><circle cx="8" cy="8" r="7" stroke="#b71c1c" stroke-width="1.5" fill="none"/><line x1="5" y1="5" x2="11" y2="11" stroke="#b71c1c" stroke-width="2"/><line x1="11" y1="5" x2="5" y2="11" stroke="#b71c1c" stroke-width="2"/></svg>';
          btnDel.onclick = function(e){
            e.stopPropagation();
            deleteNode(n.id);
          };
          icons.appendChild(btnDel);
        }

        // å›¾ç‰‡æŒ‰é’®
        let btnImg = document.createElement('button');
        btnImg.className = 'icon-btn img';
        btnImg.title = "ä¸Šä¼ å›¾ç‰‡";
        btnImg.innerHTML = '<svg width="16" height="16" fill="currentColor"><circle cx="8" cy="8" r="7" stroke="#f4b400" stroke-width="1.5" fill="none"/><rect x="4" y="10" width="8" height="2" rx="1" fill="#f4b400"/><circle cx="8" cy="7" r="3" stroke="#f4b400" stroke-width="1.2" fill="none"/></svg>';
        btnImg.onclick = function(e){
          e.stopPropagation();
          uploadImgForNode(n.id);
        };
        icons.appendChild(btnImg);

        // ç¼–è¾‘æŒ‰é’®
        let btnEdit = document.createElement('button');
        btnEdit.className = 'icon-btn edit';
        btnEdit.title = "æ–‡æœ¬ç¼–è¾‘";
        btnEdit.innerHTML = '<svg width="16" height="16" fill="currentColor"><circle cx="8" cy="8" r="7" stroke="#388e3c" stroke-width="1.5" fill="none"/><rect x="5" y="5" width="6" height="6" rx="1.2" stroke="#388e3c" stroke-width="1.2" fill="none"/><rect x="7" y="7" width="2" height="2" rx="0.5" fill="#388e3c"/></svg>';
        btnEdit.onclick = function(e){
          e.stopPropagation();
          editingNodeId = n.id;
          render();
        };
        icons.appendChild(btnEdit);

        div.appendChild(icons);

        // é€‰ä¸­
        div.onclick = function(e){
          selectedId = n.id;
          render();
        };

        // æ‹–åŠ¨
        div.onmousedown = function(e){
          if(e.target.classList.contains('icon-btn')) return;
          let startX = e.clientX, startY = e.clientY;
          let oriX = n.x, oriY = n.y;
          document.onmousemove = function(ev){
            n.x = oriX + (ev.clientX - startX)/scale;
            n.y = oriY + (ev.clientY - startY)/scale;
            render();
          };
          document.onmouseup = function(){
            document.onmousemove = null; document.onmouseup = null;
          };
        };

        mindmap.appendChild(div);
      });
      mindmap.style.transform = `scale(${scale})`;
    }

    function finishEdit(n, val) {
      n.text = val.trim() || "æœªå‘½å";
      editingNodeId = null; render();
    }

    function drawLine(from, to, color="#bfbefc"){
      let x1 = from.x + 65, y1 = from.y + 17;
      let x2 = to.x + 15, y2 = to.y + 17;
      let svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
      svg.classList.add('line');
      svg.style.left = Math.min(x1,x2)-25+"px";
      svg.style.top = Math.min(y1,y2)-25+"px";
      svg.style.width = Math.abs(x2-x1)+50+"px";
      svg.style.height = Math.abs(y2-y1)+50+"px";
      svg.innerHTML = `<path d="M ${x1-Math.min(x1,x2)+25} ${y1-Math.min(y1,y2)+25} Q ${(x1-Math.min(x1,x2)+x2-Math.min(x1,x2))/2+25} ${(y1-Math.min(y1,y2)+y2-Math.min(y1,y2))/2+25-18}, ${x2-Math.min(x1,x2)+25} ${y2-Math.min(y1,y2)+25}"
        stroke="${color}" stroke-width="2.2" fill="none" />`;
      mindmap.appendChild(svg);
    }

    function addRoot() {
      if(nodes.length>0) { alert("åªèƒ½æœ‰ä¸€ä¸ªä¸­å¿ƒä¸»é¢˜"); return; }
      nodes.push({id:1, text:"ä¸­å¿ƒä¸»é¢˜", x:520, y:220, parent:null, img:""});
      idCounter=2; selectedId=1; editingNodeId=1;
      render();
    }

    function addNode(parentId){
      let p = nodes.find(n=>n.id===parentId);
      let children = nodes.filter(n=>n.parent===parentId);
      let baseAngle = Math.PI/2, dAng = Math.PI/3, idx = children.length;
      let angle = baseAngle + (idx - (children.length-1)/2) * dAng;
      let radius = 120;
      let newX = p.x + radius * Math.cos(angle);
      let newY = p.y + radius * Math.sin(angle);
      let newId = idCounter++;
      nodes.push({
        id:newId,
        text:"æ–°èŠ‚ç‚¹",
        x:newX,
        y:newY,
        parent:parentId,
        img:""
      });
      selectedId=newId; editingNodeId=newId;
      render();
    }

    function deleteNode(nodeId) {
      delRec(nodeId);
      selectedId = nodes[0]?.id || null; render();
    }
    function delRec(id){
      nodes.filter(n=>n.parent===id).forEach(n=>delRec(n.id));
      nodes = nodes.filter(n=>n.id!==id);
    }

    function uploadImgForNode(nodeId){
      imgUpload.value = '';
      imgUpload.onchange = function(){
        const file = imgUpload.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(){
          let n = nodes.find(n=>n.id===nodeId);
          n.img = reader.result;
          render();
        };
        reader.readAsDataURL(file);
      };
      imgUpload.click();
    }

    function zoomIn(){ scale *= 1.15; render();}
    function zoomOut(){ scale /= 1.15; render();}

    document.addEventListener("keydown",function(e){
      if(document.activeElement.tagName==="INPUT") return;
      if(e.key==="Enter" && selectedId!==null){ addNode(selectedId); }
      else if(e.key==="Backspace" && selectedId && selectedId!==1){ deleteNode(selectedId); }
      else if(e.key===" " && selectedId){ editingNodeId = selectedId; render(); }
    });

    // ========== çº¿ä¸Šä¿å­˜/åŠ è½½/ä¾§æ /å¯¹è¯æ¡†ç­‰é€»è¾‘ ä¸åŸä»£ç ä¸€è‡´ ==========
    function saveCloud(){
      if (!auth.currentUser) return alert('è¯·å…ˆç™»å½•å†ä¿å­˜åˆ°äº‘ç«¯');
      if(!nodes.length) return alert("å½“å‰ç”»å¸ƒä¸ºç©ºã€‚");
      let title = nodes.find(n=>n.id===1)?.text || "æ€ç»´å¯¼å›¾";
      const uid = auth.currentUser.uid;
      db.collection('mindmaps')
        .add({
          uid: uid,
          title: title,
          nodes: JSON.parse(JSON.stringify(nodes)),
          time: firebase.firestore.FieldValue.serverTimestamp()
        })
        .then(() => {
          alert("å·²ä¿å­˜åˆ°äº‘ç«¯ï¼");
          loadSidebarIfVisible();
        })
        .catch(e => alert('ä¿å­˜å¤±è´¥: ' + e.message));
    }

    function loadSidebarIfVisible() {
      if(sidebar.style.display==='flex') renderSidebar();
    }

    function showSidebar(){
      renderSidebar();
      sidebar.style.display="flex";
      document.body.style.overflow="hidden";
    }
    function hideSidebar(){
      sidebar.style.display="none";
      document.body.style.overflow="";
    }
    sidebar.onclick = function(e){
      if(e.target===sidebar) hideSidebar();
    }
    function renderSidebar(){
      if(!auth.currentUser) {
        thumbList.innerHTML = `<div style="color:#bbb;font-size:12px;margin:18px 0;text-align:center;">è¯·å…ˆç™»å½•</div>`;
        return;
      }
      const uid = auth.currentUser.uid;
      db.collection('mindmaps')
        .where('uid', '==', uid)
        .orderBy('time', 'desc')
        .limit(30)
        .get()
        .then(snapshot=>{
          thumbList.innerHTML = '';
          if(snapshot.empty) {
            thumbList.innerHTML = `<div style="color:#bbb;font-size:12px;margin:18px 0;text-align:center;">æš‚æ— çº¿ä¸Šå¯¼å›¾</div>`;
            return;
          }
          snapshot.forEach(doc=>{
            const item = doc.data();
            let div = document.createElement('div');
            div.className = 'thumb-item';
            div.onclick = function(){
              nodes = JSON.parse(JSON.stringify(item.nodes));
              idCounter = Math.max(...nodes.map(n=>n.id))+1;
              selectedId = nodes[0]?.id || null;
              editingNodeId = null;
              hideSidebar();
              render();
            };
            let title = document.createElement('div');
            title.className = 'thumb-title';
            title.textContent = item.title;
            div.appendChild(title);
            let svg = document.createElementNS("http://www.w3.org/2000/svg","svg");
            svg.setAttribute("class","thumb-svg");
            svg.setAttribute("width","130"); svg.setAttribute("height","38");
            renderThumbSvg(svg, item.nodes);
            div.appendChild(svg);
            thumbList.appendChild(div);
          });
        });
    }
    function renderThumbSvg(svg, nodes0){
      let ns = nodes0.map(n=>({...n}));
      let minX = Math.min(...ns.map(n=>n.x)), maxX = Math.max(...ns.map(n=>n.x));
      let minY = Math.min(...ns.map(n=>n.y)), maxY = Math.max(...ns.map(n=>n.y));
      let sx = 110/Math.max(60,maxX-minX+1), sy=22/Math.max(16,maxY-minY+1);
      let tx = (130 - (maxX-minX)*sx)/2 - minX*sx + 6;
      let ty = (38 - (maxY-minY)*sy)/2 - minY*sy + 2;
      svg.innerHTML = '';
      ns.forEach(n=>{
        if(n.parent!==null && n.parent!==undefined){
          let p = ns.find(nn=>nn.id===n.parent);
          if(p){
            let x1 = p.x*sx+tx+23, y1 = p.y*sy+ty+8;
            let x2 = n.x*sx+tx+8, y2 = n.y*sy+ty+8;
            let c = p.id===1?"#f4c24d":"#bfbefc";
            let path = document.createElementNS("http://www.w3.org/2000/svg","path");
            path.setAttribute("d",`M${x1},${y1} Q${(x1+x2)/2},${(y1+y2)/2-7},${x2},${y2}`);
            path.setAttribute("stroke",c); path.setAttribute("stroke-width","1.3"); path.setAttribute("fill","none");
            svg.appendChild(path);
          }
        }
      });
      ns.forEach(n=>{
        let x = n.x*sx+tx+(n.id===1?23:8), y = n.y*sy+ty+8;
        let r = n.id===1?8:5;
        let circ = document.createElementNS("http://www.w3.org/2000/svg","circle");
        circ.setAttribute("cx",x); circ.setAttribute("cy",y); circ.setAttribute("r",r);
        circ.setAttribute("fill",n.id===1?"#ffe08b":"#fff");
        circ.setAttribute("stroke",n.id===1?"#f4c24d":"#bfbefc");
        circ.setAttribute("stroke-width",n.id===1?"1.2":"1");
        svg.appendChild(circ);
      });
    }

    function onNewMap() {
      if(nodes.length>0){
        showDialog("æ˜¯å¦ä¿å­˜å½“å‰ç”»å¸ƒï¼Ÿ", ()=>{saveCloud(); newMap();});
      } else {
        newMap();
      }
    }
    function newMap(){
      nodes = [];
      idCounter = 1;
      selectedId = null;
      editingNodeId = null;
      render();
    }

    mindmap.onclick = ()=>{selectedId=null;render();};
    document.body.addEventListener("keydown",function(e){
      if(e.key==="Escape") hideSidebar();
    });

    // å¯¹è¯æ¡†
    function showDialog(msg, onSave) {
      document.getElementById('dialog-msg').innerText = msg;
      document.getElementById('overlay').style.display = 'flex';
      let saveBtn = document.getElementById('dialog-save-btn');
      saveBtn.onclick = function() {
        hideDialog();
        onSave && onSave();
      };
    }
    function hideDialog() { document.getElementById('overlay').style.display = 'none'; }

    render();
  </script>
</body>
</html>