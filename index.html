<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>æ€ç»´å¯¼å›¾ + æœç´¢å¼•æ“</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-auth-compat.js"></script>
<style>
  /* åŸºç¡€æ ·å¼ */
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }
  body { 
    margin: 0; 
    background: #f5f6fa; 
    font-family: Arial, 'Microsoft YaHei', sans-serif;
    overflow: hidden;
  }

  /* ä¸»ä½“å¸ƒå±€ - å·¦å³ä¸¤æ  */
  .app-container {
    display: flex;
    height: 100vh;
    width: 100vw;
    position: relative;
  }

  /* å·¦ä¾§æœç´¢åŒºåŸŸ */
  .search-section {
    width: 33.33%;
    background: #fff;
    border-right: 1px solid #e1e4fa;
    height: 100%;
    display: flex;
    flex-direction: column;
    box-shadow: 2px 0 10px rgba(199, 187, 250, 0.1);
    transition: width 0.3s ease;
    position: relative;
    z-index: 10;
  }

  /* æœç´¢å¼•æ“æ ‡é¢˜ */
  .search-header {
    display: flex;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid #f0f0f0;
  }
  
  .search-logo {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #8066e1;
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    font-weight: bold;
    margin-right: 15px;
  }
  
  .search-title {
    font-size: 22px;
    font-weight: 600;
    color: #333;
  }

  /* æœç´¢æ¡†å®¹å™¨ */
  .search-container {
    padding: 20px;
    border-bottom: 1px solid #f0f0f0;
  }

  /* æœç´¢æ¡† */
  .search-box {
    position: relative;
    margin-bottom: 20px;
  }
  
  .search-input {
    width: 100%;
    padding: 15px 20px 15px 50px;
    border: 2px solid #8066e1;
    border-radius: 30px;
    font-size: 16px;
    outline: none;
    transition: all 0.3s;
    box-shadow: 0 4px 12px rgba(128, 102, 225, 0.1);
  }
  
  .search-input:focus {
    box-shadow: 0 6px 20px rgba(128, 102, 225, 0.2);
  }
  
  .search-icon {
    position: absolute;
    left: 18px;
    top: 50%;
    transform: translateY(-50%);
    color: #8066e1;
    font-size: 20px;
  }

  /* æœç´¢æŒ‰é’® */
  .search-buttons {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-top: 10px;
  }
  
  .search-btn {
    padding: 10px 25px;
    border: none;
    border-radius: 5px;
    background: #8066e1;
    color: white;
    font-size: 15px;
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .search-btn:hover {
    background: #6c5ce7;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(128, 102, 225, 0.2);
  }
  
  .search-btn.secondary {
    background: #f8f9fa;
    color: #333;
  }
  
  .search-btn.secondary:hover {
    background: #e9ecef;
  }

  /* æœç´¢å¼•æ“é€‰æ‹© */
  .search-engines {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-top: 20px;
  }
  
  .engine-option {
    display: flex;
    flex-direction: column;
    align-items: center;
    cursor: pointer;
    opacity: 0.7;
    transition: all 0.2s;
  }
  
  .engine-option:hover {
    opacity: 1;
    transform: translateY(-3px);
  }
  
  .engine-option.active {
    opacity: 1;
  }
  
  .engine-icon {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    margin-bottom: 8px;
    object-fit: contain;
  }
  
  .engine-name {
    font-size: 13px;
    color: #555;
  }

  /* æœç´¢ç»“æœåŒºåŸŸ */
  .search-results-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .search-results {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
  }

  .search-results-title {
    font-size: 16px;
    color: #333;
    margin-bottom: 15px;
    font-weight: 500;
  }

  .search-result-item {
    margin-bottom: 20px;
    padding: 15px;
    border-radius: 8px;
    background: #f8f9fa;
    transition: all 0.2s;
    cursor: pointer;
  }

  .search-result-item:hover {
    background: #f1f3f5;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
  }

  .result-title {
    color: #1a73e8;
    font-size: 18px;
    margin-bottom: 5px;
    font-weight: 500;
  }

  .result-url {
    color: #0d652d;
    font-size: 14px;
    margin-bottom: 8px;
  }

  .result-description {
    color: #4d5156;
    font-size: 14px;
    line-height: 1.5;
  }

  .search-pagination {
    display: flex;
    justify-content: center;
    padding: 15px;
    gap: 10px;
    border-top: 1px solid #f0f0f0;
  }

  .page-btn {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f8f9fa;
    border: 1px solid #e1e4fa;
    cursor: pointer;
    transition: all 0.2s;
  }

  .page-btn:hover {
    background: #e9ecef;
  }

  .page-btn.active {
    background: #8066e1;
    color: white;
    border-color: #8066e1;
  }

  .page-btn.disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  /* æœç´¢å†å² */
  .search-history {
    padding: 15px 20px;
    border-top: 1px solid #f0f0f0;
  }
  
  .history-title {
    font-size: 14px;
    color: #666;
    margin-bottom: 10px;
  }
  
  .history-list {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
  }
  
  .history-item {
    padding: 6px 12px;
    background: #f1f3f4;
    border-radius: 15px;
    font-size: 13px;
    color: #333;
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .history-item:hover {
    background: #e8eaed;
  }

  /* å³ä¾§æ€ç»´å¯¼å›¾åŒºåŸŸ */
  .mindmap-section {
    flex: 1;
    position: relative;
    overflow: hidden;
    background: #f9f9fc;
    transition: width 0.3s ease;
  }

  /* é¡¶éƒ¨å·¥å…·æ  */
  #toolbar {
    width: 100%;
    height: 60px; 
    background: #8066e1; 
    color: #fff; 
    display: flex; 
    align-items: center;
    box-sizing: border-box; 
    padding: 0 32px; 
    position: relative; 
    z-index: 10;
  }
  #toolbar .logo { 
    font-size: 25px; 
    font-weight: bold; 
    border-radius: 50%; 
    width: 32px; 
    height: 32px; 
    background: #fff; 
    color: #8066e1; 
    display: inline-flex; 
    align-items: center; 
    justify-content: center; 
    margin-right: 14px;
  }
  #toolbar .title { 
    font-size: 21px; 
    font-weight: bold; 
    margin-right: 32px;
  }
  #toolbar .btn { 
    margin-left: 12px; 
    background: #fff; 
    color: #8066e1; 
    border: none; 
    border-radius: 8px; 
    padding: 6px 19px; 
    font-size: 15px; 
    cursor: pointer; 
    font-weight: 500; 
    transition: .2s; 
    display: inline-flex; 
    align-items: center;
  }
  #toolbar .btn:hover { 
    background: #e9e4fc;
  }
  #toolbar .btn.add { 
    background: #f5f6fa; 
    color: #8066e1; 
    border: 1.4px solid #8066e1;
  }
  #toolbar .btn.add:hover { 
    background: #e9e4fc; 
  }
  #toolbar .user-info { 
    margin-left: auto; 
    display: flex; 
    align-items: center; 
    gap: 8px; 
    font-size: 14px;
  }
  #toolbar .avatar { 
    width: 26px; 
    height: 26px; 
    border-radius: 50%; 
    background: #eee; 
    object-fit: cover; 
  }

  /* æ€ç»´å¯¼å›¾å®¹å™¨ */
  #mindmap-container { 
    position: relative; 
    width: 100%; 
    height: calc(100% - 60px); 
    overflow: hidden; 
    background: #f9f9fc; 
  }
  #mindmap { 
    width: 100%; 
    height: 100%; 
    position: absolute; 
    left: 0; 
    top: 0; 
    overflow: hidden; 
  }

  /* é¢œè‰²é€‰æ‹©æ  */
  #color-bar {
    position: absolute;
    top: 76px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 100;
    display: flex;
    gap: 12px;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(199, 187, 250, 0.3);
    padding: 8px 20px 7px 20px;
    align-items: center;
    min-width: 220px;
    transition: box-shadow .18s;
    user-select: none;
  }
  .color-bar-top-btn {
    width: 27px;
    height: 27px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px solid #e1e4fa;
    border-radius: 8px;
    background: #fff;
    color: #faad14;
    cursor: pointer;
    box-shadow: 0 1px 4px rgba(199, 187, 250, 0.07);
    margin-right: 7px;
    font-size: 18px;
    transition: border .18s, box-shadow .18s, color .13s;
  }
  .color-bar-top-btn.pinned {
    color: #8066e1;
    border: 2.7px solid #8066e1;
    background: #f8f7fd;
  }
  .color-option {
    width: 27px; 
    height: 27px;
    border-radius: 8px;
    border: 2px solid #e1e4fa;
    cursor: pointer;
    box-shadow: 0 1px 4px rgba(199, 187, 250, 0.07);
    transition: border .18s, box-shadow .18s;
    display: flex; 
    align-items: center; 
    justify-content: center;
    position: relative;
  }
  .color-option.selected, .color-option:hover {
    border: 2.7px solid #8066e1;
    box-shadow: 0 2px 8px rgba(179, 165, 255, 0.2);
  }
  .color-option .tick {
    position: absolute;
    right: 2px; 
    bottom: 2px;
    width: 13px; 
    height: 13px;
    background: rgba(255,255,255,.8);
    border-radius: 50%;
    display: flex; 
    align-items: center; 
    justify-content: center;
    font-size: 12px;
    color: #8066e1;
    font-weight: bold;
    pointer-events: none;
  }

  /* èŠ‚ç‚¹æ ·å¼ */
  .node {
    position: absolute; 
    min-width: 65px; 
    min-height: 28px; 
    padding: 4px 13px 4px 18px;
    background: #fff; 
    border-radius: 12px; 
    color: #333; 
    font-weight: 400;
    user-select: none; 
    cursor: pointer; 
    box-shadow: 0 2px 9px rgba(199, 187, 250, 0.2);
    font-size: 15px; 
    border: 1.7px solid #bfbefc; 
    transition: .2s;
    z-index: 2; 
    display: flex; 
    align-items: center; 
    flex-direction: row; 
    gap: 0;
    white-space: nowrap;
  }
  .node.root { 
    font-weight: bold;
  }
  .node input {
    font-size: 15px; 
    font-family: inherit; 
    border: none; 
    border-radius: 8px; 
    background: #fffde6; 
    outline: 2px solid #8066e1; 
    color: #333;
    padding: 2px 8px; 
    width: 100px; 
    box-sizing: border-box;
  }
  .node .node-img {
    max-width: 60px; 
    max-height: 60px; 
    border-radius: 4px; 
    margin-left: 6px; 
    vertical-align: middle;
  }
  .node .node-icons {
    position: absolute;
    left: 100%; 
    top: 50%; 
    transform: translateY(-50%);
    display: flex; 
    flex-direction: row; 
    gap: 2px;
    opacity: 0; 
    pointer-events: none; 
    transition: .2s;
    z-index: 10;
  }
  .node:hover .node-icons,
  .node .node-icons:focus-within {
    opacity: 1; 
    pointer-events: all;
  }
  .node .icon-btn {
    background: #fff; 
    border: 1px solid #e2d6fa; 
    color: #8066e1;
    border-radius: 50%; 
    width: 26px; 
    height: 26px;
    display: flex; 
    align-items: center; 
    justify-content: center;
    font-size: 15px; 
    cursor: pointer; 
    margin-left: 3px; 
    box-shadow: 0 1px 4px rgba(199, 187, 250, 0.13); 
    transition: .18s;
    outline: none;
  }
  .node .icon-btn:hover { 
    background: #f5f0fa; 
    border-color: #bfbefc;
  }
  .node .icon-btn:active { 
    background: #e8e0fd;
  }
  .node .icon-btn.edit { 
    color: #388e3c;
  }
  .node .icon-btn.del { 
    color: #b71c1c;
  }
  .node .icon-btn.img { 
    color: #f4b400;
  }
  .node .icon-btn.add { 
    color: #8066e1;
  }
  .line { 
    position: absolute; 
    z-index: 1; 
    pointer-events: none; 
  }
  #img-upload { 
    display: none; 
  }
  .node.selected {
    border: 2.3px solid #8066e1;
    box-shadow: 0 0 0 3px rgba(173, 159, 251, 0.27), 0 2px 9px rgba(199, 187, 250, 0.2);
  }
  .node.selected .select-outline {
    pointer-events: none;
    position: absolute;
    top: -7px; 
    left: -7px; 
    right: -7px; 
    bottom: -7px;
    border: 2.5px solid #8066e1;
    border-radius: 16px;
    box-shadow: 0 0 10px 2px rgba(199, 187, 250, 0.2);
    z-index: 10;
    background: none;
    content: "";
  }
  .node.highlight {
    box-shadow: 0 0 0 4px rgba(255, 224, 139, 0.5), 0 2px 9px rgba(199, 187, 250, 0.2);
    animation: pulse 1.5s infinite;
  }
  @keyframes pulse {
    0% { box-shadow: 0 0 0 4px rgba(255, 224, 139, 0.5), 0 2px 9px rgba(199, 187, 250, 0.2); }
    50% { box-shadow: 0 0 0 6px rgba(255, 224, 139, 0.3), 0 2px 9px rgba(199, 187, 250, 0.2); }
    100% { box-shadow: 0 0 0 4px rgba(255, 224, 139, 0.5), 0 2px 9px rgba(199, 187, 250, 0.2); }
  }

  /* å¿«æ·é”®æ  */
  .shortcutbar {
    position: absolute;
    left: 50%;
    bottom: 18px;
    transform: translateX(-50%);
    background: #fff;
    color: #333;
    font-size: 13px;
    border-radius: 9px;
    box-shadow: 0 1px 10px rgba(199, 187, 250, 0.3);
    padding: 7px 20px;
    opacity: .98;
    display: flex;
    gap: 14px;
    z-index: 101;
    flex-wrap: wrap;
    align-items: center;
  }
  .shortcutbar kbd {
    background: #8066e1;
    color: #fff;
    border-radius: 3px;
    padding: 2px 7px;
    margin-right: 3px;
    font-family: monospace;
    font-size: 13px;
    font-weight: 500;
    box-shadow: 0 1px 2px rgba(189, 177, 246, 0.13);
  }

  /* æµ®åŠ¨æŒ‰é’® */
  .mindmap-fab-wrap {
    position: absolute;
    right: 24px;
    bottom: 30px;
    z-index: 102;
    display: flex;
    flex-direction: column;
    gap: 14px;
    align-items: flex-end;
  }
  .mindmap-fab-btn {
    width: 45px; 
    height: 45px;
    border-radius: 50%;
    background: #fff;
    color: #8066e1;
    border: 2.2px solid #ece6fd;
    box-shadow: 0 2px 10px rgba(199, 187, 250, 0.4);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 23px;
    cursor: pointer;
    transition: all .16s;
    outline: none;
    margin-bottom: 0;
    position: relative;
  }
  .mindmap-fab-btn:hover {
    background: #ede7fb;
    border-color: #8066e1;
    transform: scale(1.07) translateY(-2px);
    box-shadow: 0 5px 20px rgba(179, 165, 255, 0.3);
  }
  .mindmap-fab-btn svg {
    pointer-events: none;
    display: block;
  }
  .mindmap-fab-btn .fab-tooltip {
    display: none;
    position: absolute;
    right: 110%;
    top: 50%;
    transform: translateY(-50%);
    background: #fff;
    color: #8066e1;
    border-radius: 6px;
    font-size: 13px;
    padding: 2px 9px;
    box-shadow: 0 0 8px rgba(199, 187, 250, 0.2);
    white-space: nowrap;
  }
  .mindmap-fab-btn:hover .fab-tooltip {
    display: block;
  }
  #mindmap.dragging {
    cursor: grabbing !important;
  }
  #mindmap {
    cursor: grab;
  }

  /* ä¾§è¾¹æ  */
  #sidebar-mask {
    display: none;
    position: fixed; 
    left: 0; 
    top: 60px; 
    width: 100vw; 
    height: calc(100vh - 60px);
    background: rgba(40, 36, 87, 0.12); 
    z-index: 14;
  }
  #sidebar {
    position: fixed; 
    top: 60px; 
    left: 0;
    width: 250px; 
    height: calc(100vh - 60px);
    background: #fff; 
    box-shadow: 2px 0 16px rgba(183, 174, 250, 0.2); 
    z-index: 15;
    display: none; 
    flex-direction: column; 
    padding: 15px 0 0 0; 
    overflow-y: auto;
    transition: left .18s;
  }
  #sidebar h3 { 
    font-size: 15px; 
    margin: 0 0 7px 21px; 
    color: #8066e1;
  }
  .thumb-list { 
    width: 100%; 
    display: flex; 
    flex-direction: column; 
    gap: 13px; 
    padding: 0 12px 10px 12px;
  }
  .thumb-item {
    background: #f8f8fd; 
    border-radius: 8px; 
    box-shadow: 0 1px 4px rgba(221, 213, 250, 0.2); 
    padding: 10px 8px 7px 8px;
    margin-bottom: 2px; 
    cursor: pointer; 
    border: 1.5px solid transparent; 
    transition: .15s;
    display: flex; 
    flex-direction: column; 
    align-items: center; 
    font-size: 12px;
  }
  .thumb-item.selected, .thumb-item:hover { 
    border-color: #8066e1; 
    background: #f1edfa;
  }
  .thumb-title {
    font-size: 12px; 
    color: #8066e1; 
    margin-bottom: 4px; 
    font-weight: bold;
    text-align: center; 
    width: 100%; 
    word-break: break-all;
  }
  .thumb-svg {
    background: #fff; 
    border-radius: 5px; 
    margin-bottom: 2px; 
    box-shadow: 0 1px 3px rgba(221, 212, 255, 0.13);
    width: 130px; 
    height: 38px; 
    display: block;
  }

  /* å¯¹è¯æ¡† */
  #overlay {
    display: none; 
    position: fixed;
    z-index: 9999;
    left: 0;
    top: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.15);
    align-items: center;
    justify-content: center;
  }
  #dialog {
    background: #fff;
    padding: 28px 34px 20px 34px;
    border-radius: 13px;
    min-width: 230px;
    max-width: 80vw;
    box-shadow: 0 8px 40px rgba(179, 165, 255, 0.27);
    text-align: center;
  }
  #dialog-msg {
    font-size: 17px;
    margin-bottom: 20px;
  }
  .dialog-btn {
    background: #fff;
    color: #8066e1;
    border: 1.5px solid #8066e1;
    border-radius: 8px;
    padding: 6px 19px;
    font-size: 15px;
    cursor: pointer;
    font-weight: 500;
    transition: .2s;
  }
  .dialog-btn:hover {
    background: #f5f0fa;
  }

  /* æ‹–åŠ¨æ‰‹æŸ„å’Œäº¤æ¢æŒ‰é’® */
  .resize-handle {
    position: absolute;
    top: 0;
    bottom: 0;
    left: 33.33%;
    width: 10px;
    background: transparent;
    cursor: col-resize;
    z-index: 20;
    transform: translateX(-50%);
  }

  .resize-handle::after {
    content: "";
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 4px;
    height: 40px;
    background: rgba(128, 102, 225, 0.3);
    border-radius: 2px;
    transition: all 0.2s;
  }

  .resize-handle:hover::after {
    background: rgba(128, 102, 225, 0.6);
    width: 6px;
  }

  .resize-handle.dragging::after {
    background: rgba(128, 102, 225, 0.8);
    width: 6px;
    height: 60px;
  }

  .swap-button {
    position: absolute;
    left: 20px;
    bottom: 20px;
    width: 45px;
    height: 45px;
    border-radius: 50%;
    background: #fff;
    color: #8066e1;
    border: 2px solid #ece6fd;
    box-shadow: 0 2px 10px rgba(199, 187, 250, 0.4);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    cursor: pointer;
    z-index: 200;
    transition: all 0.2s;
  }

  .swap-button:hover {
    background: #ede7fb;
    transform: scale(1.1);
    box-shadow: 0 4px 15px rgba(199, 187, 250, 0.5);
  }

  .swap-button .swap-tooltip {
    position: absolute;
    left: 110%;
    top: 50%;
    transform: translateY(-50%);
    background: #fff;
    color: #8066e1;
    border-radius: 6px;
    font-size: 13px;
    padding: 4px 10px;
    box-shadow: 0 2px 8px rgba(199, 187, 250, 0.2);
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s;
  }

  .swap-button:hover .swap-tooltip {
    opacity: 1;
  }

  /* å“åº”å¼è®¾è®¡ */
  @media (max-width: 1024px) {
    .app-container {
      flex-direction: column;
    }
    .search-section {
      width: 100%;
      height: 40vh;
      min-height: 300px;
      border-right: none;
      border-bottom: 1px solid #e1e4fa;
    }
    .mindmap-section {
      height: 60vh;
    }
    #color-bar {
      left: 50%;
    }
    .shortcutbar {
      left: 50%;
    }
    .resize-handle {
      left: 0;
      right: 0;
      top: 40vh;
      bottom: auto;
      width: 100%;
      height: 10px;
      cursor: row-resize;
    }
    .resize-handle::after {
      width: 40px;
      height: 4px;
    }
    .resize-handle:hover::after {
      height: 6px;
    }
    .resize-handle.dragging::after {
      height: 6px;
      width: 60px;
    }
    .swap-button {
      left: 20px;
      bottom: 20px;
    }
  }

  @media (max-width: 768px) {
    .search-engines {
      gap: 15px;
    }
    .search-buttons {
      flex-direction: column;
      gap: 10px;
    }
    #color-bar {
      width: 90%;
      max-width: 90%;
      padding: 5px 10px;
    }
    .shortcutbar {
      width: 90%;
      max-width: 90%;
      padding: 5px 10px;
      font-size: 11px;
    }
    .shortcutbar kbd {
      padding: 1px 4px;
      font-size: 11px;
    }
    .mindmap-fab-wrap {
      right: 10px;
      bottom: 20px;
    }
    .mindmap-fab-btn {
      width: 40px;
      height: 40px;
    }
  }
</style>
</head>
<body>
<div class="app-container">
  <!-- å·¦ä¾§æœç´¢å¼•æ“åŒºåŸŸ -->
  <section class="search-section" id="search-section">
    <div class="search-header">
      <div class="search-logo">S</div>
      <h1 class="search-title">æœç´¢å¼•æ“</h1>
    </div>
    
    <div class="search-container">
      <div class="search-box">
        <span class="search-icon">ğŸ”</span>
        <input type="text" id="search-input" class="search-input" placeholder="è¾“å…¥å…³é”®è¯æœç´¢..." />
      </div>
      
      <div class="search-buttons">
        <button class="search-btn" id="search-btn">æœç´¢</button>
        <button class="search-btn secondary" id="lucky-btn">æ‰‹æ°”ä¸é”™</button>
      </div>
      
      <div class="search-engines">
        <div class="engine-option active" data-engine="google">
          <img src="https://www.google.com/favicon.ico" alt="Google" class="engine-icon">
          <span class="engine-name">Google</span>
        </div>
        <div class="engine-option" data-engine="baidu">
          <img src="https://www.baidu.com/favicon.ico" alt="ç™¾åº¦" class="engine-icon">
          <span class="engine-name">ç™¾åº¦</span>
        </div>
        <div class="engine-option" data-engine="bing">
          <img src="https://www.bing.com/favicon.ico" alt="Bing" class="engine-icon">
          <span class="engine-name">Bing</span>
        </div>
        <div class="engine-option" data-engine="duckduckgo">
          <img src="https://duckduckgo.com/favicon.ico" alt="DuckDuckGo" class="engine-icon">
          <span class="engine-name">DuckDuckGo</span>
        </div>
      </div>
    </div>
    
    <div class="search-results-container">
      <div class="search-results" id="search-results">
        <h3 class="search-results-title">åœ¨æ­¤å¤„æ˜¾ç¤ºæœç´¢ç»“æœ</h3>
        <p style="color: #666; text-align: center; margin-top: 30px;">è¾“å…¥å…³é”®è¯å¹¶ç‚¹å‡»æœç´¢æŒ‰é’®</p>
      </div>
      
      <div class="search-pagination" id="search-pagination" style="display: none;">
        <button class="page-btn" id="prev-page">â—€</button>
        <button class="page-btn active">1</button>
        <button class="page-btn">2</button>
        <button class="page-btn">3</button>
        <button class="page-btn">4</button>
        <button class="page-btn">5</button>
        <button class="page-btn" id="next-page">â–¶</button>
      </div>
    </div>
    
    <div class="search-history">
      <h3 class="history-title">æœç´¢å†å²</h3>
      <div class="history-list" id="history-list">
        <!-- æœç´¢å†å²å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
      </div>
    </div>
  </section>

  <!-- å³ä¾§æ€ç»´å¯¼å›¾åŒºåŸŸ -->
  <section class="mindmap-section" id="mindmap-section">
    <div id="toolbar">
      <span class="logo">M</span>
      <span class="title">æ€ç»´å¯¼å›¾</span>
      <button class="btn add" id="btn-addroot" onclick="addRoot()">+ æ·»åŠ ä¸­å¿ƒä¸»é¢˜</button>
      <button class="btn" onclick="onNewMap()">âŸ³ æ–°å»º</button>
      <button class="btn" onclick="saveCloud()">â˜ï¸ çº¿ä¸Šä¿å­˜</button>
      <button class="btn" onclick="showSidebar()">ğŸ“ åŠ è½½</button>
      <div class="user-info" id="user-info">
        <button class="btn" id="login-btn" onclick="googleLogin()">Googleç™»å½•</button>
      </div>
    </div>
    
    <div id="color-bar"></div>
    <div id="mindmap-container">
      <div id="mindmap"></div>
    </div>
    
    <!-- æµ®åŠ¨æŒ‰é’® -->
    <div class="mindmap-fab-wrap">
      <button class="mindmap-fab-btn" onclick="zoomIn()" title="æ”¾å¤§">
        <svg width="25" height="25" viewBox="0 0 20 20"><circle cx="10" cy="10" r="9" fill="#fff" stroke="#8066e1" stroke-width="1.4"/><rect x="9" y="5" width="2" height="10" rx="1" fill="#8066e1"/><rect x="5" y="9" width="10" height="2" rx="1" fill="#8066e1"/></svg>
        <span class="fab-tooltip">æ”¾å¤§ (Ctrl + é¼ æ ‡æ»šè½® â†‘)</span>
      </button>
      <button class="mindmap-fab-btn" onclick="zoomOut()" title="ç¼©å°">
        <svg width="25" height="25" viewBox="0 0 20 20"><circle cx="10" cy="10" r="9" fill="#fff" stroke="#8066e1" stroke-width="1.4"/><rect x="5" y="9" width="10" height="2" rx="1" fill="#8066e1"/></svg>
        <span class="fab-tooltip">ç¼©å° (Ctrl + é¼ æ ‡æ»šè½® â†“)</span>
      </button>
      <button class="mindmap-fab-btn" onclick="zoomReset()" title="è¿˜åŸ">
        <svg width="25" height="25" viewBox="0 0 20 20"><circle cx="10" cy="10" r="9" fill="#fff" stroke="#8066e1" stroke-width="1.4"/><path d="M10 5v5l3 3" stroke="#8066e1" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round" fill="none"/><circle cx="10" cy="10" r="2.1" fill="none" stroke="#8066e1" stroke-width="1.1"/></svg>
        <span class="fab-tooltip">è¿˜åŸç¼©æ”¾</span>
      </button>
    </div>
    
    <!-- å¿«æ·é”®æç¤º -->
    <div class="shortcutbar">
      <b>èŠ‚ç‚¹å¿«æ·é”®ï¼š</b>
      <kbd>Enter</kbd> æ·»åŠ å­èŠ‚ç‚¹
      <kbd>Space</kbd> ç¼–è¾‘èŠ‚ç‚¹
      <kbd>Backspace</kbd> åˆ é™¤èŠ‚ç‚¹
      <kbd>Esc</kbd> å…³é—­ä¾§æ /å¯¹è¯æ¡†
      <kbd>åŒå‡»èŠ‚ç‚¹</kbd> ç¼–è¾‘èŠ‚ç‚¹
      <kbd>ç‚¹å‡»èŠ‚ç‚¹</kbd> é€‰ä¸­èŠ‚ç‚¹
    </div>
  </section>

  <!-- æ‹–åŠ¨æ‰‹æŸ„ -->
  <div class="resize-handle" id="resize-handle"></div>
  
  <!-- äº¤æ¢ä½ç½®æŒ‰é’® -->
  <button class="swap-button" id="swap-button">
    â‡„
    <span class="swap-tooltip">äº¤æ¢ä½ç½®</span>
  </button>
</div>

<!-- ä¾§è¾¹æ å’Œé®ç½© -->
<div id="sidebar-mask"></div>
<div id="sidebar">
  <h3>æˆ‘çš„çº¿ä¸Šå¯¼å›¾</h3>
  <div class="thumb-list" id="thumb-list"></div>
</div>

<!-- æ–‡ä»¶ä¸Šä¼  -->
<input id="img-upload" type="file" accept="image/*">

<!-- å¯¹è¯æ¡† -->
<div id="overlay">
  <div id="dialog">
    <div id="dialog-msg">æ˜¯å¦ä¿å­˜å½“å‰ç”»å¸ƒï¼Ÿ</div>
    <button class="dialog-btn" id="dialog-save-btn" style="margin-right:12px;">ä¿å­˜</button>
    <button class="dialog-btn" onclick="hideDialog()">å–æ¶ˆ</button>
  </div>
</div>

<script>
  // ==== Firebase é…ç½® ====
  const firebaseConfig = {
    apiKey: "AIzaSyCcsz9Lg3KmgvD_SXUdy4V5x7aCQtSdI-s",
    authDomain: "webs-d0804.firebaseapp.com",
    databaseURL: "https://webs-d0804-default-rtdb.firebaseio.com",
    projectId: "webs-d0804",
    storageBucket: "webs-d0804.firebasestorage.app",
    messagingSenderId: "195195304680",
    appId: "1:195195304680:web:01c68159689678c7f4275d",
    measurementId: "G-RRQ7RFHV76"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();

  // ==== æœç´¢å¼•æ“åŠŸèƒ½ ====
  const searchInput = document.getElementById('search-input');
  const searchBtn = document.getElementById('search-btn');
  const luckyBtn = document.getElementById('lucky-btn');
  const historyList = document.getElementById('history-list');
  const engineOptions = document.querySelectorAll('.engine-option');
  const searchResults = document.getElementById('search-results');
  const searchPagination = document.getElementById('search-pagination');
  const prevPageBtn = document.getElementById('prev-page');
  const nextPageBtn = document.getElementById('next-page');
  
  // å½“å‰é€‰æ‹©çš„æœç´¢å¼•æ“
  let currentEngine = 'google';
  
  // æœç´¢å†å²
  let searchHistory = JSON.parse(localStorage.getItem('searchHistory') || '[]');
  
  // æœç´¢ç»“æœå’Œåˆ†é¡µ
  let currentSearchResults = [];
  let currentPage = 1;
  let resultsPerPage = 5;
  let totalPages = 1;
  
  // æ¸²æŸ“æœç´¢å†å²
  function renderSearchHistory() {
    historyList.innerHTML = '';
    
    // åªæ˜¾ç¤ºæœ€è¿‘10æ¡å†å²è®°å½•
    const recentHistory = searchHistory.slice(0, 10);
    
    recentHistory.forEach(term => {
      const historyItem = document.createElement('div');
      historyItem.className = 'history-item';
      historyItem.textContent = term;
      historyItem.addEventListener('click', () => {
        searchInput.value = term;
        performSearch();
      });
      historyList.appendChild(historyItem);
    });
    
    // å¦‚æœæ²¡æœ‰å†å²è®°å½•ï¼Œæ˜¾ç¤ºæç¤º
    if (recentHistory.length === 0) {
      historyList.innerHTML = '<div style="color:#999;font-size:13px;">æš‚æ— æœç´¢å†å²</div>';
    }
  }
  
  // æ·»åŠ æœç´¢å†å²
  function addToHistory(term) {
    // å¦‚æœå·²å­˜åœ¨ï¼Œå…ˆç§»é™¤
    searchHistory = searchHistory.filter(item => item !== term);
    
    // æ·»åŠ åˆ°å¼€å¤´
    searchHistory.unshift(term);
    
    // é™åˆ¶å†å²è®°å½•æ•°é‡
    if (searchHistory.length > 20) {
      searchHistory = searchHistory.slice(0, 20);
    }
    
    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
    localStorage.setItem('searchHistory', JSON.stringify(searchHistory));
    
    // é‡æ–°æ¸²æŸ“å†å²è®°å½•
    renderSearchHistory();
  }
  
  // æ‰§è¡Œæœç´¢
  function performSearch() {
    const query = searchInput.value.trim();
    
    if (!query) return;
    
    // æ·»åŠ åˆ°å†å²è®°å½•
    addToHistory(query);
    
    // æ˜¾ç¤ºåŠ è½½ä¸­
    searchResults.innerHTML = '<div style="text-align:center;padding:30px;"><div style="font-size:24px;margin-bottom:10px;">ğŸ”</div><p>æ­£åœ¨æœç´¢...</p></div>';
    
    // æ¨¡æ‹Ÿæœç´¢ç»“æœ
    setTimeout(() => {
      // ç”Ÿæˆæ¨¡æ‹Ÿæœç´¢ç»“æœ
      generateMockResults(query);
      
      // æ˜¾ç¤ºåˆ†é¡µ
      searchPagination.style.display = 'flex';
      
      // æ¸²æŸ“ç¬¬ä¸€é¡µç»“æœ
      currentPage = 1;
      renderSearchResultsPage();
    }, 800);
  }
  
  // ç”Ÿæˆæ¨¡æ‹Ÿæœç´¢ç»“æœ
  function generateMockResults(query) {
    // æ¸…ç©ºå½“å‰ç»“æœ
    currentSearchResults = [];
    
    // æ ¹æ®ä¸åŒæœç´¢å¼•æ“ç”Ÿæˆä¸åŒçš„æ¨¡æ‹Ÿç»“æœ
    const resultCount = 25; // æ€»å…±ç”Ÿæˆ25ä¸ªç»“æœï¼Œåˆ†5é¡µæ˜¾ç¤º
    
    for (let i = 1; i <= resultCount; i++) {
      let result = {
        title: '',
        url: '',
        description: ''
      };
      
      switch (currentEngine) {
        case 'google':
          result.title = `Google æœç´¢ç»“æœ #${i}: ${query}`;
          result.url = `https://example.com/google-result-${i}`;
          result.description = `è¿™æ˜¯å…³äº"${query}"çš„Googleæœç´¢ç»“æœç¤ºä¾‹ã€‚è¿™æ˜¯ç¬¬${i}ä¸ªç»“æœï¼ŒåŒ…å«äº†ç›¸å…³ä¿¡æ¯å’Œæè¿°ã€‚`;
          break;
        case 'baidu':
          result.title = `ç™¾åº¦æœç´¢ç»“æœ #${i}: ${query}`;
          result.url = `https://example.com/baidu-result-${i}`;
          result.description = `è¿™æ˜¯å…³äº"${query}"çš„ç™¾åº¦æœç´¢ç»“æœç¤ºä¾‹ã€‚è¿™æ˜¯ç¬¬${i}ä¸ªç»“æœï¼ŒåŒ…å«äº†ç›¸å…³ä¿¡æ¯å’Œæè¿°ã€‚`;
          break;
        case 'bing':
          result.title = `Bing æœç´¢ç»“æœ #${i}: ${query}`;
          result.url = `https://example.com/bing-result-${i}`;
          result.description = `è¿™æ˜¯å…³äº"${query}"çš„Bingæœç´¢ç»“æœç¤ºä¾‹ã€‚è¿™æ˜¯ç¬¬${i}ä¸ªç»“æœï¼ŒåŒ…å«äº†ç›¸å…³ä¿¡æ¯å’Œæè¿°ã€‚`;
          break;
        case 'duckduckgo':
          result.title = `DuckDuckGo æœç´¢ç»“æœ #${i}: ${query}`;
          result.url = `https://example.com/duckduckgo-result-${i}`;
          result.description = `è¿™æ˜¯å…³äº"${query}"çš„DuckDuckGoæœç´¢ç»“æœç¤ºä¾‹ã€‚è¿™æ˜¯ç¬¬${i}ä¸ªç»“æœï¼ŒåŒ…å«äº†ç›¸å…³ä¿¡æ¯å’Œæè¿°ã€‚`;
          break;
        default:
          result.title = `æœç´¢ç»“æœ #${i}: ${query}`;
          result.url = `https://example.com/result-${i}`;
          result.description = `è¿™æ˜¯å…³äº"${query}"çš„æœç´¢ç»“æœç¤ºä¾‹ã€‚è¿™æ˜¯ç¬¬${i}ä¸ªç»“æœï¼ŒåŒ…å«äº†ç›¸å…³ä¿¡æ¯å’Œæè¿°ã€‚`;
      }
      
      currentSearchResults.push(result);
    }
    
    // è®¡ç®—æ€»é¡µæ•°
    totalPages = Math.ceil(currentSearchResults.length / resultsPerPage);
  }
  
  // æ¸²æŸ“æœç´¢ç»“æœé¡µ
  function renderSearchResultsPage() {
    // è®¡ç®—å½“å‰é¡µçš„ç»“æœ
    const startIndex = (currentPage - 1) * resultsPerPage;
    const endIndex = Math.min(startIndex + resultsPerPage, currentSearchResults.length);
    const pageResults = currentSearchResults.slice(startIndex, endIndex);
    
    // æ¸…ç©ºç»“æœåŒºåŸŸ
    searchResults.innerHTML = '';
    
    // æ·»åŠ æ ‡é¢˜
    const title = document.createElement('h3');
    title.className = 'search-results-title';
    title.textContent = `æœç´¢ç»“æœ (ç¬¬ ${currentPage}/${totalPages} é¡µ)`;
    searchResults.appendChild(title);
    
    // æ·»åŠ ç»“æœé¡¹
    if (pageResults.length === 0) {
      const noResults = document.createElement('p');
      noResults.style.textAlign = 'center';
      noResults.style.padding = '30px';
      noResults.textContent = 'æ²¡æœ‰æ‰¾åˆ°ç›¸å…³ç»“æœ';
      searchResults.appendChild(noResults);
    } else {
      pageResults.forEach(result => {
        const resultItem = document.createElement('div');
        resultItem.className = 'search-result-item';
        
        const resultTitle = document.createElement('div');
        resultTitle.className = 'result-title';
        resultTitle.textContent = result.title;
        
        const resultUrl = document.createElement('div');
        resultUrl.className = 'result-url';
        resultUrl.textContent = result.url;
        
        const resultDescription = document.createElement('div');
        resultDescription.className = 'result-description';
        resultDescription.textContent = result.description;
        
        resultItem.appendChild(resultTitle);
        resultItem.appendChild(resultUrl);
        resultItem.appendChild(resultDescription);
        
        // ç‚¹å‡»ç»“æœé¡¹åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€
        resultItem.addEventListener('click', () => {
          window.open(result.url, '_blank');
        });
        
        searchResults.appendChild(resultItem);
      });
    }
    
    // æ›´æ–°åˆ†é¡µæŒ‰é’®
    updatePaginationButtons();
  }
  
  // æ›´æ–°åˆ†é¡µæŒ‰é’®
  function updatePaginationButtons() {
    // æ¸…ç©ºç°æœ‰çš„é¡µç æŒ‰é’®
    const pageButtons = searchPagination.querySelectorAll('.page-btn:not(#prev-page):not(#next-page)');
    pageButtons.forEach(btn => btn.remove());
    
    // ç¡®å®šè¦æ˜¾ç¤ºçš„é¡µç èŒƒå›´
    let startPage = Math.max(1, currentPage - 2);
    let endPage = Math.min(totalPages, startPage + 4);
    
    // å¦‚æœé¡µç ä¸è¶³5ä¸ªï¼Œè°ƒæ•´èµ·å§‹é¡µ
    if (endPage - startPage < 4) {
      startPage = Math.max(1, endPage - 4);
    }
    
    // æ·»åŠ é¡µç æŒ‰é’®
    for (let i = startPage; i <= endPage; i++) {
      const pageBtn = document.createElement('button');
      pageBtn.className = 'page-btn' + (i === currentPage ? ' active' : '');
      pageBtn.textContent = i;
      
      pageBtn.addEventListener('click', () => {
        if (i !== currentPage) {
          currentPage = i;
          renderSearchResultsPage();
        }
      });
      
      // æ’å…¥åˆ°ä¸‹ä¸€é¡µæŒ‰é’®ä¹‹å‰
      searchPagination.insertBefore(pageBtn, nextPageBtn);
    }
    
    // æ›´æ–°ä¸Šä¸€é¡µ/ä¸‹ä¸€é¡µæŒ‰é’®çŠ¶æ€
    prevPageBtn.classList.toggle('disabled', currentPage === 1);
    nextPageBtn.classList.toggle('disabled', currentPage === totalPages);
  }
  
  // ä¸Šä¸€é¡µ
  prevPageBtn.addEventListener('click', () => {
    if (currentPage > 1) {
      currentPage--;
      renderSearchResultsPage();
      // æ»šåŠ¨åˆ°é¡¶éƒ¨
      searchResults.scrollTop = 0;
    }
  });
  
  // ä¸‹ä¸€é¡µ
  nextPageBtn.addEventListener('click', () => {
    if (currentPage < totalPages) {
      currentPage++;
      renderSearchResultsPage();
      // æ»šåŠ¨åˆ°é¡¶éƒ¨
      searchResults.scrollTop = 0;
    }
  });
  
  // æ‰‹æ°”ä¸é”™åŠŸèƒ½
  function feelingLucky() {
    const query = searchInput.value.trim();
    
    if (!query) return;
    
    // æ·»åŠ åˆ°å†å²è®°å½•
    addToHistory(query);
    
    // æ ¹æ®é€‰æ‹©çš„æœç´¢å¼•æ“æ„å»ºURL
    let luckyUrl;
    
    switch (currentEngine) {
      case 'google':
        luckyUrl = `https://www.google.com/search?q=${encodeURIComponent(query)}&btnI=I`;
        break;
      case 'baidu':
        luckyUrl = `https://www.baidu.com/s?wd=${encodeURIComponent(query)}`;
        break;
      case 'bing':
        luckyUrl = `https://www.bing.com/search?q=${encodeURIComponent(query)}&go=Search`;
        break;
      case 'duckduckgo':
        luckyUrl = `https://duckduckgo.com/?q=\\${encodeURIComponent(query)}`;
        break;
      default:
        luckyUrl = `https://www.google.com/search?q=${encodeURIComponent(query)}&btnI=I`;
    }
    
    // åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€æœç´¢ç»“æœ
    window.open(luckyUrl, '_blank');
  }
  
  // åˆ‡æ¢æœç´¢å¼•æ“
  engineOptions.forEach(option => {
    option.addEventListener('click', () => {
      // ç§»é™¤æ‰€æœ‰activeç±»
      engineOptions.forEach(opt => opt.classList.remove('active'));
      
      // æ·»åŠ activeç±»åˆ°å½“å‰é€‰ä¸­çš„å¼•æ“
      option.classList.add('active');
      
      // æ›´æ–°å½“å‰å¼•æ“
      currentEngine = option.dataset.engine;
      
      // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
      localStorage.setItem('currentEngine', currentEngine);
    });
  });
  
  // ä»æœ¬åœ°å­˜å‚¨åŠ è½½å½“å‰å¼•æ“
  const savedEngine = localStorage.getItem('currentEngine');
  if (savedEngine) {
    currentEngine = savedEngine;
    
    // æ›´æ–°UI
    engineOptions.forEach(option => {
      if (option.dataset.engine === currentEngine) {
        option.classList.add('active');
      } else {
        option.classList.remove('active');
      }
    });
  }
  
  // æœç´¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶
  searchBtn.addEventListener('click', performSearch);
  
  // æ‰‹æ°”ä¸é”™æŒ‰é’®ç‚¹å‡»äº‹ä»¶
  luckyBtn.addEventListener('click', feelingLucky);
  
  // è¾“å…¥æ¡†å›è½¦äº‹ä»¶
  searchInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      performSearch();
    }
  });
  
  // åˆå§‹åŒ–æ¸²æŸ“æœç´¢å†å²
  renderSearchHistory();

  // ==== æ€ç»´å¯¼å›¾åŠŸèƒ½ ====
  let currentUser = null;

  // Google ç™»å½•
  function googleLogin() {
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider)
      .then(result => {
        currentUser = result.user;
        renderUser();
        loadSidebarIfVisible && loadSidebarIfVisible();
      }).catch(e => alert('ç™»å½•å¤±è´¥: ' + e.message));
  }

  function logout() {
    auth.signOut().then(() => {
      currentUser = null;
      renderUser();
      render && render();
    });
  }

  // ç”¨æˆ·ä¿¡æ¯ UI
  function renderUser() {
    const userInfo = document.getElementById('user-info');
    if (auth.currentUser) {
      userInfo.innerHTML =
        `<img class="avatar" src="${auth.currentUser.photoURL || ''}" alt=""/>`
        + `<span>${auth.currentUser.displayName || ''}</span>`
        + `<button class="btn" onclick="logout()">é€€å‡º</button>`;
    } else {
      userInfo.innerHTML = `<button class="btn" id="login-btn" onclick="googleLogin()">Googleç™»å½•</button>`;
    }
  }
  auth.onAuthStateChanged(user => {
    currentUser = user;
    renderUser();
    render && render();
    loadSidebarIfVisible && loadSidebarIfVisible();
  });

  // é¢œè‰²æ–¹æ¡ˆ
  const COLOR_LIST = [
    { bg: "#fff", color: "#333", line: "#bfbefc" },
    { bg: "#ffe08b", color: "#654200", line: "#f4c24d" },
    { bg: "#d2f6e9", color: "#21797a", line: "#25b399" },
    { bg: "#c8e8ff", color: "#004e77", line: "#43a6e2" },
    { bg: "#f7c7c9", color: "#a2383b", line: "#e46d72" },
    { bg: "#f3e0ff", color: "#6c3596", line: "#b78be5" },
    { bg: "#e8eaf6", color: "#23265e", line: "#8b91e2" },
    { bg: "#e8f5e9", color: "#1b5e20", line: "#6fcf97" },
    { bg: "#fffde6", color: "#8c6c13", line: "#ffe08b" }
  ];

  let nodes = [];
  let idCounter = 1;
  let selectedId = null;
  let editingNodeId = null;
  let scale = 1;
  let offsetX = 0, offsetY = 0;
  let draggingCanvas = false, dragStartX = 0, dragStartY = 0, dragOriX = 0, dragOriY = 0;
  let highlightedNodeId = null;

  // =============== ç½®é¡¶åŠŸèƒ½ç›¸å…³ ==================
  // pinnedNodes: { [nodeId]: {x, y, colorIdx} }
  let pinnedNodes = {};

  // æ¨ªå‘æ’å¸ƒå¹¶é¿å…é‡å çš„å¸ƒå±€é€»è¾‘, pinnedèŠ‚ç‚¹å›ºå®š
  function layoutHorizontal() {
    if (!nodes.length) return;
    const gapX = 160, gapY = 80;
    let root = nodes.find(n => n.id === 1);
    if (!root) return;
    root.x = 520; root.y = 220;
    function layoutChildren(parent, depth, baseY) {
      let children = nodes.filter(n => n.parent === parent.id);
      // ç½®é¡¶èŠ‚ç‚¹æ’åœ¨æœ€å‰
      children.sort((a, b) => {
        const aPinned = !!pinnedNodes[a.id];
        const bPinned = !!pinnedNodes[b.id];
        if(aPinned && !bPinned) return -1;
        if(!aPinned && bPinned) return 1;
        return a.id - b.id;
      });
      let startX = parent.x + gapX;
      let y = baseY, maxY = baseY;
      children.forEach((child, idx) => {
        if (pinnedNodes[child.id]) {
          // å›ºå®šä¸åŠ¨
          child.x = pinnedNodes[child.id].x;
          child.y = pinnedNodes[child.id].y;
          child.colorIdx = pinnedNodes[child.id].colorIdx;
        } else {
          child.x = startX;
          child.y = y;
        }
        // é¿å…é‡å ï¼ˆåä»£æ’å¸ƒé€’å½’ï¼‰
        y += gapY;
        maxY = Math.max(maxY, child.y);
        layoutChildren(child, depth + 1, child.y - Math.floor(gapY * (nodes.filter(n => n.parent === child.id).length-1) / 2));
      });
      return maxY;
    }
    layoutChildren(root, 1, root.y - (nodes.filter(n => n.parent === 1).length-1)/2*gapY);
  }

  // é¢œè‰²åŒæ­¥å¸¦ç½®é¡¶ä¿æŠ¤
  function setColorCascade(nodeId, colorIdx) {
    const n = nodes.find(n => n.id === nodeId);
    if (!n) return;
    // è‹¥è¢«ç½®é¡¶ä¿æŠ¤ï¼Œä¸å¯æ›´æ”¹
    if (pinnedNodes[nodeId]) return;
    n.colorIdx = colorIdx;
    nodes.forEach(child => {
      if (child.parent === nodeId) {
        setColorCascade(child.id, colorIdx);
      }
    });
  }

  // =============== é¢œè‰²é€‰æ‹©æ  & ç½®é¡¶æŒ‰é’® ==================
  function renderColorBar() {
    const colorBar = document.getElementById('color-bar');
    colorBar.innerHTML = '';
    let selectedNode = nodes.find(n => n.id === selectedId);
    let selColor = selectedNode && selectedNode.colorIdx !== undefined ? selectedNode.colorIdx : 0;
    
    // å¦‚æœæ²¡æœ‰é€‰ä¸­èŠ‚ç‚¹ï¼Œéšè—é¢œè‰²æ 
    if (!selectedNode) {
      colorBar.style.display = 'none';
      return;
    } else {
      colorBar.style.display = 'flex';
    }
    
    // ç½®é¡¶æŒ‰é’®
    let pinBtn = document.createElement('button');
    pinBtn.className = 'color-bar-top-btn' + (pinnedNodes[selectedId] ? ' pinned' : '');
    pinBtn.innerHTML = pinnedNodes[selectedId]
      ? '<svg width="17" height="17" fill="none" viewBox="0 0 17 17"><path d="M8.5 2.5v10M8.5 2.5l-3 3M8.5 2.5l3 3" stroke="#8066e1" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>'
      : '<svg width="17" height="17" fill="none" viewBox="0 0 17 17"><path d="M8.5 2.5v10M8.5 2.5l-3 3M8.5 2.5l3 3" stroke="#faad14" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>';
    pinBtn.title = pinnedNodes[selectedId] ? 'å·²å›ºå®š' : 'å›ºå®šæ­¤èŠ‚ç‚¹çš„ä½ç½®å’Œé¢œè‰²';
    pinBtn.onclick = function() {
      if(!selectedNode) return;
      if(pinnedNodes[selectedId]) {
        // å–æ¶ˆç½®é¡¶
        delete pinnedNodes[selectedId];
      } else {
        // è®°å½•å½“å‰åæ ‡å’Œé¢œè‰²
        pinnedNodes[selectedId] = {
          x: selectedNode.x,
          y: selectedNode.y,
          colorIdx: selectedNode.colorIdx
        };
      }
      layoutHorizontal();
      render();
      renderColorBar();
    };
    colorBar.appendChild(pinBtn);

    // é¢œè‰²é€‰é¡¹
    COLOR_LIST.forEach((c, i) => {
      let btn = document.createElement('div');
      btn.className = 'color-option' + (selColor === i ? ' selected' : '');
      btn.style.background = c.bg;
      btn.style.color = c.color;
      btn.title = 'åº”ç”¨æ­¤é¢œè‰²';
      if(selColor === i) btn.innerHTML = '<span class="tick">âœ”</span>';
      btn.onclick = function() {
        if(selectedNode) {
          // è‹¥è¢«ç½®é¡¶ä¿æŠ¤ï¼Œä¸å¯åˆ‡æ¢é¢œè‰²
          if(pinnedNodes[selectedId]) return;
          setColorCascade(selectedNode.id, i);
          layoutHorizontal();
          render();
          renderColorBar();
        }
      };
      colorBar.appendChild(btn);
    });
  }

  // ä¸»è¦DOMå…ƒç´ 
  const mindmap = document.getElementById('mindmap');
  const sidebar = document.getElementById('sidebar');
  const thumbList = document.getElementById('thumb-list');
  const btnAddRoot = document.getElementById('btn-addroot');
  const imgUpload = document.getElementById('img-upload');

  // æ¸²æŸ“æ€ç»´å¯¼å›¾
  function render() {
    layoutHorizontal();
    mindmap.innerHTML = '';
    btnAddRoot.style.display = nodes.length ? 'none' : '';
    // è¿çº¿
    nodes.forEach(n=>{
      if(n.parent!==null && n.parent!==undefined){
        let p = nodes.find(nn=>nn.id===n.parent);
        if(p) {
          let lineColor = COLOR_LIST[p.colorIdx !== undefined ? p.colorIdx : (p.id === 1 ? 1 : 0)].line;
          drawLine(p, n, lineColor);
        }
      }
    });
    // èŠ‚ç‚¹
    nodes.forEach(n=>{
      let div = document.createElement('div');
      div.className = 'node' + (selectedId===n.id?' selected':'') + (n.id===1?' root':'') + (highlightedNodeId===n.id?' highlight':'');
      div.style.left = (n.x+offsetX)+'px';
      div.style.top = (n.y+offsetY)+'px';
      div.style.position = "absolute";
      div.style.fontSize = "15px";
      div.style.whiteSpace = "nowrap";
      div.style.flexDirection = "row";
      div.dataset.id = n.id;
      // é¢œè‰²
      let colorIdx = n.colorIdx !== undefined ? n.colorIdx : (n.id===1?1:0);
      let cset = COLOR_LIST[colorIdx] || COLOR_LIST[0];
      div.style.background = cset.bg;
      div.style.color = cset.color;
      if(n.id===1) {
        div.style.background = COLOR_LIST[colorIdx || 1].bg;
        div.style.color = COLOR_LIST[colorIdx || 1].color;
      }
      // é€‰ä¸­
      if(selectedId === n.id) {
        let outline = document.createElement('div');
        outline.className = "select-outline";
        div.appendChild(outline);
        div.style.zIndex = 11;
      }
      // ç¼–è¾‘æ¡†
      if(editingNodeId === n.id) {
        let input = document.createElement('input');
        input.value = n.text;
        input.onblur = function() { finishEdit(n, input.value); };
        input.onkeydown = function(e) {
          if(e.key === "Enter") input.blur();
          else if(e.key === "Escape") { editingNodeId = null; render(); }
        };
        setTimeout(()=>{ input.focus(); input.select(); }, 0);
        div.appendChild(input);
      } else {
        let txtspan = document.createElement('span');
        txtspan.textContent = n.text;
        div.appendChild(txtspan);
      }
      if(n.img){
        let imgEl = document.createElement('img');
        imgEl.src = n.img;
        imgEl.className = 'node-img';
        div.appendChild(imgEl);
      }
      let icons = document.createElement('div');
      icons.className = 'node-icons';
      let btnAdd = document.createElement('button');
      btnAdd.className = 'icon-btn add';
      btnAdd.title = "å¢åŠ èŠ‚ç‚¹";
      btnAdd.innerHTML = '<svg width="16" height="16" fill="currentColor"><circle cx="8" cy="8" r="7" stroke="#8066e1" stroke-width="1.5" fill="none"/><rect x="7" y="3.5" width="2" height="9" rx="1"/><rect x="3.5" y="7" width="9" height="2" rx="1"/></svg>';
      btnAdd.onclick = function(e){
        e.stopPropagation();
        addNode(n.id);
      };
      icons.appendChild(btnAdd);
      if(n.id!==1) {
        let btnDel = document.createElement('button');
        btnDel.className = 'icon-btn del';
        btnDel.title = "åˆ é™¤èŠ‚ç‚¹";
        btnDel.innerHTML = '<svg width="16" height="16" fill="currentColor"><circle cx="8" cy="8" r="7" stroke="#b71c1c" stroke-width="1.5" fill="none"/><line x1="5" y1="5" x2="11" y2="11" stroke="#b71c1c" stroke-width="2"/><line x1="11" y1="5" x2="5" y2="11" stroke="#b71c1c" stroke-width="2"/></svg>';
        btnDel.onclick = function(e){
          e.stopPropagation();
          deleteNode(n.id);
        };
        icons.appendChild(btnDel);
      }
      let btnImg = document.createElement('button');
      btnImg.className = 'icon-btn img';
      btnImg.title = "ä¸Šä¼ å›¾ç‰‡";
      btnImg.innerHTML = '<svg width="16" height="16" fill="currentColor"><circle cx="8" cy="8" r="7" stroke="#f4b400" stroke-width="1.5" fill="none"/><rect x="4" y="10" width="8" height="2" rx="1" fill="#f4b400"/><circle cx="8" cy="7" r="2" fill="#f4b400"/></svg>';
      btnImg.onclick = function(e){
        e.stopPropagation();
        uploadImgForNode(n.id);
      };
      icons.appendChild(btnImg);
      let btnEdit = document.createElement('button');
      btnEdit.className = 'icon-btn edit';
      btnEdit.title = "æ–‡æœ¬ç¼–è¾‘";
      btnEdit.innerHTML = '<svg width="16" height="16" fill="currentColor"><circle cx="8" cy="8" r="7" stroke="#388e3c" stroke-width="1.5" fill="none"/><rect x="5" y="5" width="6" height="6" rx="1.2" stroke="#388e3c" stroke-width="1.2" fill="none"/><rect x="7" y="7" width="2" height="2" rx="0.5" fill="#388e3c"/></svg>';
      btnEdit.onclick = function(e){
        e.stopPropagation();
        editingNodeId = n.id;
        render();
      };
      icons.appendChild(btnEdit);
      div.appendChild(icons);
      div.onclick = function(e){
        e.stopPropagation();
        selectedId = n.id;
        render();
        renderColorBar();
      };
      div.ondblclick = function(e){
        editingNodeId = n.id;
        render();
      };
      div.onmousedown = function(e){
        if(e.target.classList.contains('icon-btn')) return;
        e.stopPropagation();
        let startX = e.clientX, startY = e.clientY;
        let oriX = n.x, oriY = n.y;
        function move(ev){
          n.x = oriX + (ev.clientX - startX)/scale;
          n.y = oriY + (ev.clientY - startY)/scale;
          // è‹¥ä¸ºç½®é¡¶ï¼Œæ›´æ–°pinnedåæ ‡
          if (pinnedNodes[n.id]) {
            pinnedNodes[n.id].x = n.x;
            pinnedNodes[n.id].y = n.y;
          }
          render();
        }
        function up(){
          document.removeEventListener('mousemove', move);
          document.removeEventListener('mouseup', up);
        }
        document.addEventListener('mousemove', move);
        document.addEventListener('mouseup', up);
      };
      mindmap.appendChild(div);
    });
    
    // æ›´æ–°ç¼©æ”¾ï¼Œä½†ä¸å½±å“æŒ‰é’®ä½ç½®
    mindmap.style.transform = `scale(${scale})`;
    
    // æ›´æ–°é¢œè‰²æ 
    renderColorBar();
  }

  function finishEdit(n, val) {
    n.text = val.trim() || "æœªå‘½å";
    editingNodeId = null; render();
  }

  function drawLine(from, to, color="#bfbefc"){
    let x1 = from.x + 65 + offsetX, y1 = from.y + 17 + offsetY;
    let x2 = to.x + 15 + offsetX, y2 = to.y + 17 + offsetY;
    let svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
    svg.classList.add('line');
    svg.style.left = Math.min(x1,x2)-25+"px";
    svg.style.top = Math.min(y1,y2)-25+"px";
    svg.style.width = Math.abs(x2-x1)+50+"px";
    svg.style.height = Math.abs(y2-y1)+50+"px";
    svg.innerHTML = `<path d="M ${x1-Math.min(x1,x2)+25} ${y1-Math.min(y1,y2)+25} Q ${(x1-Math.min(x1,x2)+x2-Math.min(x1,x2))/2+25} ${(y1-Math.min(y1,y2)+y2-Math.min(y1,y2))/2+25-18}, ${x2-Math.min(x1,x2)+25} ${y2-Math.min(y1,y2)+25}"
      stroke="${color}" stroke-width="2.2" fill="none" />`;
    mindmap.appendChild(svg);
  }

  function addRoot() {
    if(nodes.length>0) { alert("åªèƒ½æœ‰ä¸€ä¸ªä¸­å¿ƒä¸»é¢˜"); return; }
    nodes.push({id:1, text:"ä¸­å¿ƒä¸»é¢˜", x:520, y:220, parent:null, img:"", colorIdx:1});
    idCounter=2; selectedId=1; editingNodeId=1;
    layoutHorizontal();
    render();
  }

  function addNode(parentId){
    let p = nodes.find(n=>n.id===parentId);
    let children = nodes.filter(n=>n.parent===parentId);
    let newId = idCounter++;
    nodes.push({
      id:newId,
      text:"æ–°èŠ‚ç‚¹",
      x:p.x + 180,
      y:p.y + children.length * 80,
      parent:parentId,
      img:"",
      colorIdx:p.colorIdx !== undefined ? p.colorIdx : (p.id===1?1:0)
    });
    selectedId=newId; editingNodeId=newId;
    layoutHorizontal();
    render();
  }

  function deleteNode(nodeId) {
    delRec(nodeId);
    delete pinnedNodes[nodeId];
    selectedId = nodes[0]?.id || null;
    layoutHorizontal();
    render();
  }
  function delRec(id){
    nodes.filter(n=>n.parent===id).forEach(n=>delRec(n.id));
    nodes = nodes.filter(n=>n.id!==id);
    delete pinnedNodes[id];
  }

  function uploadImgForNode(nodeId){
    imgUpload.value = '';
    imgUpload.onchange = function(){
      const file = imgUpload.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = function(){
        let n = nodes.find(n=>n.id===nodeId);
        n.img = reader.result;
        render();
      };
      reader.readAsDataURL(file);
    };
    imgUpload.click();
  }

  function zoomIn(){ scale = Math.min(scale * 1.15, 4); render();}
  function zoomOut(){ scale = Math.max(scale / 1.15, 0.25); render();}
  function zoomReset(){ scale = 1; render(); }

  document.addEventListener("wheel",function(e){
    if(e.target.closest('.mindmap-section') && e.ctrlKey){
      e.preventDefault();
      if(e.deltaY < 0) zoomIn();
      else if(e.deltaY > 0) zoomOut();
    }
  }, {passive:false});

  mindmap.addEventListener('mousedown', function(e){
    if(e.target !== mindmap) return;
    draggingCanvas = true;
    mindmap.classList.add('dragging');
    dragStartX = e.clientX;
    dragStartY = e.clientY;
    dragOriX = offsetX;
    dragOriY = offsetY;
    function move(ev){
      offsetX = dragOriX + (ev.clientX-dragStartX)/scale;
      offsetY = dragOriY + (ev.clientY-dragStartY)/scale;
      render();
    }
    function up(){
      draggingCanvas = false;
      mindmap.classList.remove('dragging');
      document.removeEventListener('mousemove', move);
      document.removeEventListener('mouseup', up);
    }
    document.addEventListener('mousemove', move);
    document.addEventListener('mouseup', up);
  });

  document.addEventListener("keydown",function(e){
    // åªå¤„ç†æ€ç»´å¯¼å›¾åŒºåŸŸçš„é”®ç›˜äº‹ä»¶
    if(!e.target.closest('.mindmap-section')) return;
    
    if(document.activeElement.tagName==="INPUT") return;
    if(e.key==="Enter" && selectedId!==null){
      e.preventDefault();
      addNode(selectedId);
    }
    else if(e.key===" " && selectedId){
      e.preventDefault();
      editingNodeId = selectedId;
      render();
    }
    else if(e.key==="Backspace" && selectedId && selectedId!==1){
      e.preventDefault();
      deleteNode(selectedId);
    }
    else if(e.key==="Escape"){
      hideSidebar();
      hideDialog();
    }
  });

  function saveCloud(){
    if (!auth.currentUser) return alert('è¯·å…ˆç™»å½•å†ä¿å­˜åˆ°äº‘ç«¯');
    if(!nodes.length) return alert("å½“å‰ç”»å¸ƒä¸ºç©ºã€‚");
    let title = nodes.find(n=>n.id===1)?.text || "æ€ç»´å¯¼å›¾";
    const uid = auth.currentUser.uid;
    db.collection('mindmaps')
      .add({
        uid: uid,
        title: title,
        nodes: JSON.parse(JSON.stringify(nodes)),
        time: firebase.firestore.FieldValue.serverTimestamp()
      })
      .then(() => {
        alert("å·²ä¿å­˜åˆ°äº‘ç«¯ï¼");
        loadSidebarIfVisible();
      })
      .catch(e => alert('ä¿å­˜å¤±è´¥: ' + e.message));
  }

  function loadSidebarIfVisible() {
    if(sidebar.style.display==='flex') renderSidebar();
  }

  function showSidebar(){
    renderSidebar();
    document.getElementById('sidebar').style.display="flex";
    document.getElementById('sidebar-mask').style.display="block";
    document.body.style.overflow="hidden";
  }
  function hideSidebar(){
    document.getElementById('sidebar').style.display="none";
    document.getElementById('sidebar-mask').style.display="none";
    document.body.style.overflow="";
  }
  document.getElementById('sidebar-mask').onclick = hideSidebar;
  document.getElementById('sidebar').onclick = function(e){
    if(e.target===this) hideSidebar();
  }
  function renderSidebar(){
    if(!auth.currentUser) {
      thumbList.innerHTML = `<div style="color:#bbb;font-size:12px;margin:18px 0;text-align:center;">è¯·å…ˆç™»å½•</div>`;
      return;
    }
    const uid = auth.currentUser.uid;
    db.collection('mindmaps')
      .where('uid', '==', uid)
      .orderBy('time', 'desc')
      .limit(30)
      .get()
      .then(snapshot=>{
        thumbList.innerHTML = '';
        if(snapshot.empty) {
          thumbList.innerHTML = `<div style="color:#bbb;font-size:12px;margin:18px 0;text-align:center;">æš‚æ— çº¿ä¸Šå¯¼å›¾</div>`;
          return;
        }
        snapshot.forEach(doc=>{
          const item = doc.data();
          let div = document.createElement('div');
          div.className = 'thumb-item';
          div.onclick = function(){
            nodes = JSON.parse(JSON.stringify(item.nodes));
            idCounter = Math.max(...nodes.map(n=>n.id))+1;
            selectedId = nodes[0]?.id || null;
            editingNodeId = null;
            hideSidebar();
            render();
          };
          let title = document.createElement('div');
          title.className = 'thumb-title';
          title.textContent = item.title;
          div.appendChild(title);
          let svg = document.createElementNS("http://www.w3.org/2000/svg","svg");
          svg.setAttribute("class","thumb-svg");
          svg.setAttribute("width","130"); svg.setAttribute("height","38");
          renderThumbSvg(svg, item.nodes);
          div.appendChild(svg);
          thumbList.appendChild(div);
        });
      });
  }
  function renderThumbSvg(svg, nodes0){
    let ns = nodes0.map(n=>({...n}));
    let minX = Math.min(...ns.map(n=>n.x)), maxX = Math.max(...ns.map(n=>n.x));
    let minY = Math.min(...ns.map(n=>n.y)), maxY = Math.max(...ns.map(n=>n.y));
    let sx = 110/Math.max(60,maxX-minX+1), sy=22/Math.max(16,maxY-minY+1);
    let tx = (130 - (maxX-minX)*sx)/2 - minX*sx + 6;
    let ty = (38 - (maxY-minY)*sy)/2 - minY*sy + 2;
    svg.innerHTML = '';
    ns.forEach(n=>{
      if(n.parent!==null && n.parent!==undefined){
        let p = ns.find(nn=>nn.id===n.parent);
        if(p){
          let x1 = p.x*sx+tx+23, y1 = p.y*sy+ty+8;
          let x2 = n.x*sx+tx+8, y2 = n.y*sy+ty+8;
          let c = p.id===1?"#f4c24d":"#bfbefc";
          let path = document.createElementNS("http://www.w3.org/2000/svg","path");
          path.setAttribute("d",`M${x1},${y1} Q${(x1+x2)/2},${(y1+y2)/2-7},${x2},${y2}`);
          path.setAttribute("stroke",c); path.setAttribute("stroke-width","1.3"); path.setAttribute("fill","none");
          svg.appendChild(path);
        }
      }
    });
    ns.forEach(n=>{
      let x = n.x*sx+tx+(n.id===1?23:8), y = n.y*sy+ty+8;
      let r = n.id===1?8:5;
      let circ = document.createElementNS("http://www.w3.org/2000/svg","circle");
      circ.setAttribute("cx",x); circ.setAttribute("cy",y); circ.setAttribute("r",r);
      circ.setAttribute("fill",n.id===1?"#ffe08b":"#fff");
      circ.setAttribute("stroke",n.id===1?"#f4c24d":"#bfbefc");
      circ.setAttribute("stroke-width",n.id===1?"1.2":"1");
      svg.appendChild(circ);
    });
  }
  function onNewMap() {
    if(nodes.length>0){
      showDialog("æ˜¯å¦ä¿å­˜å½“å‰ç”»å¸ƒï¼Ÿ", ()=>{saveCloud(); newMap();});
    } else {
      newMap();
    }
  }
  function newMap(){
    nodes = [];
    idCounter = 1;
    selectedId = null;
    editingNodeId = null;
    render();
  }

  mindmap.onclick = ()=>{selectedId=null;render();};
  document.body.addEventListener("keydown",function(e){
    if(e.key==="Escape") hideSidebar();
  });

  // å¯¹è¯æ¡†
  function showDialog(msg, onSave) {
    document.getElementById('dialog-msg').innerText = msg || 'æ˜¯å¦ä¿å­˜å½“å‰ç”»å¸ƒï¼Ÿ';
    document.getElementById('overlay').style.display = 'flex';
    let saveBtn = document.getElementById('dialog-save-btn');
    // è§£ç»‘æ—§çš„
    saveBtn.onclick = null;
    // ç»‘å®šæ–°çš„
    saveBtn.onclick = function() {
      hideDialog();
      if(typeof onSave === 'function') onSave();
    };
  }
  function hideDialog() {
    document.getElementById('overlay').style.display = 'none';
  }

  // ==== æ‹–åŠ¨è°ƒæ•´å¤§å°å’Œäº¤æ¢ä½ç½®åŠŸèƒ½ ====
  const searchSection = document.getElementById('search-section');
  const mindmapSection = document.getElementById('mindmap-section');
  const resizeHandle = document.getElementById('resize-handle');
  const swapButton = document.getElementById('swap-button');
  
  // é»˜è®¤å¸ƒå±€
  let isSwapped = false;
  let searchWidth = 33.33; // ç™¾åˆ†æ¯”
  
  // ä»æœ¬åœ°å­˜å‚¨åŠ è½½å¸ƒå±€è®¾ç½®
  const savedLayout = localStorage.getItem('appLayout');
  if (savedLayout) {
    const layout = JSON.parse(savedLayout);
    isSwapped = layout.isSwapped;
    searchWidth = layout.searchWidth;
    
    // åº”ç”¨ä¿å­˜çš„å¸ƒå±€
    applyLayout();
  }
  
  // æ‹–åŠ¨è°ƒæ•´å¤§å°
  resizeHandle.addEventListener('mousedown', function(e) {
    e.preventDefault();
    resizeHandle.classList.add('dragging');
    
    const startX = e.clientX;
    const startY = e.clientY;
    const startWidth = searchSection.offsetWidth;
    const containerWidth = document.querySelector('.app-container').offsetWidth;
    
    function resize(e) {
      // æ£€æŸ¥æ˜¯å¦æ˜¯æ°´å¹³å¸ƒå±€
      const isHorizontal = window.innerWidth > 1024;
      
      if (isHorizontal) {
        // æ°´å¹³å¸ƒå±€ - è°ƒæ•´å®½åº¦
        let newWidth;
        if (isSwapped) {
          newWidth = startWidth - (e.clientX - startX);
        } else {
          newWidth = startWidth + (e.clientX - startX);
        }
        
        // è®¡ç®—ç™¾åˆ†æ¯” (é™åˆ¶åœ¨20%-80%ä¹‹é—´)
        const percentage = Math.min(80, Math.max(20, (newWidth / containerWidth) * 100));
        searchWidth = percentage;
        
        // åº”ç”¨æ–°å®½åº¦
        if (isSwapped) {
          searchSection.style.width = `${100 - percentage}%`;
          mindmapSection.style.width = `${percentage}%`;
          resizeHandle.style.left = `${100 - percentage}%`;
        } else {
          searchSection.style.width = `${percentage}%`;
          mindmapSection.style.width = `${100 - percentage}%`;
          resizeHandle.style.left = `${percentage}%`;
        }
      } else {
        // å‚ç›´å¸ƒå±€ - è°ƒæ•´é«˜åº¦
        const containerHeight = document.querySelector('.app-container').offsetHeight;
        const startHeight = searchSection.offsetHeight;
        let newHeight;
        
        if (isSwapped) {
          newHeight = startHeight - (e.clientY - startY);
        } else {
          newHeight = startHeight + (e.clientY - startY);
        }
        
        // è®¡ç®—ç™¾åˆ†æ¯” (é™åˆ¶åœ¨20%-80%ä¹‹é—´)
        const percentage = Math.min(80, Math.max(20, (newHeight / containerHeight) * 100));
        searchWidth = percentage; // ä»ç„¶ä½¿ç”¨ç›¸åŒçš„å˜é‡å­˜å‚¨
        
        // åº”ç”¨æ–°é«˜åº¦
        if (isSwapped) {
          searchSection.style.height = `${100 - percentage}vh`;
          mindmapSection.style.height = `${percentage}vh`;
          resizeHandle.style.top = `${100 - percentage}vh`;
        } else {
          searchSection.style.height = `${percentage}vh`;
          mindmapSection.style.height = `${100 - percentage}vh`;
          resizeHandle.style.top = `${percentage}vh`;
        }
      }
    }
    
    function stopResize() {
      document.removeEventListener('mousemove', resize);
      document.removeEventListener('mouseup', stopResize);
      resizeHandle.classList.remove('dragging');
      
      // ä¿å­˜å¸ƒå±€è®¾ç½®
      saveLayout();
    }
    
    document.addEventListener('mousemove', resize);
    document.addEventListener('mouseup', stopResize);
  });
  
  // äº¤æ¢ä½ç½®
  swapButton.addEventListener('click', function() {
    isSwapped = !isSwapped;
    applyLayout();
    saveLayout();
  });
  
  // åº”ç”¨å¸ƒå±€
  function applyLayout() {
    const isHorizontal = window.innerWidth > 1024;
    
    if (isHorizontal) {
      // æ°´å¹³å¸ƒå±€
      if (isSwapped) {
        // æ€ç»´å¯¼å›¾åœ¨å·¦ï¼Œæœç´¢åœ¨å³
        searchSection.style.order = '2';
        mindmapSection.style.order = '1';
        searchSection.style.width = `${100 - searchWidth}%`;
        mindmapSection.style.width = `${searchWidth}%`;
        resizeHandle.style.left = `${searchWidth}%`;
      } else {
        // æœç´¢åœ¨å·¦ï¼Œæ€ç»´å¯¼å›¾åœ¨å³
        searchSection.style.order = '1';
        mindmapSection.style.order = '2';
        searchSection.style.width = `${searchWidth}%`;
        mindmapSection.style.width = `${100 - searchWidth}%`;
        resizeHandle.style.left = `${searchWidth}%`;
      }
    } else {
      // å‚ç›´å¸ƒå±€
      if (isSwapped) {
        // æ€ç»´å¯¼å›¾åœ¨ä¸Šï¼Œæœç´¢åœ¨ä¸‹
        searchSection.style.order = '2';
        mindmapSection.style.order = '1';
        searchSection.style.height = `${100 - searchWidth}vh`;
        mindmapSection.style.height = `${searchWidth}vh`;
        resizeHandle.style.top = `${searchWidth}vh`;
      } else {
        // æœç´¢åœ¨ä¸Šï¼Œæ€ç»´å¯¼å›¾åœ¨ä¸‹
        searchSection.style.order = '1';
        mindmapSection.style.order = '2';
        searchSection.style.height = `${searchWidth}vh`;
        mindmapSection.style.height = `${100 - searchWidth}vh`;
        resizeHandle.style.top = `${searchWidth}vh`;
      }
    }
    
    // æ›´æ–°äº¤æ¢æŒ‰é’®ä½ç½®
    updateSwapButtonPosition();
  }
  
  // ä¿å­˜å¸ƒå±€è®¾ç½®
  function saveLayout() {
    const layout = {
      isSwapped: isSwapped,
      searchWidth: searchWidth
    };
    
    localStorage.setItem('appLayout', JSON.stringify(layout));
  }
  
  // æ›´æ–°äº¤æ¢æŒ‰é’®ä½ç½®
  function updateSwapButtonPosition() {
    // å§‹ç»ˆä¿æŒåœ¨å·¦ä¸‹è§’
    swapButton.style.left = '20px';
    swapButton.style.bottom = '20px';
  }
  
  // çª—å£å¤§å°å˜åŒ–æ—¶é‡æ–°åº”ç”¨å¸ƒå±€
  window.addEventListener('resize', function() {
    applyLayout();
    
    // é‡æ–°æ¸²æŸ“æ€ç»´å¯¼å›¾
    if (render) render();
  });

  // åˆå§‹åŒ–
  render();
  renderSearchHistory();
  applyLayout();
</script>
</body>
</html>